<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - Sistema Interno</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .search-container {
            flex-grow: 1;
            max-width: 400px;
        }
        #searchCliente {
            padding-right: 2.5rem; /* Espacio para el ícono */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%236c757d'%3E%3Cpath fill-rule='evenodd' d='M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem 1rem;
        }
        .pagination-controls {
            text-align: center;
            margin-top: 1.5rem;
        }
        #clientes-count {
            color: var(--medium-grey);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header" style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color);">
            <h1>Gestión de Clientes</h1>
            <nav>
                <a href="/app.html">Registrar Envío</a>
                <a href="/historico.html">Histórico</a>
                <a href="/admin.html">Admin</a>
                <a href="/clientes.html" class="active">Clientes</a>
                <a href="/logout">Salir</a>
            </nav>
        </header>

        <div class="content">
            <div class="toolbar">
                <div class="search-container">
                    <input type="text" id="searchCliente" placeholder="Buscar cliente por nombre...">
                </div>
                <button id="btnNuevoCliente" class="btn btn-primary">+ Agregar Cliente</button>
            </div>
            
            <div id="clientes-count"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>RUT</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyClientes"></tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <button id="btnCargarMas" class="btn btn-light" style="display: none;">Cargar más clientes</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar/Crear Cliente -->
    <div class="modal-overlay" id="clienteModal">
        <div class="modal-content">
            <h2 id="modalTitle"></h2>
            <form id="clienteForm" class="modal-form">
                <input type="hidden" id="clienteId">
                <div class="form-grid">
                    <div class="form-full"><label>Nombre Completo</label><input type="text" id="nombre" required></div>
                    <div><label>RUT</label><input type="text" id="rut"></div>
                    <div><label>Email</label><input type="email" id="email"></div>
                    <div><label>Teléfono</label><input type="text" id="telefono"></div>
                    <div class="form-full"><label>Datos Bancarios (opcional)</label><textarea id="datosBancarios" rows="3"></textarea></div>
                </div>
                <div class="modal-buttons" style="margin-top: 1.5rem;">
                    <button type="button" id="btnCancelar" class="btn btn-light">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('tbodyClientes');
            const modal = document.getElementById('clienteModal');
            const form = document.getElementById('clienteForm');
            const modalTitle = document.getElementById('modalTitle');
            const clienteIdInput = document.getElementById('clienteId');
            const searchInput = document.getElementById('searchCliente');
            const loadMoreBtn = document.getElementById('btnCargarMas');
            const clientesCountEl = document.getElementById('clientes-count');

            let currentPage = 1;
            let totalClientes = 0;
            let currentSearch = '';
            let isLoading = false;
            const CLIENTES_POR_PAGINA = 100;
            let debounceTimer;

            function openModal() { modal.style.display = 'flex'; }
            function closeModal() { modal.style.display = 'none'; form.reset(); clienteIdInput.value = ''; }

            document.getElementById('btnNuevoCliente').addEventListener('click', () => {
                modalTitle.textContent = 'Agregar Nuevo Cliente';
                openModal();
            });

            document.getElementById('btnCancelar').addEventListener('click', closeModal);

            async function cargarClientes(page = 1, search = '', append = false) {
                if (isLoading) return;
                isLoading = true;
                if (!append) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando...</td></tr>';
                }
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Cargando...';

                try {
                    const url = `/api/clientes?page=${page}&limit=${CLIENTES_POR_PAGINA}&search=${encodeURIComponent(search)}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('No se pudo cargar la lista de clientes.');
                    
                    const data = await response.json();
                    
                    if (!append) {
                        tbody.innerHTML = '';
                    }

                    data.clientes.forEach(cliente => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${cliente.nombre}</td>
                            <td>${cliente.rut || ''}</td>
                            <td>${cliente.email || ''}</td>
                            <td>${cliente.telefono || ''}</td>
                            <td>
                                <button class="btn-edit" data-id="${cliente.id}">Editar</button>
                                <button class="btn-danger" data-id="${cliente.id}">Eliminar</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    totalClientes = data.total;
                    const clientesMostrados = tbody.children.length;

                    clientesCountEl.textContent = `Mostrando ${clientesMostrados} de ${totalClientes} clientes`;

                    if (clientesMostrados < totalClientes) {
                        loadMoreBtn.style.display = 'block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                    
                    if (data.clientes.length === 0 && !append) {
                         tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No se encontraron clientes.</td></tr>';
                    }

                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${error.message}</td></tr>`;
                } finally {
                    isLoading = false;
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Cargar más clientes';
                }
            }

            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    currentPage = 1;
                    currentSearch = searchInput.value;
                    cargarClientes(currentPage, currentSearch, false);
                }, 300); // Espera 300ms después de que el usuario deja de escribir
            });

            loadMoreBtn.addEventListener('click', () => {
                currentPage++;
                cargarClientes(currentPage, currentSearch, true);
            });

            tbody.addEventListener('click', async (e) => {
                const clienteId = e.target.dataset.id;
                if (!clienteId) return;

                if (e.target.classList.contains('btn-edit')) {
                    try {
                        const res = await fetch(`/api/clientes/${clienteId}`);
                        if (!res.ok) throw new Error('Cliente no encontrado.');
                        const cliente = await res.json();
                        modalTitle.textContent = 'Editar Cliente';
                        clienteIdInput.value = cliente.id;
                        document.getElementById('nombre').value = cliente.nombre;
                        document.getElementById('rut').value = cliente.rut || '';
                        document.getElementById('email').value = cliente.email || '';
                        document.getElementById('telefono').value = cliente.telefono || '';
                        document.getElementById('datosBancarios').value = cliente.datos_bancarios || '';
                        openModal();
                    } catch (error) {
                        alert(error.message);
                    }
                }

                if (e.target.classList.contains('btn-delete')) {
                    if (confirm('¿Estás seguro de que quieres eliminar este cliente? Esta acción no se puede deshacer y podría afectar registros históricos.')) {
                        try {
                            const response = await fetch(`/api/clientes/${clienteId}`, { method: 'DELETE' });
                            if (!response.ok) {
                                const result = await response.json();
                                throw new Error(result.message);
                            }
                            // Recargar desde el principio
                            currentPage = 1;
                            cargarClientes(currentPage, currentSearch, false);
                        } catch (error) {
                            alert(`Error: ${error.message}`);
                        }
                    }
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = clienteIdInput.value;
                const body = {
                    nombre: document.getElementById('nombre').value,
                    rut: document.getElementById('rut').value,
                    email: document.getElementById('email').value,
                    telefono: document.getElementById('telefono').value,
                    datos_bancarios: document.getElementById('datosBancarios').value
                };

                const url = id ? `/api/clientes/${id}` : '/api/clientes';
                const method = id ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if(!response.ok) {
                        const result = await response.json();
                        throw new Error(result.message);
                    }
                    closeModal();
                    // Recargar desde el principio para ver el nuevo cliente
                    currentPage = 1;
                    cargarClientes(currentPage, currentSearch, false);
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });

            // Carga inicial
            cargarClientes(currentPage, currentSearch, false);
        });
    </script>
</body>
</html>
