<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Clientes - Sistema Interno</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .page-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
            font-size: 2rem;
            font-weight: 800;
        }
        
        .page-header p {
            margin: 0;
            color: var(--medium-grey);
            font-size: 1rem;
        }
        
        .breadcrumb {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.9rem;
            color: var(--medium-grey);
            margin-bottom: 1rem;
        }
        
        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .breadcrumb a:hover {
            color: var(--secondary-color);
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            font-size: 0.85rem;
            color: var(--medium-grey);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
        }
        
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .search-container {
            flex-grow: 1;
            max-width: 400px;
            position: relative;
        }
        
        #searchCliente {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }
        
        #searchCliente:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-container::before {
            content: 'üîç';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        thead th {
            padding: 1rem;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        tbody tr {
            transition: all 0.2s;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }
        
        tbody td {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            color: var(--dark);
        }
        
        tbody td:first-child {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .btn-edit, .btn-danger {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
            margin-right: 0.5rem;
        }
        
        .btn-edit:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .pagination-controls {
            text-align: center;
            margin-top: 2rem;
        }
        
        #btnCargarMas {
            padding: 0.75rem 2rem;
            background: white;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #btnCargarMas:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        #clientes-count {
            color: var(--medium-grey);
            margin-bottom: 1rem;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            display: inline-block;
        }
        
        .modal-overlay {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--medium-grey);
        }
        
        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="breadcrumb">
            <a href="/app.html">üè† Inicio</a>
            <span>‚Ä∫</span>
            <span>Gesti√≥n de Clientes</span>
        </div>
        
        <div class="page-header" style="display: flex; align-items: center; gap: 1.5rem;">
            <img src="logo.png" alt="Defi Oracle Logo" style="height: 60px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">
            <div style="flex: 1;">
                <h1>üë• Gesti√≥n de Clientes</h1>
                <p>Defi Oracle - Administra tu base de clientes, detecta duplicados y mant√©n tu informaci√≥n organizada</p>
            </div>
        </div>

        <div class="content-card">
            <div class="toolbar">
                <div class="search-container">
                    <input type="text" id="searchCliente" placeholder="Buscar cliente por nombre...">
                </div>
                <div class="action-buttons">
                    <button id="btnFusionManual" class="btn btn-secondary">üîó Fusi√≥n Manual</button>
                    <button id="btnDetectarDuplicados" class="btn btn-warning">üîç Detectar Duplicados</button>
                    <button id="btnNuevoCliente" class="btn btn-primary">+ Agregar Cliente</button>
                </div>
            </div>
            
            <div id="clientes-count"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre Completo</th>
                            <th>RUT</th>
                            <th>Email</th>
                            <th>Tel√©fono</th>
                            <th style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyClientes"></tbody>
                </table>
            </div>

            <div class="pagination-controls">
                <button id="btnCargarMas" class="btn btn-light" style="display: none;">Cargar m√°s clientes</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar/Crear Cliente -->
    <div class="modal-overlay" id="clienteModal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="modalTitle" style="margin-bottom: 1.5rem; color: var(--primary-color);"></h2>
            <form id="clienteForm" class="modal-form">
                <input type="hidden" id="clienteId">
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark);">Nombre Completo *</label>
                        <input type="text" id="nombre" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark);">RUT</label>
                            <input type="text" id="rut" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark);">Tel√©fono</label>
                            <input type="text" id="telefono" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark);">Email</label>
                        <input type="email" id="email" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--dark);">Datos Bancarios (opcional)</label>
                        <textarea id="datosBancarios" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="modal-buttons" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" id="btnCancelar" class="btn btn-light" style="background: #e5e7eb; color: var(--dark);">Cancelar</button>
                    <button type="submit" class="btn btn-primary">üíæ Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Fusionar Duplicados -->
    <div class="modal-overlay" id="duplicadosModal">
        <div class="modal-content" style="max-width: 900px;">
            <h2 style="color: var(--primary-color); margin-bottom: 1rem;">üîç Clientes Duplicados Detectados</h2>
            <p style="color: var(--medium-grey); margin-bottom: 1.5rem;">
                El sistema ha encontrado grupos de clientes que podr√≠an ser duplicados. Revisa cada grupo y selecciona cu√°l deseas mantener.
            </p>
            <div id="duplicadosContent" style="max-height: 500px; overflow-y: auto; margin: 1.5rem 0;">
                <!-- Se llenar√° din√°micamente -->
            </div>
            <div class="modal-buttons" style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" id="btnCerrarDuplicados" class="btn btn-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Fusi√≥n Manual -->
    <div class="modal-overlay" id="fusionManualModal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 style="color: var(--primary-color); margin-bottom: 1rem;">üîó Fusi√≥n Manual de Clientes</h2>
            <div style="background: #eff6ff; border-left: 4px solid var(--primary-color); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <strong style="color: var(--primary-color);">üìå Instrucciones:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--dark);">
                    <li><strong>1¬∫ Click:</strong> Selecciona el cliente que deseas <strong>MANTENER</strong> (se marca en azul)</li>
                    <li><strong>2¬∫ Click:</strong> Selecciona el cliente que se <strong>FUSIONAR√Å</strong> (se marca en rojo)</li>
                    <li>Todas las operaciones del 2¬∫ cliente se transferir√°n al 1¬∫</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <input type="text" id="searchFusion" placeholder="üîç Buscar cliente..." style="width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
            </div>
            
            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <div style="font-size: 0.85rem; color: var(--medium-grey); margin-bottom: 0.5rem; font-weight: 600;">1Ô∏è‚É£ CLIENTE QUE SE MANTENDR√Å</div>
                    <div id="cliente1Seleccionado" style="color: var(--medium-grey); font-weight: 700; font-size: 1.1rem;">Ninguno</div>
                </div>
                <div>
                    <div style="font-size: 0.85rem; color: var(--medium-grey); margin-bottom: 0.5rem; font-weight: 600;">2Ô∏è‚É£ CLIENTE QUE SE FUSIONAR√Å</div>
                    <div id="cliente2Seleccionado" style="color: var(--medium-grey); font-weight: 700; font-size: 1.1rem;">Ninguno</div>
                </div>
            </div>
            
            <div id="listaClientesFusion" style="max-height: 350px; overflow-y: auto; border: 2px solid var(--border-color); border-radius: 8px; background: white;">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <div class="modal-buttons" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" id="btnCancelarFusion" class="btn btn-light" style="background: #e5e7eb; color: var(--dark);">Cancelar</button>
                <button type="button" id="btnEjecutarFusion" class="btn btn-primary" disabled>üîó Fusionar Clientes</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('tbodyClientes');
            const modal = document.getElementById('clienteModal');
            const form = document.getElementById('clienteForm');
            const modalTitle = document.getElementById('modalTitle');
            const clienteIdInput = document.getElementById('clienteId');
            const searchInput = document.getElementById('searchCliente');
            const loadMoreBtn = document.getElementById('btnCargarMas');
            const clientesCountEl = document.getElementById('clientes-count');

            let currentPage = 1;
            let totalClientes = 0;
            let currentSearch = '';
            let isLoading = false;
            const CLIENTES_POR_PAGINA = 100;
            let debounceTimer;

            function openModal() { modal.style.display = 'flex'; }
            function closeModal() { modal.style.display = 'none'; form.reset(); clienteIdInput.value = ''; }

            document.getElementById('btnNuevoCliente').addEventListener('click', () => {
                modalTitle.textContent = 'Agregar Nuevo Cliente';
                openModal();
            });

            document.getElementById('btnCancelar').addEventListener('click', closeModal);

            async function cargarClientes(page = 1, search = '', append = false) {
                if (isLoading) return;
                isLoading = true;
                if (!append) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando...</td></tr>';
                }
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Cargando...';

                try {
                    const url = `/api/clientes?page=${page}&limit=${CLIENTES_POR_PAGINA}&search=${encodeURIComponent(search)}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('No se pudo cargar la lista de clientes.');
                    
                    const data = await response.json();
                    
                    if (!append) {
                        tbody.innerHTML = '';
                    }

                    data.clientes.forEach(cliente => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${cliente.nombre}</td>
                            <td>${cliente.rut || ''}</td>
                            <td>${cliente.email || ''}</td>
                            <td>${cliente.telefono || ''}</td>
                            <td>
                                <button class="btn-edit" data-id="${cliente.id}">Editar</button>
                                <button class="btn-danger" data-id="${cliente.id}">Eliminar</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    totalClientes = data.total;
                    const clientesMostrados = tbody.children.length;

                    clientesCountEl.textContent = `Mostrando ${clientesMostrados} de ${totalClientes} clientes`;

                    if (clientesMostrados < totalClientes) {
                        loadMoreBtn.style.display = 'block';
                    } else {
                        loadMoreBtn.style.display = 'none';
                    }
                    
                    if (data.clientes.length === 0 && !append) {
                         tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No se encontraron clientes.</td></tr>';
                    }

                } catch (error) {
                    console.error(error);
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${error.message}</td></tr>`;
                } finally {
                    isLoading = false;
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Cargar m√°s clientes';
                }
            }

            searchInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    currentPage = 1;
                    currentSearch = searchInput.value;
                    cargarClientes(currentPage, currentSearch, false);
                }, 300); // Espera 300ms despu√©s de que el usuario deja de escribir
            });

            loadMoreBtn.addEventListener('click', () => {
                currentPage++;
                cargarClientes(currentPage, currentSearch, true);
            });

            tbody.addEventListener('click', async (e) => {
                const clienteId = e.target.dataset.id;
                if (!clienteId) return;

                if (e.target.classList.contains('btn-edit')) {
                    try {
                        const res = await fetch(`/api/clientes/${clienteId}`);
                        if (!res.ok) throw new Error('Cliente no encontrado.');
                        const cliente = await res.json();
                        modalTitle.textContent = 'Editar Cliente';
                        clienteIdInput.value = cliente.id;
                        document.getElementById('nombre').value = cliente.nombre;
                        document.getElementById('rut').value = cliente.rut || '';
                        document.getElementById('email').value = cliente.email || '';
                        document.getElementById('telefono').value = cliente.telefono || '';
                        document.getElementById('datosBancarios').value = cliente.datos_bancarios || '';
                        openModal();
                    } catch (error) {
                        alert(error.message);
                    }
                }

                if (e.target.classList.contains('btn-delete')) {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar este cliente? Esta acci√≥n no se puede deshacer y podr√≠a afectar registros hist√≥ricos.')) {
                        try {
                            const response = await fetch(`/api/clientes/${clienteId}`, { method: 'DELETE' });
                            if (!response.ok) {
                                const result = await response.json();
                                throw new Error(result.message);
                            }
                            // Recargar desde el principio
                            currentPage = 1;
                            cargarClientes(currentPage, currentSearch, false);
                        } catch (error) {
                            alert(`Error: ${error.message}`);
                        }
                    }
                }
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = clienteIdInput.value;
                const body = {
                    nombre: document.getElementById('nombre').value,
                    rut: document.getElementById('rut').value,
                    email: document.getElementById('email').value,
                    telefono: document.getElementById('telefono').value,
                    datos_bancarios: document.getElementById('datosBancarios').value
                };

                const url = id ? `/api/clientes/${id}` : '/api/clientes';
                const method = id ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if(!response.ok) {
                        const result = await response.json();
                        throw new Error(result.message);
                    }
                    closeModal();
                    // Recargar desde el principio para ver el nuevo cliente
                    currentPage = 1;
                    cargarClientes(currentPage, currentSearch, false);
                    alert(id ? 'Cliente actualizado con √©xito.' : 'Cliente creado con √©xito.');
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });

            // FUNCIONALIDAD DE DETECCI√ìN Y FUSI√ìN DE DUPLICADOS
            const duplicadosModal = document.getElementById('duplicadosModal');
            const duplicadosContent = document.getElementById('duplicadosContent');
            
            document.getElementById('btnDetectarDuplicados').addEventListener('click', async () => {
                duplicadosContent.innerHTML = '<p style="text-align:center">üîç Buscando duplicados...</p>';
                duplicadosModal.style.display = 'flex';
                
                try {
                    const res = await fetch('/api/clientes/duplicados');
                    if (!res.ok) throw new Error('Error al buscar duplicados');
                    
                    const duplicados = await res.json();
                    
                    if (duplicados.length === 0) {
                        duplicadosContent.innerHTML = `
                            <div style="text-align:center; padding:2rem; color:var(--success);">
                                <h3>‚úÖ No se encontraron duplicados</h3>
                                <p>Todos los nombres de clientes son √∫nicos.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    duplicadosContent.innerHTML = `
                        <div style="background:#fff3cd; padding:1rem; border-radius:8px; margin-bottom:1rem;">
                            <strong>‚ö†Ô∏è Se encontraron ${duplicados.length} grupos de clientes duplicados.</strong>
                            <p style="margin:0.5rem 0 0 0; font-size:0.9rem;">Selecciona el cliente principal para cada grupo y fusiona los registros.</p>
                        </div>
                    `;
                    
                    duplicados.forEach((grupo, idx) => {
                        const grupoDiv = document.createElement('div');
                        grupoDiv.style.cssText = 'background:white; border:2px solid #dee2e6; border-radius:8px; padding:1rem; margin-bottom:1rem;';
                        
                        let clientesHTML = grupo.clientes.map(c => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; background:#f8f9fa; border-radius:4px; margin-bottom:0.5rem;">
                                <div>
                                    <strong>${c.nombre}</strong> <span style="color:#6c757d;">(ID: ${c.id})</span>
                                    <br><small style="color:#6c757d;">${c.operaciones} operaciones registradas</small>
                                </div>
                                <input type="radio" name="principal_${idx}" value="${c.id}" style="transform:scale(1.5);">
                            </div>
                        `).join('');
                        
                        grupoDiv.innerHTML = `
                            <h4 style="margin:0 0 1rem 0; color:#495057;">üìã Grupo: "${grupo.nombre_base}"</h4>
                            ${clientesHTML}
                            <button class="btn btn-primary" onclick="fusionarGrupo(${idx}, ${JSON.stringify(grupo.clientes).replace(/"/g, '&quot;')})" style="margin-top:0.5rem;">
                                üîó Fusionar Seleccionados
                            </button>
                        `;
                        
                        duplicadosContent.appendChild(grupoDiv);
                    });
                    
                } catch (error) {
                    console.error(error);
                    duplicadosContent.innerHTML = `<p style="color:red; text-align:center;">Error: ${error.message}</p>`;
                }
            });
            
            document.getElementById('btnCerrarDuplicados').addEventListener('click', () => {
                duplicadosModal.style.display = 'none';
            });
            
            // ========== FUSI√ìN MANUAL DE 2 CLIENTES ==========
            const fusionManualModal = document.getElementById('fusionManualModal');
            const listaClientesFusion = document.getElementById('listaClientesFusion');
            const searchFusion = document.getElementById('searchFusion');
            const btnEjecutarFusion = document.getElementById('btnEjecutarFusion');
            let clientesFusion = [];
            let cliente1Id = null;
            let cliente2Id = null;
            
            document.getElementById('btnFusionManual').addEventListener('click', async () => {
                cliente1Id = null;
                cliente2Id = null;
                document.getElementById('cliente1Seleccionado').textContent = 'Ninguno';
                document.getElementById('cliente2Seleccionado').textContent = 'Ninguno';
                document.getElementById('cliente1Seleccionado').style.color = 'var(--medium-grey)';
                document.getElementById('cliente2Seleccionado').style.color = 'var(--medium-grey)';
                btnEjecutarFusion.disabled = true;
                
                try {
                    const res = await fetch('/api/clientes?limit=1000');
                    const data = await res.json();
                    clientesFusion = data.clientes;
                    renderClientesFusion(clientesFusion);
                    fusionManualModal.style.display = 'flex';
                } catch (error) {
                    alert('Error al cargar clientes: ' + error.message);
                }
            });
            
            document.getElementById('btnCancelarFusion').addEventListener('click', () => {
                fusionManualModal.style.display = 'none';
            });
            
            searchFusion.addEventListener('input', () => {
                const query = searchFusion.value.toLowerCase().trim();
                if (query) {
                    const filtrados = clientesFusion.filter(c => 
                        c.nombre.toLowerCase().includes(query)
                    );
                    renderClientesFusion(filtrados);
                } else {
                    renderClientesFusion(clientesFusion);
                }
            });
            
            function renderClientesFusion(clientes) {
                listaClientesFusion.innerHTML = '';
                
                clientes.forEach(c => {
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 0.75rem; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
                    
                    let badge = '';
                    let bgColor = 'white';
                    if (c.id === cliente1Id) {
                        badge = '<span style="background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">1¬∫ MANTENER</span>';
                        bgColor = '#e3f2fd';
                    } else if (c.id === cliente2Id) {
                        badge = '<span style="background: var(--danger); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">2¬∫ FUSIONAR</span>';
                        bgColor = '#ffebee';
                    }
                    
                    div.style.background = bgColor;
                    
                    div.innerHTML = `
                        <div>
                            <strong>${c.nombre}</strong>
                            <div style="font-size: 0.85rem; color: var(--medium-grey);">
                                ID: ${c.id} | ${c.rut || 'Sin RUT'} | ${c.email || 'Sin email'}
                            </div>
                        </div>
                        ${badge}
                    `;
                    
                    div.onclick = () => seleccionarClienteFusion(c);
                    listaClientesFusion.appendChild(div);
                });
                
                if (clientes.length === 0) {
                    listaClientesFusion.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--medium-grey);">No se encontraron clientes</p>';
                }
            }
            
            function seleccionarClienteFusion(cliente) {
                if (!cliente1Id) {
                    // Seleccionar primer cliente (el que se mantiene)
                    cliente1Id = cliente.id;
                    document.getElementById('cliente1Seleccionado').textContent = cliente.nombre;
                    document.getElementById('cliente1Seleccionado').style.color = 'var(--primary-color)';
                } else if (cliente1Id === cliente.id) {
                    // Deseleccionar primer cliente
                    cliente1Id = null;
                    document.getElementById('cliente1Seleccionado').textContent = 'Ninguno';
                    document.getElementById('cliente1Seleccionado').style.color = 'var(--medium-grey)';
                } else if (!cliente2Id) {
                    // Seleccionar segundo cliente (el que se fusiona)
                    cliente2Id = cliente.id;
                    document.getElementById('cliente2Seleccionado').textContent = cliente.nombre;
                    document.getElementById('cliente2Seleccionado').style.color = 'var(--danger)';
                    btnEjecutarFusion.disabled = false;
                } else if (cliente2Id === cliente.id) {
                    // Deseleccionar segundo cliente
                    cliente2Id = null;
                    document.getElementById('cliente2Seleccionado').textContent = 'Ninguno';
                    document.getElementById('cliente2Seleccionado').style.color = 'var(--medium-grey)';
                    btnEjecutarFusion.disabled = true;
                } else {
                    // Ya hay 2 seleccionados, reemplazar el segundo
                    cliente2Id = cliente.id;
                    document.getElementById('cliente2Seleccionado').textContent = cliente.nombre;
                }
                
                renderClientesFusion(clientesFusion.filter(c => 
                    !searchFusion.value || c.nombre.toLowerCase().includes(searchFusion.value.toLowerCase())
                ));
            }
            
            btnEjecutarFusion.addEventListener('click', async () => {
                if (!cliente1Id || !cliente2Id) {
                    alert('Debes seleccionar 2 clientes');
                    return;
                }
                
                const c1 = clientesFusion.find(c => c.id === cliente1Id);
                const c2 = clientesFusion.find(c => c.id === cliente2Id);
                
                const confirmMsg = `üîó FUSIONAR CLIENTES\n\n` +
                    `Cliente que se MANTENDR√Å:\n` +
                    `‚úÖ "${c1.nombre}" (ID: ${c1.id})\n\n` +
                    `Cliente que se FUSIONAR√Å (y se eliminar√°):\n` +
                    `‚ùå "${c2.nombre}" (ID: ${c2.id})\n\n` +
                    `Todas las operaciones de "${c2.nombre}" se transferir√°n a "${c1.nombre}".\n\n` +
                    `‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.\n¬øContinuar?`;
                
                if (!confirm(confirmMsg)) return;
                
                try {
                    const res = await fetch('/api/clientes/fusionar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cliente_principal_id: cliente1Id,
                            cliente_duplicado_id: cliente2Id
                        })
                    });
                    
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.message);
                    }
                    
                    const resultado = await res.json();
                    alert(`‚úÖ Fusi√≥n completada con √©xito!\n\n` +
                        `Se transfirieron ${resultado.operaciones_transferidas} operaciones.\n` +
                        `Cliente final: "${resultado.cliente_final}"`);
                    
                    fusionManualModal.style.display = 'none';
                    currentPage = 1;
                    cargarClientes(currentPage, currentSearch, false);
                    
                } catch (error) {
                    alert(`‚ùå Error al fusionar: ${error.message}`);
                }
            });
            
            document.getElementById('btnCerrarDuplicados').addEventListener('click', () => {
                duplicadosModal.style.display = 'none';
            });
            
            // Funci√≥n global para fusionar
            window.fusionarGrupo = async function(grupoIdx, clientes) {
                const radioSeleccionado = document.querySelector(`input[name="principal_${grupoIdx}"]:checked`);
                
                if (!radioSeleccionado) {
                    alert('‚ö†Ô∏è Por favor, selecciona el cliente principal (el que quieres mantener)');
                    return;
                }
                
                const clientePrincipalId = parseInt(radioSeleccionado.value);
                const clientePrincipal = clientes.find(c => c.id === clientePrincipalId);
                const duplicados = clientes.filter(c => c.id !== clientePrincipalId);
                
                const totalOps = duplicados.reduce((sum, c) => sum + c.operaciones, 0);
                
                const confirmMsg = `üîó FUSIONAR CLIENTES\n\n` +
                    `Cliente Principal (se mantendr√°):\n` +
                    `"${clientePrincipal.nombre}" (${clientePrincipal.operaciones} ops)\n\n` +
                    `Se fusionar√°n ${duplicados.length} cliente(s) duplicado(s):\n` +
                    duplicados.map(d => `‚Ä¢ "${d.nombre}" (${d.operaciones} ops)`).join('\n') +
                    `\n\nTotal de operaciones a transferir: ${totalOps}\n\n` +
                    `‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.\n¬øContinuar?`;
                
                if (!confirm(confirmMsg)) return;
                
                try {
                    for (const duplicado of duplicados) {
                        const res = await fetch('/api/clientes/fusionar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                cliente_principal_id: clientePrincipalId,
                                cliente_duplicado_id: duplicado.id
                            })
                        });
                        
                        if (!res.ok) {
                            const error = await res.json();
                            throw new Error(error.message);
                        }
                    }
                    
                    alert(`‚úÖ Fusi√≥n completada con √©xito!\n\nSe transfirieron ${totalOps} operaciones al cliente "${clientePrincipal.nombre}"`);
                    duplicadosModal.style.display = 'none';
                    currentPage = 1;
                    cargarClientes(currentPage, currentSearch, false);
                    
                } catch (error) {
                    alert(`‚ùå Error al fusionar: ${error.message}`);
                }
            };

            // Carga inicial
            cargarClientes(currentPage, currentSearch, false);
        });
    </script>
</body>
</html>
