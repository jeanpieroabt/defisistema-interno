<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Histórico de Envíos</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="toast-container" class="toast-container"></div>
  <div class="card">
    <div class="hdr">
      <h1>Histórico de Envíos</h1>
      <div style="display: flex; gap: 10px;">
        <button id="btnExport" class="btn btn-light">Exportar CSV</button>
        <button class="btn btn-primary" onclick="window.close()">Cerrar</button>
      </div>
    </div>
    <div class="content">
      <div class="grid3" style="grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 12px; align-items: end;">
        <div><label>Desde</label><input type="date" id="fDesde"></div>
        <div><label>Hasta</label><input type="date" id="fHasta"></div>
        
        <div class="autocomplete-container">
          <label>Cliente</label>
          <input type="text" id="fCliente" placeholder="Nombre del cliente" autocomplete="off">
          <div class="autocomplete-suggestions" id="clientSuggestionsHistorico"></div>
        </div>
        
        <div class="autocomplete-container">
          <label>Operador</label>
          <input type="text" id="fOperador" placeholder="(solo Master)" autocomplete="off">
          <div class="autocomplete-suggestions" id="operatorSuggestions"></div>
        </div>
      </div>
      <div style="display: flex; gap: 10px; margin-bottom: 8px;">
        <button id="btnFiltrar" class="btn btn-primary">Ver Detalle</button>
        <button id="btnResumen" class="btn btn-primary">Ver Resumen Cliente</button>
        <button id="btnRendimiento" class="btn" style="background-color: #38c172; color: white;">Reporte de Rendimiento</button>
        <button id="btnLimpiar" class="btn btn-light">Limpiar</button>
      </div>
      
      <div id="resumenSection" style="margin-top: 20px; display: none;">
          <h2 id="resumenTitle">Resumen Consolidado</h2>
          <table>
              <thead><tr id="tbodyResumenHeader"></tr></thead>
              <tbody id="tbodyResumen"></tbody>
          </table>
      </div>
      <h2 id="tituloDetalle" style="margin-top: 20px;">Detalle de Envíos</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <h2>Editar Envío</h2>
      <form id="editForm" class="modal-form">
        <div class="form-grid">
          <div><label>Fecha</label><input type="date" id="editFecha" required></div>
          <div><label>Cliente</label><input type="text" id="editCliente" required></div>
          <div><label>Monto CLP</label><input type="number" id="editMontoClp" required></div>
          <div><label>Tasa</label><input type="number" id="editTasa" step="0.0001" required></div>
          <div class="form-full"><label>Observaciones</label><input type="text" id="editObs"></div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-light" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }
    
    let operacionesData = [];
    let userRole = '';

    async function user(){
      const r = await fetch('/api/user-info');
      if(!r.ok){ location.href='/login.html'; return null; }
      const userData = await r.json();
      userRole = userData.role;
      return userData;
    }

    function row(op){
      const tr = document.createElement('tr');
      const fechaFormateada = new Date(op.fecha + 'T00:00:00').toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-'); 
      const fmtCLP = v => Number(v).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const fmtVES = v => Number(v).toLocaleString('es-VE');

      let actions = `<button class="btn btn-edit" onclick="abrirModalEdicion(${op.id})">Editar</button>`;
      if (userRole === 'master') {
          actions += ` <button class="btn btn-danger" onclick="deleteOperacion(${op.id})">Borrar</button>`;
      }
      tr.innerHTML = `<td>${fechaFormateada}</td><td>${op.operador}</td><td>${op.cliente_nombre}</td><td>${fmtCLP(op.monto_clp)}</td><td>${Number(op.tasa).toFixed(4)}</td><td>${fmtVES(op.monto_ves)}</td><td>${op.observaciones || ''}</td><td>${actions}</td>`;
      return tr;
    }
    
    async function cargar(){
      document.getElementById('resumenSection').style.display = 'none';
      document.getElementById('tituloDetalle').style.display = 'block';
      document.querySelector('#tituloDetalle + table').style.display = '';

      const params = new URLSearchParams({ startDate: document.getElementById('fDesde').value || '', endDate: document.getElementById('fHasta').value || '', cliente: document.getElementById('fCliente').value || '', operador: document.getElementById('fOperador').value || '', historico: '1' });
      const r = await fetch('/api/operaciones?' + params.toString());
      operacionesData = await r.json();
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      operacionesData.forEach(d => tb.appendChild(row(d)));
    }
    
    async function cargarResumen(){
        const params = new URLSearchParams({ startDate: document.getElementById('fDesde').value || '', endDate: document.getElementById('fHasta').value || '' });
        document.getElementById('resumenTitle').textContent = 'Resumen Consolidado por Cliente';
        document.getElementById('tbodyResumenHeader').innerHTML = `<th>Cliente</th><th style="text-align:right">CLP Recibido</th><th style="text-align:right">Ganancia Bruta</th><th style="text-align:right">Ganancia Neta</th>`;
        document.getElementById('resumenSection').style.display = 'block';
        document.getElementById('tituloDetalle').style.display = 'none';
        document.querySelector('#tituloDetalle + table').style.display = 'none';
        const tbResumen = document.getElementById('tbodyResumen');
        tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">Cargando...</td></tr>';
        
        const r = await fetch('/api/historico/resumen?' + params.toString());
        const data = await r.json();
        tbResumen.innerHTML = '';
        if (data.length === 0) { tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">No hay datos.</td></tr>'; return; }
        const fmt = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${d.cliente_nombre}</td><td style="text-align:right;">${fmt(d.total_clp_recibido)}</td><td style="text-align:right;">${fmt(d.ganancia_bruta)}</td><td style="text-align:right; font-weight: 700; color: ${d.ganancia_neta > 0 ? 'green' : 'red'};">${fmt(d.ganancia_neta)}</td>`;
            tbResumen.appendChild(tr);
        });
    }

    async function cargarRendimiento(){
        const params = new URLSearchParams({ startDate: document.getElementById('fDesde').value || '', endDate: document.getElementById('fHasta').value || '' });
        document.getElementById('resumenTitle').textContent = 'Reporte de Rendimiento por Operador';
        document.getElementById('tbodyResumenHeader').innerHTML = `<th>Operador</th><th style="text-align:right">Millones Comisionables</th><th style="text-align:right">CLP Enviado</th><th style="text-align:right">Clientes Únicos</th><th style="text-align:right">Bonificación (USD)</th>`;
        document.getElementById('resumenSection').style.display = 'block';
        document.getElementById('tituloDetalle').style.display = 'none';
        document.querySelector('#tituloDetalle + table').style.display = 'none';
        const tbResumen = document.getElementById('tbodyResumen');
        tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando...</td></tr>';
        
        const r = await fetch('/api/rendimiento/operadores?' + params.toString());
        const data = await r.json();
        tbResumen.innerHTML = '';
        if (data.length === 0) { tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">No hay datos.</td></tr>'; return; }
        const fmtCLP = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:0});
        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${d.operador_nombre}</td><td style="text-align:right;">${d.millones_comisionables}</td><td style="text-align:right;">${fmtCLP(d.total_clp_enviado)}</td><td style="text-align:right;">${d.clientes_unicos}</td><td style="text-align:right; font-weight: 700; color: green;">$${d.bonificacion_usd.toFixed(2)} USD</td>`;
            tbResumen.appendChild(tr);
        });
    }
    
    async function deleteOperacion(id) {
        if (!confirm('¿Estás seguro de que quieres borrar esta operación?\nEsta acción es irreversible y afectará los saldos globales.')) return;
        const r = await fetch(`/api/operaciones/${id}`, { method: 'DELETE' });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) { await cargar(); }
    }

    // FUNCIÓN DE AUTOCOMPLETADO DE CLIENTES AÑADIDA
    function addClientAutocomplete(inputEl, suggestionsEl) {
      let lastQuery = '';
      inputEl.addEventListener('input', async () => {
        const q = String(inputEl.value || '').trim();
        if (q.length < 2) { suggestionsEl.style.display = 'none'; return; }
        if (q === lastQuery) return;
        lastQuery = q;
        const res = await fetch(`/api/clientes/search?term=${encodeURIComponent(q)}`);
        const names = await res.json();
        suggestionsEl.innerHTML = '';
        if (names && names.length) {
          names.forEach(name => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = name;
            item.onclick = () => { inputEl.value = name; suggestionsEl.style.display = 'none'; };
            suggestionsEl.appendChild(item);
          });
          suggestionsEl.style.display = 'block';
        }
      });
      document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target)) suggestionsEl.style.display = 'none'; });
    }

    function exportar(){
      const params = new URLSearchParams({ startDate: document.getElementById('fDesde').value || '', endDate: document.getElementById('fHasta').value || '', cliente: document.getElementById('fCliente').value || '', operador: document.getElementById('fOperador').value || '' });
      location.href = '/api/operaciones/export?' + params.toString();
    }

    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    function abrirModalEdicion(id) {
        const op = operacionesData.find(d => d.id === id);
        if (!op) return;
        modal.dataset.id = op.id;
        document.getElementById('editFecha').value = op.fecha;
        document.getElementById('editCliente').value = op.cliente_nombre;
        document.getElementById('editMontoClp').value = op.monto_clp;
        document.getElementById('editTasa').value = op.tasa;
        document.getElementById('editObs').value = op.observaciones || '';
        modal.style.display = 'flex';
    }

    function cerrarModalEdicion() { modal.style.display = 'none'; }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modal.dataset.id;
        const body = { fecha: document.getElementById('editFecha').value, cliente_nombre: document.getElementById('editCliente').value, monto_clp: document.getElementById('editMontoClp').value, tasa: document.getElementById('editTasa').value, observaciones: document.getElementById('editObs').value };
        const r = await fetch(`/api/operaciones/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) { cerrarModalEdicion(); await cargar(); }
    });
    
    document.getElementById('cancelEdit').addEventListener('click', cerrarModalEdicion);

    function addOperatorAutocomplete(inputEl, suggestionsEl) {
        let lastQuery = '';
        inputEl.addEventListener('input', async () => {
            const q = String(inputEl.value || '').trim();
            if (q.length < 1) { suggestionsEl.style.display = 'none'; return; }
            if(q === lastQuery) return;
            lastQuery = q;
            const res = await fetch(`/api/usuarios/search?term=${encodeURIComponent(q)}`);
            const names = await res.json();
            suggestionsEl.innerHTML = '';
            if (names && names.length) {
                names.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = name;
                    item.onclick = () => { inputEl.value = name; suggestionsEl.style.display = 'none'; };
                    suggestionsEl.appendChild(item);
                });
                suggestionsEl.style.display = 'block';
            } else {
                suggestionsEl.style.display = 'none';
            }
        });
        document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target)) suggestionsEl.style.display = 'none'; });
    }

    (async () => {
      const u = await user(); if(!u) return;
      if(u.role !== 'master'){
        document.getElementById('fOperador').disabled = true;
        document.getElementById('fOperador').placeholder = 'No disponible';
        document.getElementById('btnResumen').style.display = 'none';
        document.getElementById('btnRendimiento').style.display = 'none';
      } else {
        addOperatorAutocomplete(document.getElementById('fOperador'), document.getElementById('operatorSuggestions'));
      }

      // LLAMADA A LA FUNCIÓN DE AUTOCOMPLETADO DE CLIENTES AÑADIDA
      addClientAutocomplete(document.getElementById('fCliente'), document.getElementById('clientSuggestionsHistorico'));
      
      document.getElementById('btnFiltrar').onclick = cargar;
      document.getElementById('btnResumen').onclick = cargarResumen;
      document.getElementById('btnRendimiento').onclick = cargarRendimiento;
      document.getElementById('btnLimpiar').onclick = ()=>{ 
          document.getElementById('fDesde').value='';
          document.getElementById('fHasta').value='';
          document.getElementById('fCliente').value='';
          document.getElementById('fOperador').value='';
          cargar(); 
      };
      document.getElementById('btnExport').onclick = exportar;
      await cargar();
    })();
  </script>
</body>
</html>