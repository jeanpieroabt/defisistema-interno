<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Hist√≥rico de Env√≠os - Defi Oracle</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 800px;
      height: 800px;
      background-image: url('logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0.03;
      z-index: 0;
      pointer-events: none;
    }
    
    .card {
      position: relative;
      z-index: 1;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .hdr {
      background: linear-gradient(135deg, #2D8CDB 0%, #2EC7A3 100%);
      color: white;
      padding: 2rem;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .hdr h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .hdr .btns {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .logo-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo-header img {
      height: 60px;
      width: auto;
      filter: brightness(0) invert(1);
      object-fit: contain;
    }
    
    .content {
      padding: 2rem;
    }
    
    .filters {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .filters > div {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filters label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }
    
    .filters input {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s;
      font-size: 1rem;
    }
    
    .filters input:focus {
      border-color: #2D8CDB;
      box-shadow: 0 0 0 3px rgba(45, 140, 219, 0.1);
      outline: none;
    }
    
    .btn, .btn-primary, .btn-light, .btn-info, .btn-edit, .btn-danger {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #2D8CDB 0%, #1E73C7 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(45, 140, 219, 0.4);
    }
    
    .btn-light {
      background: white;
      color: #374151;
      border: 2px solid #e5e7eb;
    }
    
    .btn-light:hover {
      background: #f9fafb;
      border-color: #2D8CDB;
      color: #2D8CDB;
      transform: translateY(-2px);
    }
    
    .btn-info {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
    }
    
    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
    }
    
    .btn-info:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btns {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    .btn-edit:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .table-container {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    table thead {
      background: linear-gradient(135deg, #2D8CDB 0%, #2EC7A3 100%);
      color: white;
    }
    
    table tbody tr:hover {
      background: #e6f7ff;
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(45, 140, 219, 0.1);
    }
    
    #resumenSection {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    #resumenTitle {
      color: #2D8CDB;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    #resumenTitle::before {
      content: 'üìä';
      font-size: 1.5rem;
    }
    
    .resumen-filters {
      background: #eff6ff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .resumen-filters input {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #dbeafe;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .resumen-filters input:focus {
      border-color: #2D8CDB;
      outline: none;
      box-shadow: 0 0 0 3px rgba(45, 140, 219, 0.1);
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .card {
        border-radius: 0;
        margin: 0;
      }
      
      .hdr {
        flex-direction: column;
        padding: 1rem;
        border-radius: 0;
      }
      
      .logo-header {
        flex-direction: column;
        text-align: center;
        width: 100%;
      }
      
      .logo-header img {
        height: 50px;
      }
      
      .logo-header h1 {
        font-size: 1.5rem;
      }
      
      .logo-header p {
        font-size: 0.85rem;
      }
      
      .logo-header button {
        width: 45px !important;
        height: 45px !important;
        font-size: 1.5rem !important;
      }
      
      .hdr .btns {
        width: 100%;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .hdr .btns button {
        width: 100%;
      }
      
      .content {
        padding: 1rem;
      }
      
      .filters {
        grid-template-columns: 1fr;
        padding: 1rem;
      }
      
      .btns {
        flex-direction: column;
      }
      
      .btns button {
        width: 100%;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        font-size: 0.8rem;
      }
      
      table th, table td {
        padding: 0.5rem;
        white-space: nowrap;
      }
      
      .modal-content {
        width: 95%;
        max-width: 95%;
        padding: 1rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr !important;
      }
      
      #resumenSection {
        padding: 1rem;
      }
      
      .resumen-filters {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div id="toast-container" class="toast-container"></div>

  <div class="card">
    <div class="hdr">
      <div class="logo-header">
        <button onclick="location.href='home.html'" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; margin-right: 0.5rem;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateX(-5px)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateX(0)'">‚Üê</button>
        <img src="logo.png" alt="Defi Oracle Logo">
        <div>
          <h1>üì¶ Hist√≥rico de Env√≠os</h1>
          <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">Defi Oracle - Sistema Interno</p>
        </div>
      </div>
      <div class="btns">
        <button class="btn btn-light" onclick="location.href='/clientes.html'">Gesti√≥n Clientes</button>
        <button id="btnRecalcular" class="btn-info" disabled>Recalcular Costos</button>
        <button id="btnExport" class="btn-light">Exportar CSV</button>
        <button class="btn-primary" onclick="location.href='home.html'">Volver al Inicio</button>
      </div>
    </div>
    <div class="content">
      <div class="filters">
        <div><label>Desde</label><input type="date" id="fDesde"></div>
        <div><label>Hasta</label><input type="date" id="fHasta"></div>
        <div class="autocomplete-container">
          <label>Cliente</label>
          <input type="text" id="fCliente" placeholder="Nombre del cliente" autocomplete="off">
          <div class="autocomplete-suggestions" id="fClienteSuggestions"></div>
        </div>
        <div><label>Operador</label><input type="text" id="fOperador" placeholder="(solo Master)"></div>
      </div>
      <div class="btns">
        <button id="btnFiltrar" class="btn-primary">Ver Detalle</button>
        <button id="btnResumen" class="btn-primary">Ver Resumen Cliente</button>
        <button id="btnRendimiento" class="btn-primary" style="background-color: #38c172;">Reporte de Rendimiento</button>
        <button id="btnLimpiar" class="btn-light">Limpiar</button>
      </div>
      
      <div id="resumenSection" style="margin-top: 20px; display: none;">
          <h2 id="resumenTitle">Resumen Consolidado</h2>
          <div class="resumen-filters" id="resumenFiltersContainer" style="display: none;">
            <input type="text" id="filtroNombreResumen" placeholder="üîç Filtrar por nombre de cliente...">
          </div>
          <div class="table-container">
            <table class="table">
                <thead><tr id="tbodyResumenHeader"></tr></thead>
                <tbody id="tbodyResumen"></tbody>
            </table>
          </div>
      </div>
      <h2 id="tituloDetalle" style="margin-top: 20px;">Detalle de Env√≠os</h2>
      <div id="operacionesInfo" style="margin-bottom: 1rem; color: var(--medium-grey); font-weight: 600; display: none;">
        Mostrando <span id="operacionesVisibles">0</span> de <span id="totalOperaciones">0</span> operaciones
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr><th>Fecha</th><th>Recibo</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Costo CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acci√≥n</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div style="text-align: center; margin-top: 1.5rem;">
        <button id="btnCargarMasOperaciones" class="btn-primary" style="display: none; padding: 0.75rem 2rem;">Cargar 50 m√°s</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <h2>Editar Env√≠o</h2>
      <form id="editForm" class="modal-form">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div><label>Fecha</label><input type="date" id="editFecha" required></div>
          <div>
            <label>N√∫mero de Recibo</label>
            <input type="text" id="editRecibo" required autocomplete="off">
            <div id="editReciboStatus" style="font-size: 0.8rem; font-weight: 700; margin-top: 4px; height: 1em;"></div>
          </div>
          <div style="grid-column: 1 / -1;"><label>Cliente</label><input type="text" id="editCliente" required></div>
          <div><label>Monto CLP</label><input type="number" id="editMontoClp" required></div>
          <div><label>Tasa</label><input type="number" id="editTasa" step="0.0001" required></div>
          <div class="form-full"><label>Observaciones</label><input type="text" id="editObs"></div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-light" id="cancelEdit">Cancelar</button>
          <button type="submit" id="btnGuardarCambios" class="btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    let operacionesData = [];
    let operacionesVisibles = 50;
    let user = {};

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }
    
    let debounceTimeout;
    function checkRecibo(inputEl, statusEl, btnEl, excludeId = null) {
        clearTimeout(debounceTimeout);
        statusEl.textContent = 'Verificando...';
        statusEl.style.color = 'var(--muted)';
        btnEl.disabled = true;

        debounceTimeout = setTimeout(async () => {
            const numero = inputEl.value.trim();
            if (!numero) {
                statusEl.textContent = '';
                btnEl.disabled = true;
                return;
            }
            let url = `/api/recibo/check?numero=${encodeURIComponent(numero)}`;
            if (excludeId) url += `&excludeId=${excludeId}`;
            
            const r = await fetch(url);
            const res = await r.json();
            if (res.usado) {
                statusEl.textContent = 'USADO';
                statusEl.style.color = 'var(--danger)';
                btnEl.disabled = true;
            } else {
                statusEl.textContent = 'Libre';
                statusEl.style.color = 'var(--success)';
                btnEl.disabled = false;
            }
        }, 400);
    }

    function addClientAutocomplete(inputEl, suggestionsEl) {
      let lastQuery = '';
      inputEl.addEventListener('input', async () => {
        const q = String(inputEl.value || '').trim();
        if (q.length < 2) { suggestionsEl.style.display = 'none'; return; }
        if (q === lastQuery) return;
        lastQuery = q;
        const res = await fetch(`/api/clientes/search?term=${encodeURIComponent(q)}`);
        const names = await res.json();
        suggestionsEl.innerHTML = '';
        if (names && names.length) {
          names.forEach(name => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = name;
            item.onclick = () => { inputEl.value = name; suggestionsEl.style.display = 'none'; };
            suggestionsEl.appendChild(item);
          });
          suggestionsEl.style.display = 'block';
        } else {
          suggestionsEl.style.display = 'none';
        }
      });
      document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target)) suggestionsEl.style.display = 'none'; });
    }

    async function fetchUser(){
      const r = await fetch('/api/user-info');
      if(!r.ok){ location.href='/login.html'; return null; }
      user = await r.json();
      return user;
    }

    function row(op){
      const tr = document.createElement('tr');
      
      const fecha = new Date(op.fecha + 'T00:00:00'); 
      const fechaFormateada = fecha.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-'); 

      const fmtCLP = v => Number(v).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const fmtVES = v => Number(v).toLocaleString('es-VE');

      let actions = `<button class="btn-edit" onclick="abrirModalEdicion(${op.id})">Editar</button>`;
      if (user.role === 'master') {
        actions += ` <button class="btn-danger" onclick="deleteOperacion(${op.id})">Borrar</button>`;
      }

      tr.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${op.numero_recibo || ''}</td>
        <td>${op.operador}</td>
        <td>${op.cliente_nombre}</td>
        <td>${fmtCLP(op.monto_clp)}</td>
        <td style="color: ${op.costo_clp > 0 ? 'inherit' : 'red'}; font-weight: ${op.costo_clp > 0 ? 'normal' : 'bold'};">${fmtCLP(op.costo_clp)}</td>
        <td>${Number(op.tasa).toFixed(4)}</td>
        <td>${fmtVES(op.monto_ves)}</td>
        <td>${op.observaciones || ''}</td>
        <td>${actions}</td>`;
      return tr;
    }
    
    function renderOperaciones() {
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      const operacionesMostrar = operacionesData.slice(0, operacionesVisibles);
      operacionesMostrar.forEach(d => tb.appendChild(row(d)));
    }
    
    function cargarMasOperaciones() {
      operacionesVisibles += 50;
      renderOperaciones();
      
      document.getElementById('operacionesVisibles').textContent = Math.min(operacionesVisibles, operacionesData.length);
      
      if (operacionesVisibles >= operacionesData.length) {
        document.getElementById('btnCargarMasOperaciones').style.display = 'none';
      }
    }
    
    async function cargar(){
      const resumenSection = document.getElementById('resumenSection');
      const tituloDetalle = document.getElementById('tituloDetalle');
      const tableContainer = document.querySelector('#tituloDetalle + .table-container');
      const btnRecalcular = document.getElementById('btnRecalcular');
      
      if (resumenSection) resumenSection.style.display = 'none';
      if (tituloDetalle) tituloDetalle.style.display = 'block';
      if (tableContainer) tableContainer.style.display = 'block';
      if (btnRecalcular) btnRecalcular.disabled = true;
      
      const params = new URLSearchParams({
        startDate: document.getElementById('fDesde').value || '',
        endDate:   document.getElementById('fHasta').value || '',
        cliente:   document.getElementById('fCliente').value || '',
        operador:  document.getElementById('fOperador').value || '',
        historico: '1'
      });
      const r = await fetch('/api/operaciones?' + params.toString());
      operacionesData = await r.json();
      operacionesVisibles = 50;
      renderOperaciones();
      
      if (operacionesData.length > 0 && user.role === 'master') {
          if (btnRecalcular) btnRecalcular.disabled = false;
      }
      
      // Mostrar/ocultar info y bot√≥n de paginaci√≥n
      const infoDiv = document.getElementById('operacionesInfo');
      const btnCargarMas = document.getElementById('btnCargarMasOperaciones');
      if (operacionesData.length > 0) {
        if (infoDiv) {
          infoDiv.style.display = 'block';
          const visiblesEl = document.getElementById('operacionesVisibles');
          const totalEl = document.getElementById('totalOperaciones');
          if (visiblesEl) visiblesEl.textContent = Math.min(operacionesVisibles, operacionesData.length);
          if (totalEl) totalEl.textContent = operacionesData.length;
        }
        if (btnCargarMas) btnCargarMas.style.display = operacionesData.length > operacionesVisibles ? 'inline-block' : 'none';
      } else {
        if (infoDiv) infoDiv.style.display = 'none';
        if (btnCargarMas) btnCargarMas.style.display = 'none';
      }
    }
    
    async function recalcularCostos() {
        if (operacionesData.length === 0) {
            showToast('No hay operaciones cargadas para recalcular.', 'error');
            return;
        }
        if (!confirm(`¬øDesea recalcular el costo para las ${operacionesData.length} operaciones mostradas? Esta acci√≥n actualizar√° los costos y la ganancia acumulada.`)) {
            return;
        }

        const btn = document.getElementById('btnRecalcular');
        btn.disabled = true;
        btn.textContent = 'Recalculando...';

        try {
            const ids = operacionesData.map(op => op.id);
            const r = await fetch('/api/operaciones/recalculate-costs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            });
            const res = await r.json();
            showToast(res.message, r.ok ? 'success' : 'error');
            if (r.ok) {
                await cargar(); // Recargar la tabla para ver los cambios
            }
        } catch (e) {
            showToast('Error de red al recalcular.', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Recalcular Costos';
        }
    }

    let resumenDataGlobal = [];
    
    async function cargarResumen(){
        const fDesde = document.getElementById('fDesde');
        const fHasta = document.getElementById('fHasta');
        const tbResumen = document.getElementById('tbodyResumen');
        const resumenSection = document.getElementById('resumenSection');
        const filtrosContainer = document.getElementById('resumenFiltersContainer');
        const resumenTitle = document.getElementById('resumenTitle');
        const tbodyResumenHeader = document.getElementById('tbodyResumenHeader');
        const tituloDetalle = document.getElementById('tituloDetalle');
        const tableContainer = document.querySelector('#tituloDetalle + .table-container');
        
        if (!fDesde || !fHasta || !tbResumen || !resumenSection || !filtrosContainer || !resumenTitle || !tbodyResumenHeader) {
            console.error('Elementos requeridos no encontrados para cargarResumen');
            return;
        }
        
        resumenTitle.textContent = 'Resumen Consolidado por Cliente';
        tbodyResumenHeader.innerHTML = `
            <th>Cliente</th>
            <th style="text-align:right">CLP Recibido Total</th>
            <th style="text-align:right">Costo Total</th>
            <th style="text-align:right">Ganancia Bruta</th>
        `;
        resumenSection.style.display = 'block';
        filtrosContainer.style.display = 'flex';
        if (tituloDetalle) tituloDetalle.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        
        tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">Cargando...</td></tr>';
        
        const params = new URLSearchParams({ startDate: fDesde.value || '', endDate: fHasta.value || '' });
        const r = await fetch('/api/historico/resumen?' + params.toString());
        const data = await r.json();
        
        resumenDataGlobal = data;
        renderResumen(data);
    }
    
    function renderResumen(data) {
        const tbResumen = document.getElementById('tbodyResumen');
        tbResumen.innerHTML = '';
        const fmt = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:2,maximumFractionDigits:2});

        if (data.length === 0) {
            tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">No hay datos.</td></tr>';
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.cliente_nombre}</td>
                <td style="text-align:right; font-weight: 700;">${fmt(d.total_clp_recibido)}</td>
                <td style="text-align:right; color: var(--muted);">${fmt(d.total_costo_clp)}</td>
                <td style="text-align:right; font-weight: 700; color: ${d.ganancia_bruta > 0 ? 'green' : 'red'};">${fmt(d.ganancia_bruta)}</td>
            `;
            tbResumen.appendChild(tr);
        });
    }

    async function cargarRendimiento(){
        const fDesde = document.getElementById('fDesde');
        const fHasta = document.getElementById('fHasta');
        const tbResumen = document.getElementById('tbodyResumen');
        const filtrosContainer = document.getElementById('resumenFiltersContainer');
        const resumenTitle = document.getElementById('resumenTitle');
        const tbodyResumenHeader = document.getElementById('tbodyResumenHeader');
        const resumenSection = document.getElementById('resumenSection');
        const tituloDetalle = document.getElementById('tituloDetalle');
        const tableContainer = document.querySelector('#tituloDetalle + .table-container');
        
        if (!fDesde || !fHasta || !tbResumen || !filtrosContainer || !resumenTitle || !tbodyResumenHeader || !resumenSection) {
            console.error('Elementos requeridos no encontrados para cargarRendimiento');
            return;
        }
        
        resumenTitle.textContent = 'Reporte de Rendimiento por Operador';
        tbodyResumenHeader.innerHTML = `
            <th>Operador</th>
            <th style="text-align:right">Millones Comisionables</th>
            <th style="text-align:right">CLP Enviado Total</th>
            <th style="text-align:right">Clientes √önicos</th>
            <th style="text-align:right">Bonificaci√≥n Total (USD)</th>
        `;

        resumenSection.style.display = 'block';
        filtrosContainer.style.display = 'none';
        if (tituloDetalle) tituloDetalle.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        
        tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando...</td></tr>';
        
        const params = new URLSearchParams({ startDate: fDesde.value || '', endDate: fHasta.value || '' });
        const r = await fetch('/api/rendimiento/operadores?' + params.toString());
        const data = await r.json();

        tbResumen.innerHTML = '';
        const fmtCLP = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:0});
        
        if (data.length === 0) {
            tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">No hay datos.</td></tr>';
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.operador_nombre}</td>
                <td style="text-align:right;">${d.millones_comisionables}</td>
                <td style="text-align:right; font-weight: 700;">${fmtCLP(d.total_clp_enviado)}</td>
                <td style="text-align:right; color: var(--muted);">${d.clientes_unicos}</td>
                <td style="text-align:right; font-weight: 700; color: green;">$${d.bonificacion_usd.toFixed(2)} USD</td>
            `;
            tbResumen.appendChild(tr);
        });
    }
    
    function exportar(){
      const params = new URLSearchParams({
        startDate: document.getElementById('fDesde').value || '',
        endDate:   document.getElementById('fHasta').value || '',
        cliente:   document.getElementById('fCliente').value || '',
        operador:  document.getElementById('fOperador').value || '',
      });
      location.href = '/api/operaciones/export?' + params.toString();
    }

    async function deleteOperacion(id) {
        if (!confirm('¬øEst√°s seguro de que quieres borrar esta operaci√≥n?\nEsta acci√≥n es irreversible y afectar√° los saldos globales.')) return;
        const r = await fetch(`/api/operaciones/${id}`, { method: 'DELETE' });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) {
            await cargar();
        }
    }

    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    function abrirModalEdicion(id) {
        const op = operacionesData.find(d => d.id === id);
        if (!op) return;

        modal.dataset.id = op.id;
        document.getElementById('editFecha').value = op.fecha;
        document.getElementById('editRecibo').value = op.numero_recibo || '';
        document.getElementById('editCliente').value = op.cliente_nombre;
        document.getElementById('editMontoClp').value = op.monto_clp;
        document.getElementById('editTasa').value = op.tasa;
        document.getElementById('editObs').value = op.observaciones || '';
        
        checkRecibo(document.getElementById('editRecibo'), document.getElementById('editReciboStatus'), document.getElementById('btnGuardarCambios'), op.id);
        
        modal.style.display = 'flex';
    }

    function cerrarModalEdicion() {
        modal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modal.dataset.id;
        const body = {
            fecha: document.getElementById('editFecha').value,
            numero_recibo: document.getElementById('editRecibo').value.trim(),
            cliente_nombre: document.getElementById('editCliente').value,
            monto_clp: document.getElementById('editMontoClp').value,
            tasa: document.getElementById('editTasa').value,
            observaciones: document.getElementById('editObs').value,
        };

        const r = await fetch(`/api/operaciones/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const res = await r.json();
        showToast(res.message || 'Error al actualizar.', r.ok ? 'success' : 'error');

        if (r.ok) {
            cerrarModalEdicion();
            await cargar();
        }
    });
    
    document.getElementById('cancelEdit').addEventListener('click', cerrarModalEdicion);
    
    (async () => {
      try {
        await fetchUser();
        if(!user) return;

        if(user.role !== 'master'){
          document.getElementById('fOperador').disabled = true;
          document.getElementById('fOperador').placeholder = 'No disponible';
          const btnResumen = document.getElementById('btnResumen');
          const btnRendimiento = document.getElementById('btnRendimiento');
          const btnRecalcular = document.getElementById('btnRecalcular');
          if (btnResumen) btnResumen.style.display = 'none';
          if (btnRendimiento) btnRendimiento.style.display = 'none';
          if (btnRecalcular) btnRecalcular.style.display = 'none';
        }
        
        const btnFiltrar = document.getElementById('btnFiltrar');
        const btnResumen = document.getElementById('btnResumen');
        const btnRendimiento = document.getElementById('btnRendimiento');
        const btnRecalcular = document.getElementById('btnRecalcular');
        const btnCargarMas = document.getElementById('btnCargarMasOperaciones');
        const btnLimpiar = document.getElementById('btnLimpiar');
        const btnExport = document.getElementById('btnExport');
        
        if (btnFiltrar) btnFiltrar.onclick = cargar;
        if (btnResumen) btnResumen.onclick = cargarResumen;
        if (btnRendimiento) btnRendimiento.onclick = cargarRendimiento;
        if (btnRecalcular) btnRecalcular.onclick = recalcularCostos;
        if (btnCargarMas) btnCargarMas.onclick = cargarMasOperaciones;
        if (btnLimpiar) {
          btnLimpiar.onclick = ()=>{ 
            ['fDesde','fHasta','fCliente','fOperador'].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.value = '';
            });
            const filtroResumen = document.getElementById('filtroNombreResumen');
            const resumenSection = document.getElementById('resumenSection');
            const tituloDetalle = document.getElementById('tituloDetalle');
            const tableContainer = document.querySelector('#tituloDetalle + .table-container');
            
            if (filtroResumen) filtroResumen.value = '';
            if (resumenSection) resumenSection.style.display = 'none';
            if (tituloDetalle) tituloDetalle.style.display = 'block';
            if (tableContainer) tableContainer.style.display = 'block';
            cargar(); 
          };
        }
        if (btnExport) btnExport.onclick = exportar;
        
        const editRecibo = document.getElementById('editRecibo');
        if (editRecibo) {
          editRecibo.addEventListener('input', () => {
            const reciboEl = document.getElementById('editRecibo');
            const statusEl = document.getElementById('editReciboStatus');
            const btnGuardar = document.getElementById('btnGuardarCambios');
            if (reciboEl && statusEl && btnGuardar) {
              checkRecibo(reciboEl, statusEl, btnGuardar);
            }
          });
        }
        
        const filtroNombreResumen = document.getElementById('filtroNombreResumen');
        if (filtroNombreResumen) {
          filtroNombreResumen.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query) {
              const filtrados = resumenDataGlobal.filter(d => 
                d.cliente_nombre.toLowerCase().includes(query)
              );
              renderResumen(filtrados);
            } else {
              renderResumen(resumenDataGlobal);
            }
          });
        }
        
        const fCliente = document.getElementById('fCliente');
        const fClienteSuggestions = document.getElementById('fClienteSuggestions');
        if (fCliente && fClienteSuggestions) {
          addClientAutocomplete(fCliente, fClienteSuggestions);
        }

        await cargar();
      } catch (error) {
        console.error('Error inicializando p√°gina:', error);
      }
    })();
  </script>
</body>
</html>
