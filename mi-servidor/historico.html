<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Histórico de Envíos</title>
  <style>
    :root{--primary:#007bff;--dark:#343a40;--muted:#6c757d;--light:#f8f9fa;--border:#dee2e6}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--light);color:var(--dark);margin:0;padding:24px}
    .card{max-width:1100px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);overflow:hidden}
    .hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 22px;border-bottom:1px solid var(--border)}
    .hdr h1{margin:0;font-size:1.25rem}
    .content{padding:20px 24px}
    .filters{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px}
    label{font-weight:700;color:var(--muted);font-size:.9rem;margin-bottom:6px;display:block}
    input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px}
    .btns{display:flex;gap:10px;margin-bottom:8px}
    button{padding:12px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-light{background:#e9ecef}
    .btn-edit{background:#ffc107; color:var(--dark); padding: 6px 10px; font-size: 0.8rem;}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;text-align:left}
    thead th{background:var(--light);border-bottom:1px solid var(--border);color:var(--muted)}
    tbody tr:nth-child(even){background:var(--light)}
    
    /* Estilos para el Modal de Edición */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:25px;border-radius:12px;width:100%;max-width:500px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-content h2{margin-top:0}.modal-form .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .modal-form .form-full{grid-column:1/-1}
    .modal-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
  </style>
</head>
<body>
  <div class="card">
    <div class="hdr">
      <h1>Histórico de Envíos</h1>
      <div class="btns">
        <button id="btnExport" class="btn-light">Exportar CSV</button>
        <button class="btn-primary" onclick="window.close()">Cerrar</button>
      </div>
    </div>
    <div class="content">
      <div class="filters">
        <div><label>Desde</label><input type="date" id="fDesde"></div>
        <div><label>Hasta</label><input type="date" id="fHasta"></div>
        <div><label>Cliente</label><input type="text" id="fCliente" placeholder="Nombre del cliente"></div>
        <div><label>Operador</label><input type="text" id="fOperador" placeholder="(solo Master)"></div>
      </div>
      <div class="btns">
        <button id="btnFiltrar" class="btn-primary">Ver Detalle</button>
        <button id="btnResumen" class="btn-primary">Ver Resumen Cliente</button>
        <button id="btnRendimiento" class="btn-primary" style="background-color: #38c172;">Reporte de Rendimiento</button>
        <button id="btnLimpiar" class="btn-light">Limpiar</button>
      </div>
      
      <div id="resumenSection" style="margin-top: 20px; display: none;">
          <h2 id="resumenTitle">Resumen Consolidado</h2>
          <table class="table">
              <thead><tr id="tbodyResumenHeader"></tr></thead>
              <tbody id="tbodyResumen"></tbody>
          </table>
      </div>
      <h2 id="tituloDetalle" style="margin-top: 20px;">Detalle de Envíos</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acción</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <h2>Editar Envío</h2>
      <form id="editForm" class="modal-form">
        <div class="form-grid">
          <div><label>Fecha</label><input type="date" id="editFecha" required></div>
          <div><label>Cliente</label><input type="text" id="editCliente" required></div>
          <div><label>Monto CLP</label><input type="number" id="editMontoClp" required></div>
          <div><label>Tasa</label><input type="number" id="editTasa" step="0.0001" required></div>
          <div class="form-full"><label>Observaciones</label><input type="text" id="editObs"></div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-light" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    let operacionesData = []; // Guardar los datos cargados para la edición
    let userRole = '';

    async function user(){
      const r = await fetch('/api/user-info');
      if(!r.ok){ location.href='/login.html'; return null; }
      const userData = await r.json();
      userRole = userData.role;
      return userData;
    }

    function row(op){
      const tr = document.createElement('tr');
      
      const fecha = new Date(op.fecha + 'T00:00:00'); 
      const fechaFormateada = fecha.toLocaleDateString('es-CL', {
          day: '2-digit', month: '2-digit', year: 'numeric'
      }).replace(/\//g, '-'); 

      const fmtCLP = v => Number(v).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const fmtVES = v => Number(v).toLocaleString('es-VE');

      tr.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${op.operador}</td>
        <td>${op.cliente_nombre}</td>
        <td>${fmtCLP(op.monto_clp)}</td>
        <td>${Number(op.tasa).toFixed(4)}</td>
        <td>${fmtVES(op.monto_ves)}</td>
        <td>${op.observaciones || ''}</td>
        <td><button class="btn-edit" onclick="abrirModalEdicion(${op.id})">Editar</button></td>`;
      return tr;
    }
    
    // ----------------------------------------
    // MODO: Detalle de Envíos
    // ----------------------------------------
    async function cargar(){
      document.getElementById('resumenSection').style.display = 'none';
      document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos';
      
      const params = new URLSearchParams({
        startDate: document.getElementById('fDesde').value || '',
        endDate:   document.getElementById('fHasta').value || '',
        cliente:   document.getElementById('fCliente').value || '',
        operador:  document.getElementById('fOperador').value || '',
        historico: '1'
      });
      const r = await fetch('/api/operaciones?' + params.toString());
      operacionesData = await r.json(); // Guardar los datos
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      operacionesData.forEach(d => tb.appendChild(row(d)));
    }
    
    // ----------------------------------------
    // MODO: Resumen Consolidado por Cliente
    // ----------------------------------------
    async function cargarResumen(){
        const fDesde = document.getElementById('fDesde').value;
        const fHasta = document.getElementById('fHasta').value;
        const tbResumen = document.getElementById('tbodyResumen');
        const resumenSection = document.getElementById('resumenSection');
        
        document.getElementById('resumenTitle').textContent = 'Resumen Consolidado por Cliente';
        document.getElementById('tbodyResumenHeader').innerHTML = `
            <th>Cliente</th>
            <th style="text-align:right">CLP Recibido Total</th>
            <th style="text-align:right">Costo Total</th>
            <th style="text-align:right">Ganancia Bruta</th>
        `;
        resumenSection.style.display = 'block';
        document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos (Oculto)';
        document.getElementById('tbody').innerHTML = '';
        tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">Cargando...</td></tr>';
        
        const params = new URLSearchParams({ startDate: fDesde || '', endDate: fHasta || '' });
        const r = await fetch('/api/historico/resumen?' + params.toString());
        const data = await r.json();

        tbResumen.innerHTML = '';
        const fmt = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:2,maximumFractionDigits:2});

        if (data.length === 0) {
            tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">No hay datos.</td></tr>';
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.cliente_nombre}</td>
                <td style="text-align:right; font-weight: 700;">${fmt(d.total_clp_recibido)}</td>
                <td style="text-align:right; color: var(--muted);">${fmt(d.total_costo_clp)}</td>
                <td style="text-align:right; font-weight: 700; color: ${d.ganancia_bruta > 0 ? 'green' : 'red'};">${fmt(d.ganancia_bruta)}</td>
            `;
            tbResumen.appendChild(tr);
        });
    }

    // ----------------------------------------
    // MODO: Reporte de Rendimiento
    // ----------------------------------------
    async function cargarRendimiento(){
        const fDesde = document.getElementById('fDesde').value;
        const fHasta = document.getElementById('fHasta').value;
        const tbResumen = document.getElementById('tbodyResumen');
        
        document.getElementById('resumenTitle').textContent = 'Reporte de Rendimiento por Operador';
        document.getElementById('tbodyResumenHeader').innerHTML = `
            <th>Operador</th>
            <th style="text-align:right">Millones Comisionables</th>
            <th style="text-align:right">CLP Enviado Total</th>
            <th style="text-align:right">Clientes Únicos</th>
            <th style="text-align:right">Bonificación Total (USD)</th>
        `;

        document.getElementById('resumenSection').style.display = 'block';
        document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos (Oculto)';
        document.getElementById('tbody').innerHTML = ''; 
        tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando...</td></tr>';
        
        const params = new URLSearchParams({ startDate: fDesde || '', endDate: fHasta || '' });
        const r = await fetch('/api/rendimiento/operadores?' + params.toString());
        const data = await r.json();

        tbResumen.innerHTML = '';
        const fmtCLP = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:0});
        
        if (data.length === 0) {
            tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">No hay datos.</td></tr>';
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.operador_nombre}</td>
                <td style="text-align:right;">${d.millones_comisionables}</td>
                <td style="text-align:right; font-weight: 700;">${fmtCLP(d.total_clp_enviado)}</td>
                <td style="text-align:right; color: var(--muted);">${d.clientes_unicos}</td>
                <td style="text-align:right; font-weight: 700; color: green;">$${d.bonificacion_usd.toFixed(2)} USD</td>
            `;
            tbResumen.appendChild(tr);
        });
    }
    
    function exportar(){
      const params = new URLSearchParams({
        startDate: document.getElementById('fDesde').value || '',
        endDate:   document.getElementById('fHasta').value || '',
        cliente:   document.getElementById('fCliente').value || '',
        operador:  document.getElementById('fOperador').value || '',
      });
      location.href = '/api/operaciones/export?' + params.toString();
    }

    // --- LÓGICA DEL MODAL DE EDICIÓN ---
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    function abrirModalEdicion(id) {
        const op = operacionesData.find(d => d.id === id);
        if (!op) return;

        // Llenar el formulario
        modal.dataset.id = op.id; // Guardar el ID en el modal
        document.getElementById('editFecha').value = op.fecha;
        document.getElementById('editCliente').value = op.cliente_nombre;
        document.getElementById('editMontoClp').value = op.monto_clp;
        document.getElementById('editTasa').value = op.tasa;
        document.getElementById('editObs').value = op.observaciones || '';
        
        modal.style.display = 'flex';
    }

    function cerrarModalEdicion() {
        modal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modal.dataset.id;
        const body = {
            fecha: document.getElementById('editFecha').value,
            cliente_nombre: document.getElementById('editCliente').value,
            monto_clp: document.getElementById('editMontoClp').value,
            tasa: document.getElementById('editTasa').value,
            observaciones: document.getElementById('editObs').value,
        };

        const r = await fetch(`/api/operaciones/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const res = await r.json();
        alert(res.message || 'Error al actualizar.');

        if (r.ok) {
            cerrarModalEdicion();
            await cargar(); // Recargar la tabla
        }
    });
    
    document.getElementById('cancelEdit').addEventListener('click', cerrarModalEdicion);
    
    (async () => {
      const u = await user(); if(!u) return;
      if(u.role !== 'master'){
        document.getElementById('fOperador').disabled = true;
        document.getElementById('fOperador').placeholder = 'No disponible';
        document.getElementById('btnResumen').style.display = 'none';
        document.getElementById('btnRendimiento').style.display = 'none';
      }
      
      document.getElementById('btnFiltrar').onclick = cargar;
      document.getElementById('btnResumen').onclick = cargarResumen;
      document.getElementById('btnRendimiento').onclick = cargarRendimiento;
      document.getElementById('btnLimpiar').onclick = ()=>{ 
          ['fDesde','fHasta','fCliente','fOperador'].forEach(id=>document.getElementById(id).value=''); 
          document.getElementById('resumenSection').style.display = 'none';
          document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos';
          cargar(); 
      };
      document.getElementById('btnExport').onclick = exportar;
      
      await cargar();
    })();
  </script>
</body>
</html>