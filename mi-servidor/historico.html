<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Histórico de Envíos</title>
  <style>
    :root{--primary:#007bff;--dark:#343a40;--muted:#6c757d;--light:#f8f9fa;--border:#dee2e6; --danger: #dc3545; --warning: #ffc107;}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--light);color:var(--dark);margin:0;padding:24px}
    .card{max-width:1100px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);overflow:hidden}
    .hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 22px;border-bottom:1px solid var(--border)}
    .hdr h1{margin:0;font-size:1.25rem}
    .content{padding:20px 24px}
    .filters{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px; align-items: start;}
    label{font-weight:700;color:var(--muted);font-size:.9rem;margin-bottom:6px;display:block}
    input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px}
    .btns{display:flex;gap:10px;margin-bottom:8px}
    button{padding:12px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-light{background:#e9ecef}
    .btn-edit, .btn-danger { padding: 6px 10px; font-size: 0.8rem; border-radius: 6px; }
    .btn-edit{background:var(--warning); color:var(--dark);}
    .btn-danger{background:var(--danger); color: white;}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;text-align:left}
    thead th{background:var(--light);border-bottom:1px solid var(--border);color:var(--muted)}
    tbody tr:nth-child(even){background:var(--light)}
    
    /* Estilos para el Modal de Edición */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:25px;border-radius:12px;width:100%;max-width:500px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-content h2{margin-top:0}.modal-form .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .modal-form .form-full{grid-column:1/-1}
    .modal-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
    #toast-container{position:fixed;top:20px;right:20px;z-index:1050;display:flex;flex-direction:column;gap:10px}
    .toast{min-width:250px;padding:1rem 1.5rem;border-radius:0.5rem;color:#fff;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,.1);opacity:0;transform:translateX(100%);transition:all .5s cubic-bezier(.68,-.55,.27,1.55)}
    .toast.show{opacity:1;transform:translateX(0)}
    .toast-success{background-color:#198754}
    .toast-error{background-color:#dc3545}

    /* ANOTACIÓN: Estilos para el autocompletado */
    .autocomplete-container{ position:relative; }
    .autocomplete-suggestions{ position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid var(--border-color); z-index:1000; display:none; border-radius: 8px; max-height: 200px; overflow-y: auto; }
    .suggestion-item{ padding:10px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.04) }
    .suggestion-item:hover{ background-color:var(--light-grey); }
  </style>
</head>
<body>
  <div id="toast-container" class="toast-container"></div>

  <div class="card">
    <div class="hdr">
      <h1>Histórico de Envíos</h1>
      <div class="btns">
        <button id="btnExport" class="btn-light">Exportar CSV</button>
        <button class="btn-primary" onclick="window.close()">Cerrar</button>
      </div>
    </div>
    <div class="content">
      <div class="filters">
        <div><label>Desde</label><input type="date" id="fDesde"></div>
        <div><label>Hasta</label><input type="date" id="fHasta"></div>
        <!-- ANOTACIÓN: Estructura HTML para el autocompletado -->
        <div class="autocomplete-container">
          <label>Cliente</label>
          <input type="text" id="fCliente" placeholder="Nombre del cliente" autocomplete="off">
          <div class="autocomplete-suggestions" id="fClienteSuggestions"></div>
        </div>
        <div><label>Operador</label><input type="text" id="fOperador" placeholder="(solo Master)"></div>
      </div>
      <div class="btns">
        <button id="btnFiltrar" class="btn-primary">Ver Detalle</button>
        <button id="btnResumen" class="btn-primary">Ver Resumen Cliente</button>
        <button id="btnRendimiento" class="btn-primary" style="background-color: #38c172;">Reporte de Rendimiento</button>
        <button id="btnLimpiar" class="btn-light">Limpiar</button>
      </div>
      
      <div id="resumenSection" style="margin-top: 20px; display: none;">
          <h2 id="resumenTitle">Resumen Consolidado</h2>
          <table class="table">
              <thead><tr id="tbodyResumenHeader"></tr></thead>
              <tbody id="tbodyResumen"></tbody>
          </table>
      </div>
      <h2 id="tituloDetalle" style="margin-top: 20px;">Detalle de Envíos</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Recibo</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acción</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <h2>Editar Envío</h2>
      <form id="editForm" class="modal-form">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
          <div><label>Fecha</label><input type="date" id="editFecha" required></div>
          <div>
            <label>Número de Recibo</label>
            <input type="text" id="editRecibo" required autocomplete="off">
            <div id="editReciboStatus" style="font-size: 0.8rem; font-weight: 700; margin-top: 4px; height: 1em;"></div>
          </div>
          <div style="grid-column: 1 / -1;"><label>Cliente</label><input type="text" id="editCliente" required></div>
          <div><label>Monto CLP</label><input type="number" id="editMontoClp" required></div>
          <div><label>Tasa</label><input type="number" id="editTasa" step="0.0001" required></div>
          <div class="form-full"><label>Observaciones</label><input type="text" id="editObs"></div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-light" id="cancelEdit">Cancelar</button>
          <button type="submit" id="btnGuardarCambios" class="btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    let operacionesData = [];
    let user = {};

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }
    
    let debounceTimeout;
    function checkRecibo(inputEl, statusEl, btnEl, excludeId = null) {
        clearTimeout(debounceTimeout);
        statusEl.textContent = 'Verificando...';
        statusEl.style.color = 'var(--muted)';
        btnEl.disabled = true;

        debounceTimeout = setTimeout(async () => {
            const numero = inputEl.value.trim();
            if (!numero) {
                statusEl.textContent = '';
                btnEl.disabled = true;
                return;
            }
            let url = `/api/recibo/check?numero=${encodeURIComponent(numero)}`;
            if (excludeId) url += `&excludeId=${excludeId}`;
            
            const r = await fetch(url);
            const res = await r.json();
            if (res.usado) {
                statusEl.textContent = 'USADO';
                statusEl.style.color = 'var(--danger)';
                btnEl.disabled = true;
            } else {
                statusEl.textContent = 'Libre';
                statusEl.style.color = 'var(--success)';
                btnEl.disabled = false;
            }
        }, 400);
    }

    // ANOTACIÓN: Función de autocompletado añadida.
    function addClientAutocomplete(inputEl, suggestionsEl) {
      let lastQuery = '';
      inputEl.addEventListener('input', async () => {
        const q = String(inputEl.value || '').trim();
        if (q.length < 2) { suggestionsEl.style.display = 'none'; return; }
        if (q === lastQuery) return;
        lastQuery = q;
        const res = await fetch(`/api/clientes/search?term=${encodeURIComponent(q)}`);
        const names = await res.json();
        suggestionsEl.innerHTML = '';
        if (names && names.length) {
          names.forEach(name => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = name;
            item.onclick = () => { inputEl.value = name; suggestionsEl.style.display = 'none'; };
            suggestionsEl.appendChild(item);
          });
          suggestionsEl.style.display = 'block';
        } else {
          suggestionsEl.style.display = 'none';
        }
      });
      document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target)) suggestionsEl.style.display = 'none'; });
    }

    async function fetchUser(){
      const r = await fetch('/api/user-info');
      if(!r.ok){ location.href='/login.html'; return null; }
      user = await r.json();
      return user;
    }

    function row(op){
      const tr = document.createElement('tr');
      
      const fecha = new Date(op.fecha + 'T00:00:00'); 
      const fechaFormateada = fecha.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-'); 

      const fmtCLP = v => Number(v).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const fmtVES = v => Number(v).toLocaleString('es-VE');

      let actions = `<button class="btn-edit" onclick="abrirModalEdicion(${op.id})">Editar</button>`;
      if (user.role === 'master') {
        actions += ` <button class="btn-danger" onclick="deleteOperacion(${op.id})">Borrar</button>`;
      }

      tr.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${op.numero_recibo || ''}</td>
        <td>${op.operador}</td>
        <td>${op.cliente_nombre}</td>
        <td>${fmtCLP(op.monto_clp)}</td>
        <td>${Number(op.tasa).toFixed(4)}</td>
        <td>${fmtVES(op.monto_ves)}</td>
        <td>${op.observaciones || ''}</td>
        <td>${actions}</td>`;
      return tr;
    }
    
    async function cargar(){
      document.getElementById('resumenSection').style.display = 'none';
      document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos';
      
      const params = new URLSearchParams({
        startDate: document.getElementById('fDesde').value || '',
        endDate:   document.getElementById('fHasta').value || '',
        cliente:   document.getElementById('fCliente').value || '',
        operador:  document.getElementById('fOperador').value || '',
        historico: '1'
      });
      const r = await fetch('/api/operaciones?' + params.toString());
      operacionesData = await r.json();
      const tb = document.getElementById('tbody');
      tb.innerHTML = '';
      operacionesData.forEach(d => tb.appendChild(row(d)));
    }
    
    async function cargarResumen(){
        const fDesde = document.getElementById('fDesde').value;
        const fHasta = document.getElementById('fHasta').value;
        const tbResumen = document.getElementById('tbodyResumen');
        const resumenSection = document.getElementById('resumenSection');
        
        document.getElementById('resumenTitle').textContent = 'Resumen Consolidado por Cliente';
        document.getElementById('tbodyResumenHeader').innerHTML = `
            <th>Cliente</th>
            <th style="text-align:right">CLP Recibido Total</th>
            <th style="text-align:right">Costo Total</th>
            <th style="text-align:right">Ganancia Bruta</th>
        `;
        resumenSection.style.display = 'block';
        document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos (Oculto)';
        document.getElementById('tbody').innerHTML = '';
        tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">Cargando...</td></tr>';
        
        const params = new URLSearchParams({ startDate: fDesde || '', endDate: fHasta || '' });
        const r = await fetch('/api/historico/resumen?' + params.toString());
        const data = await r.json();

        tbResumen.innerHTML = '';
        const fmt = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:2,maximumFractionDigits:2});

        if (data.length === 0) {
            tbResumen.innerHTML = '<tr><td colspan="4" style="text-align:center">No hay datos.</td></tr>';
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.cliente_nombre}</td>
                <td style="text-align:right; font-weight: 700;">${fmt(d.total_clp_recibido)}</td>
                <td style="text-align:right; color: var(--muted);">${fmt(d.total_costo_clp)}</td>
                <td style="text-align:right; font-weight: 700; color: ${d.ganancia_bruta > 0 ? 'green' : 'red'};">${fmt(d.ganancia_bruta)}</td>
            `;
            tbResumen.appendChild(tr);
        });
    }

    async function cargarRendimiento(){
        const fDesde = document.getElementById('fDesde').value;
        const fHasta = document.getElementById('fHasta').value;
        const tbResumen = document.getElementById('tbodyResumen');
        
        document.getElementById('resumenTitle').textContent = 'Reporte de Rendimiento por Operador';
        document.getElementById('tbodyResumenHeader').innerHTML = `
            <th>Operador</th>
            <th style="text-align:right">Millones Comisionables</th>
            <th style="text-align:right">CLP Enviado Total</th>
            <th style="text-align:right">Clientes Únicos</th>
            <th style="text-align:right">Bonificación Total (USD)</th>
        `;

        document.getElementById('resumenSection').style.display = 'block';
        document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos (Oculto)';
        document.getElementById('tbody').innerHTML = ''; 
        tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando...</td></tr>';
        
        const params = new URLSearchParams({ startDate: fDesde || '', endDate: fHasta || '' });
        const r = await fetch('/api/rendimiento/operadores?' + params.toString());
        const data = await r.json();

        tbResumen.innerHTML = '';
        const fmtCLP = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:0});
        
        if (data.length === 0) {
            tbResumen.innerHTML = '<tr><td colspan="5" style="text-align:center">No hay datos.</td></tr>';
            return;
        }

        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.operador_nombre}</td>
                <td style="text-align:right;">${d.millones_comisionables}</td>
                <td style="text-align:right; font-weight: 700;">${fmtCLP(d.total_clp_enviado)}</td>
                <td style="text-align:right; color: var(--muted);">${d.clientes_unicos}</td>
                <td style="text-align:right; font-weight: 700; color: green;">$${d.bonificacion_usd.toFixed(2)} USD</td>
            `;
            tbResumen.appendChild(tr);
        });
    }
    
    function exportar(){
      const params = new URLSearchParams({
        startDate: document.getElementById('fDesde').value || '',
        endDate:   document.getElementById('fHasta').value || '',
        cliente:   document.getElementById('fCliente').value || '',
        operador:  document.getElementById('fOperador').value || '',
      });
      location.href = '/api/operaciones/export?' + params.toString();
    }

    async function deleteOperacion(id) {
        if (!confirm('¿Estás seguro de que quieres borrar esta operación?\nEsta acción es irreversible y afectará los saldos globales.')) return;
        const r = await fetch(`/api/operaciones/${id}`, { method: 'DELETE' });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) {
            await cargar();
        }
    }

    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    function abrirModalEdicion(id) {
        const op = operacionesData.find(d => d.id === id);
        if (!op) return;

        modal.dataset.id = op.id;
        document.getElementById('editFecha').value = op.fecha;
        document.getElementById('editRecibo').value = op.numero_recibo || '';
        document.getElementById('editCliente').value = op.cliente_nombre;
        document.getElementById('editMontoClp').value = op.monto_clp;
        document.getElementById('editTasa').value = op.tasa;
        document.getElementById('editObs').value = op.observaciones || '';
        
        checkRecibo(document.getElementById('editRecibo'), document.getElementById('editReciboStatus'), document.getElementById('btnGuardarCambios'), op.id);
        
        modal.style.display = 'flex';
    }

    function cerrarModalEdicion() {
        modal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modal.dataset.id;
        const body = {
            fecha: document.getElementById('editFecha').value,
            numero_recibo: document.getElementById('editRecibo').value.trim(),
            cliente_nombre: document.getElementById('editCliente').value,
            monto_clp: document.getElementById('editMontoClp').value,
            tasa: document.getElementById('editTasa').value,
            observaciones: document.getElementById('editObs').value,
        };

        const r = await fetch(`/api/operaciones/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const res = await r.json();
        showToast(res.message || 'Error al actualizar.', r.ok ? 'success' : 'error');

        if (r.ok) {
            cerrarModalEdicion();
            await cargar();
        }
    });
    
    document.getElementById('cancelEdit').addEventListener('click', cerrarModalEdicion);
    
    (async () => {
      await fetchUser();
      if(!user) return;

      if(user.role !== 'master'){
        document.getElementById('fOperador').disabled = true;
        document.getElementById('fOperador').placeholder = 'No disponible';
        document.getElementById('btnResumen').style.display = 'none';
        document.getElementById('btnRendimiento').style.display = 'none';
      }
      
      document.getElementById('btnFiltrar').onclick = cargar;
      document.getElementById('btnResumen').onclick = cargarResumen;
      document.getElementById('btnRendimiento').onclick = cargarRendimiento;
      document.getElementById('btnLimpiar').onclick = ()=>{ 
          ['fDesde','fHasta','fCliente','fOperador'].forEach(id=>document.getElementById(id).value=''); 
          document.getElementById('resumenSection').style.display = 'none';
          document.getElementById('tituloDetalle').textContent = 'Detalle de Envíos';
          cargar(); 
      };
      document.getElementById('btnExport').onclick = exportar;
      
      document.getElementById('editRecibo').addEventListener('input', () => checkRecibo(document.getElementById('editRecibo'), document.getElementById('editReciboStatus'), document.getElementById('btnGuardarCambios'), modal.dataset.id));
      
      // ANOTACIÓN: Llamada a la función de autocompletado para el filtro de clientes.
      addClientAutocomplete(document.getElementById('fCliente'), document.getElementById('fClienteSuggestions'));

      await cargar();
    })();
  </script>
</body>
</html>