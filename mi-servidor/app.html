<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Defi Oracle - App</title>
  <style>
    :root{--primary:#007bff;--secondary:#4cebaf;--danger:#dc3540;--dark:#343a40;--muted:#6c757d;--light:#f8f9fa;--border:#dee2e6}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--light);color:var(--dark);line-height:1.6;padding:20px}
    .container{max-width:900px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);overflow:hidden}
    .navbar{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:#fff;border-bottom:1px solid var(--border)}
    .brand{display:flex;justify-content:space-between;align-items:center;text-decoration:none}
    .brand img{height:36px; margin-right: 10px;}
    .brand span{font-weight:800;color:var(--dark)}
    .user-menu{position:relative}
    .btn-menu{background:var(--light);border:1px solid var(--border);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-edit{background:#ffc107; color:var(--dark); padding: 6px 10px; font-size: 0.8rem; border:none; border-radius: 6px; font-weight: 700; cursor: pointer;}
    .dropdown{position:absolute;right:0;top:110%;background:#fff;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.12);display:none;min-width:220px;padding:6px}
    .dropdown.show{display:block}
    .dropdown a{display:block;padding:10px 14px;text-decoration:none;color:var(--dark);border-radius:8px}
    .dropdown a:hover{background:var(--light)}
    .content{padding:30px 40px}
    h2{text-align:center;margin:24px 0 12px}
    form{display:flex;flex-direction:column;gap:14px}
    label{font-weight:700;color:var(--muted);font-size:.92rem}
    input[type="text"],input[type="number"],input[type="date"]{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:8px}
    .btn{padding:12px 18px;border:none;border-radius:10px;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--primary);color:#fff}
    .kpis-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:12px; margin-bottom: 12px;}
    .kpis-rates {display:grid;grid-template-columns:repeat(2,1fr);gap:12px; margin-bottom: 20px;}
    .kpi{background:var(--light);border:1px solid var(--border);border-radius:12px;padding:14px}
    .highlight{background:#eaf4ff;border:1px dashed var(--primary);border-radius:10px;padding:14px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;text-align:left}
    thead th{background:var(--light);border-bottom:1px solid var(--border);color:var(--muted)}
    tbody tr:nth-child(even){background:var(--light)}
    .kpi-ves {border:2px solid var(--primary); background:#eaf4ff; padding:15px; border-radius:12px; text-align:center; margin-bottom:24px; box-shadow:0 4px 6px rgba(0,0,0,0.05);}
    .kpi-ves h3 {color:var(--primary); margin:0 0 5px; font-size:1rem;}
    .kpi-ves strong {font-size:1.8rem; font-weight:900; display:block;}
    .kpi-h4 { color:var(--muted); font-size:.92rem; margin-bottom:4px; }

    /* Estilos para el Modal de Edición */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:25px;border-radius:12px;width:100%;max-width:500px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-content h2{margin-top:0}.modal-form .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .modal-form .form-full{grid-column:1/-1}
    .modal-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
  </style>
</head>
<body>
  <div class="container">
    <nav class="navbar">
      <div class="brand">
        <img src="logo.png" alt="logo" />
        <span>Registro de Envíos</span>
      </div>
      <div class="user-menu">
        <button class="btn-menu" id="menuBtn"><span id="userLabel">Usuario</span> ▾</button>
        <div class="dropdown" id="menuDrop">
          <a id="adminLink" href="/admin.html" target="_blank" style="display:none">Administración</a>
          <a id="historicoLink" href="/historico.html" target="_blank">Histórico de Envíos</a>
          <hr/>
          <a href="/logout">Cerrar Sesión</a>
        </div>
      </div>
    </nav>

    <div class="content">
      
      <div id="kpiSaldoVes" class="kpi-ves" style="display: none;">
          <h3>SALDO VES ONLINE DISPONIBLE</h3>
          <strong id="kpiVesOnline">0,00 VES</strong>
      </div>

      <section id="kpisSection" style="display:none">
        <h2>Dashboard en Tiempo Real</h2>
        <div class="kpis-rates">
            <div class="kpi" style="background: #f0f8ff;">
                <div style="color:var(--muted)">Tasa Compra Promedio (VES/CLP)</div>
                <div id="kpiTasaCompra" style="font-weight:800; color:var(--primary)">—</div>
            </div>
            <div class="kpi" style="background: #f0f8ff;">
                <div style="color:var(--muted)">Tasa Venta Promedio HOY (VES/CLP)</div>
                <div id="kpiTasaVenta" style="font-weight:800; color:var(--primary)">—</div>
            </div>
        </div>
        <div class="kpis-grid">
          <div class="kpi"><div style="color:var(--muted)">Ganancia Bruta HOY (CLP)</div><div id="kpiG" style="font-weight:800">—</div></div>
          <div class="kpi"><div style="color:var(--muted)">Total Enviado HOY (CLP)</div><div id="kpiT" style="font-weight:800">—</div></div>
          <div class="kpi"><div style="color:var(--muted)">Margen Bruto HOY</div><div id="kpiM" style="font-weight:800">—</div></div>
        </div>
        <h3 style="margin-top: 15px;">Capital e Inventario</h3>
        <div class="kpis-grid">
          <div class="kpi" style="background: #eaf4ff;"><div class="kpi-h4">Capital Total (CLP)</div><div id="kpiCapitalTotal" style="font-weight:800">—</div></div>
          <div class="kpi"><div class="kpi-h4">Ganancia Acumulada (CLP)</div><div id="kpiGananciaAcumulada" style="font-weight:800">—</div></div>
          
          <div class="kpi">
            <div class="kpi-h4">Inventario VES (Valor en CLP)</div>
            <div id="kpiSaldoClpDisponible" style="font-weight:800">—</div>
          </div>
          </div>
      </section>

      <section id="operatorKpi" style="margin-bottom: 24px; display:none;">
          <h2 style="margin-bottom: 12px;">Tu Total Enviado (Este Mes)</h2>
          <div class="kpi" style="max-width:300px; margin: 0 auto; background:var(--secondary); color:var(--dark);">
              <div style="color:var(--dark); font-weight:700;">CLP Enviado Total Registrado</div>
              <div id="kpiOperatorClp" style="font-size:1.5rem; font-weight:900">0,00</div>
          </div>
      </section>

      <h2>Registrar Nuevo Envío</h2>
      <form id="frm">
        <div><label for="fch">Fecha del Envío</label><input type="date" id="fch" required></div>
        <div><label for="cli">Nombre del Cliente</label><input type="text" id="cli" required></div>
        <div><label for="mclp">Monto en CLP ($)</label><input type="number" id="mclp" required></div>
        <div><label for="tasa">Tasa</label><input type="number" id="tasa" step="0.0001" required></div>
        <div class="highlight">
          <div style="font-weight:700;color:var(--muted);margin-bottom:6px">Monto a recibir en VES (preview)</div>
          <div id="vesPreview" style="font-size:1.2rem;font-weight:800">0,00</div>
        </div>
        <div><label for="obs">Observaciones (opcional)</label><input type="text" id="obs"></div>
        <button class="btn btn-primary" type="submit">Guardar Envío</button>
      </form>

      <h2 id="tituloTabla">Envíos Registrados</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acción</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <h2>Editar Envío</h2>
      <form id="editForm" class="modal-form">
        <div class="form-grid">
          <div><label>Fecha</label><input type="date" id="editFecha" required></div>
          <div><label>Cliente</label><input type="text" id="editCliente" required></div>
          <div><label>Monto CLP</label><input type="number" id="editMontoClp" required></div>
          <div><label>Tasa</label><input type="number" id="editTasa" step="0.0001" required></div>
          <div class="form-full"><label>Observaciones</label><input type="text" id="editObs"></div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-light" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    let user = {};
    let operacionesData = []; // Guardar los datos cargados para la edición

    const getLocalYYYYMMDD = () => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        return new Date(now.getTime() - offset).toISOString().slice(0, 10);
    };

    async function cargarOperatorKpi(){
      const k = await (await fetch('/api/monthly-sales')).json();
      const fmt = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      document.getElementById('kpiOperatorClp').textContent = fmt(k.totalClpMensual);
    }
    
    async function cargarSaldoVes(){
        const r = await fetch('/api/dashboard');
        if (r.ok) {
            const d = await r.json();
            const fmtVES = v => (v||0).toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('kpiVesOnline').textContent = `${fmtVES(d.saldoVesOnline)} VES`;
        } else {
             document.getElementById('kpiVesOnline').textContent = `0,00 VES`;
        }
        document.getElementById('kpiSaldoVes').style.display = 'block';
    }

    async function cargarMasterMetrics(){
        if (user.role !== 'master') return;
        const r = await fetch('/api/dashboard');
        if (!r.ok) return; 

        const d = await r.json();
        const fmtCLP = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
        const fmtRate = v => (v||0).toFixed(6);

        document.getElementById('kpiG').textContent = fmtCLP(d.gananciaBruta);
        document.getElementById('kpiT').textContent = fmtCLP(d.totalClpEnviado);
        document.getElementById('kpiM').textContent = ((d.margenBruto||0).toFixed(1)) + '%';
        document.getElementById('kpiTasaCompra').textContent = fmtRate(d.tasaCompraPromedio);
        document.getElementById('kpiTasaVenta').textContent = fmtRate(d.tasaVentaPromedio);
        document.getElementById('kpiCapitalTotal').textContent = fmtCLP(d.capitalTotalClp);
        document.getElementById('kpiGananciaAcumulada').textContent = fmtCLP(d.totalGananciaAcumuladaClp);
        document.getElementById('kpiSaldoClpDisponible').textContent = fmtCLP(d.saldoDisponibleClp);
    }

    // Lógica de renderizado de la tabla
    const fila = (op) => {
      const tr = document.createElement('tr');
      const fecha = new Date(op.fecha + 'T00:00:00'); 
      const fechaFormateada = fecha.toLocaleDateString('es-CL', {
          day: '2-digit', month: '2-digit', year: 'numeric'
      }).replace(/\//g, '-'); 
      const fmtCLP = v => Number(v).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const fmtVES = v => Number(v).toLocaleString('es-VE');

      // El operador solo puede editar sus propios envíos del día
      const puedeEditar = (user.role === 'master') || (user.id === op.usuario_id && op.fecha === getLocalYYYYMMDD());

      tr.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${op.operador}</td>
        <td>${op.cliente_nombre}</td>
        <td>${fmtCLP(op.monto_clp)}</td>
        <td>${Number(op.tasa).toFixed(4)}</td>
        <td>${fmtVES(op.monto_ves)}</td>
        <td>${op.observaciones || ''}</td>
        <td>${puedeEditar ? `<button class="btn-edit" onclick="abrirModalEdicion(${op.id})">Editar</button>` : ''}</td>`;
      return tr;
    };

    async function cargarTabla() {
      const r = await fetch('/api/operaciones');
      operacionesData = await r.json(); // Guardar los datos
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      operacionesData.forEach(d => tbody.appendChild(fila(d)));
    }

    // --- LÓGICA DEL MODAL DE EDICIÓN ---
    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    function abrirModalEdicion(id) {
        const op = operacionesData.find(d => d.id === id);
        if (!op) return;

        modal.dataset.id = op.id;
        document.getElementById('editFecha').value = op.fecha;
        document.getElementById('editCliente').value = op.cliente_nombre;
        document.getElementById('editMontoClp').value = op.monto_clp;
        document.getElementById('editTasa').value = op.tasa;
        document.getElementById('editObs').value = op.observaciones || '';
        
        // El master puede cambiar la fecha, el operador no.
        document.getElementById('editFecha').disabled = (user.role !== 'master');
        
        modal.style.display = 'flex';
    }

    function cerrarModalEdicion() {
        modal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modal.dataset.id;
        const body = {
            fecha: document.getElementById('editFecha').value,
            cliente_nombre: document.getElementById('editCliente').value,
            monto_clp: document.getElementById('editMontoClp').value,
            tasa: document.getElementById('editTasa').value,
            observaciones: document.getElementById('editObs').value,
        };

        const r = await fetch(`/api/operaciones/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });

        const res = await r.json();
        alert(res.message || 'Error al actualizar.');

        if (r.ok) {
            cerrarModalEdicion();
            await cargarTabla();
            if (user.role === 'master') await cargarMasterMetrics();
            else await cargarOperatorKpi(); 
        }
    });

    (async () => {
      // Auth
      const info = await fetch('/api/user-info');
      if (!info.ok) return (location.href = '/login.html');
      user = await info.json();
      document.getElementById('userLabel').textContent = user.username;
      
      if (user.role === 'master') {
        document.getElementById('adminLink').style.display = 'block';
        document.getElementById('kpisSection').style.display = 'block'; 
        document.getElementById('operatorKpi').style.display = 'none'; 
        document.getElementById('historicoLink').style.display = 'block';
      } else {
        document.getElementById('tituloTabla').textContent = 'Envíos Registrados (Hoy)';
        document.getElementById('historicoLink').style.display = 'none'; 
        document.getElementById('operatorKpi').style.display = 'block';
      }

      // Dropdown menú
      const btn = document.getElementById('menuBtn');
      const drop = document.getElementById('menuDrop');
      btn.addEventListener('click', () => drop.classList.toggle('show'));
      window.addEventListener('click', (e) => { if (!btn.contains(e.target)) drop.classList.remove('show'); });

      // Lógica de formulario de registro
      const fch = document.getElementById('fch');
      fch.value = getLocalYYYYMMDD();

      let niveles = {};
      try { niveles = await (await fetch('/api/tasas')).json(); } catch (e) {}

      const mclp = document.getElementById('mclp');
      const tasa = document.getElementById('tasa');
      const vesPreview = document.getElementById('vesPreview');
      
      const aplicarTasaAutomatica = () => {
        const v = Number(mclp.value || 0);
        if (v >= 250000 && niveles.tasaNivel3) tasa.value = Number(niveles.tasaNivel3);
        else if (v >= 100000 && niveles.tasaNivel2) tasa.value = Number(niveles.tasaNivel2);
        else if (v >= 5000   && niveles.tasaNivel1) tasa.value = Number(niveles.tasaNivel1);
      };
      const actualizarPreview = () => {
        vesPreview.textContent = (Number(mclp.value||0) * Number(tasa.value||0)).toLocaleString('es-VE');
      };
      mclp.addEventListener('input', () => { aplicarTasaAutomatica(); actualizarPreview(); });
      tasa.addEventListener('input', actualizarPreview);
      
      document.getElementById('cancelEdit').addEventListener('click', cerrarModalEdicion);

      document.getElementById('frm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
          fecha: fch.value,
          cliente_nombre: document.getElementById('cli').value.trim(),
          monto_clp: Number(mclp.value || 0),
          tasa: Number(tasa.value || 0),
          monto_ves: Number(mclp.value || 0) * Number(tasa.value || 0),
          observaciones: document.getElementById('obs').value.trim()
        };
        const r = await fetch('/api/operaciones', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if (!r.ok) {
           const err = await r.json();
           return alert(`Error al guardar: ${err.message || 'Verifique el saldo VES.'}`);
        }
        e.target.reset();
        fch.value = getLocalYYYYMMDD();
        vesPreview.textContent = '0,00';
        await cargarTabla();
        await cargarSaldoVes(); 
        if (user.role === 'master') await cargarMasterMetrics();
        else await cargarOperatorKpi(); 
      });

      // Carga inicial
      await cargarTabla();
      await cargarSaldoVes(); 
      if (user.role === 'master') await cargarMasterMetrics();
      else await cargarOperatorKpi(); 
      actualizarPreview();
    })();
  </script>
</body>
</html>