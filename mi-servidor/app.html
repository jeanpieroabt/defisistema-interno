<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Defi Oracle - App</title>
  <style>
    :root{--primary:#007bff;--secondary:#4cebaf;--danger:#dc3540;--dark:#343a40;--muted:#6c757d;--light:#f8f9fa;--border:#dee2e6}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--light);color:var(--dark);line-height:1.6;padding:20px}
    .container{max-width:900px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);overflow:hidden}
    .navbar{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:#fff;border-bottom:1px solid var(--border)}
    .brand{display:flex;justify-content:space-between;align-items:center;text-decoration:none}
    .brand img{height:36px; margin-right: 10px;}
    .brand span{font-weight:800;color:var(--dark)}
    .user-menu{position:relative}
    .btn-menu{background:var(--light);border:1px solid var(--border);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-edit{background:#ffc107; color:var(--dark); padding: 6px 10px; font-size: 0.8rem; border:none; border-radius: 6px; font-weight: 700; cursor: pointer;}
    .dropdown{position:absolute;right:0;top:110%;background:#fff;border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.12);display:none;min-width:220px;padding:6px}
    .dropdown.show{display:block}
    .dropdown a{display:block;padding:10px 14px;text-decoration:none;color:var(--dark);border-radius:8px}
    .dropdown a:hover{background:var(--light)}
    .content{padding:30px 40px}
    h2{text-align:center;margin:24px 0 12px}
    form{display:flex;flex-direction:column;gap:14px}
    label{font-weight:700;color:var(--muted);font-size:.92rem}
    input[type="text"],input[type="number"],input[type="date"]{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:8px}
    .btn{padding:12px 18px;border:none;border-radius:10px;cursor:pointer;font-weight:800}
    .btn-primary{background:var(--primary);color:#fff}
    .kpis-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:12px; margin-bottom: 12px;}
    .kpis-rates {display:grid;grid-template-columns:repeat(2,1fr);gap:12px; margin-bottom: 20px;}
    .kpi{background:var(--light);border:1px solid var(--border);border-radius:12px;padding:14px}
    .highlight{background:#eaf4ff;border:1px dashed var(--primary);border-radius:10px;padding:14px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;text-align:left}
    thead th{background:var(--light);border-bottom:1px solid var(--border);color:var(--muted)}
    tbody tr:nth-child(even){background:var(--light)}
    .kpi-ves {border:2px solid var(--primary); background:#eaf4ff; padding:15px; border-radius:12px; text-align:center; margin-bottom:24px; box-shadow:0 4px 6px rgba(0,0,0,0.05);}
    .kpi-ves h3 {color:var(--primary); margin:0 0 5px; font-size:1rem;}
    .kpi-ves strong {font-size:1.8rem; font-weight:900; display:block;}
    .kpi-h4 { color:var(--muted); font-size:.92rem; margin-bottom:4px; }
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:25px;border-radius:12px;width:100%;max-width:500px;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-content h2{margin-top:0}.modal-form .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .modal-form .form-full{grid-column:1/-1}
    .modal-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    /* ESTILOS PARA AUTOCOMPLETAR */
    .autocomplete-container { position: relative; }
    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid var(--border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        z-index: 100;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .suggestion-item {
        padding: 10px 14px;
        cursor: pointer;
    }
    .suggestion-item:hover {
        background-color: var(--light);
    }
  </style>
</head>
<body>
  <div class="container">
    <nav class="navbar">
      <div class="brand">
        <img src="logo.png" alt="logo" />
        <span>Registro de Envíos</span>
      </div>
      <div class="user-menu">
        <button class="btn-menu" id="menuBtn"><span id="userLabel">Usuario</span> ▾</button>
        <div class="dropdown" id="menuDrop">
          <a id="adminLink" href="/admin.html" target="_blank" style="display:none">Administración</a>
          <a id="historicoLink" href="/historico.html" target="_blank">Histórico de Envíos</a>
          <hr/>
          <a href="/logout">Cerrar Sesión</a>
        </div>
      </div>
    </nav>
    <div class="content">
      <section id="kpisSection" style="display:none">
        </section>
      <section id="operatorKpi" style="margin-bottom: 24px; display:none;">
        </section>
      <h2>Registrar Nuevo Envío</h2>
      <form id="frm">
        <div><label for="fch">Fecha del Envío</label><input type="date" id="fch" required></div>
        
        <div class="autocomplete-container">
            <label for="cli">Nombre del Cliente</label>
            <input type="text" id="cli" required autocomplete="off">
            <div class="autocomplete-suggestions" id="clientSuggestions"></div>
        </div>

        <div><label for="mclp">Monto en CLP ($)</label><input type="number" id="mclp" required></div>
        <div><label for="tasa">Tasa</label><input type="number" id="tasa" step="0.0001" required></div>
        <div class="highlight">
          <div style="font-weight:700;color:var(--muted);margin-bottom:6px">Monto a recibir en VES (preview)</div>
          <div id="vesPreview" style="font-size:1.2rem;font-weight:800">0,00</div>
        </div>
        <div><label for="obs">Observaciones (opcional)</label><input type="text" id="obs"></div>
        <button class="btn btn-primary" type="submit">Guardar Envío</button>
      </form>
      <h2 id="tituloTabla">Envíos Registrados</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acción</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
  <div class="modal-overlay" id="editModal">
    </div>
  <script>
    let user = {};
    let operacionesData = [];

    // ... (otras funciones como getLocalYYYYMMDD, cargarOperatorKpi, etc. van aquí sin cambios) ...

    (async () => {
      // Auth, visibilidad, menú dropdown... (sin cambios)
      
      const fch = document.getElementById('fch');
      const cli = document.getElementById('cli');
      const clientSuggestions = document.getElementById('clientSuggestions');
      const mclp = document.getElementById('mclp');
      const tasa = document.getElementById('tasa');
      const obs = document.getElementById('obs');
      const vesPreview = document.getElementById('vesPreview');
      const tbody = document.getElementById('tbody');

      fch.value = getLocalYYYYMMDD();

      // LÓGICA DE AUTOCOMPLETAR
      cli.addEventListener('input', async () => {
        const query = cli.value;
        if (query.length < 2) {
            clientSuggestions.style.display = 'none';
            return;
        }

        try {
            const r = await fetch(`/api/clientes/search?term=${encodeURIComponent(query)}`);
            const names = await r.json();

            clientSuggestions.innerHTML = '';
            if (names.length > 0) {
                names.forEach(name => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = name;
                    item.addEventListener('click', () => {
                        cli.value = name;
                        clientSuggestions.style.display = 'none';
                    });
                    clientSuggestions.appendChild(item);
                });
                clientSuggestions.style.display = 'block';
            } else {
                clientSuggestions.style.display = 'none';
            }
        } catch(e) {
            console.error('Error en autocompletar:', e);
            clientSuggestions.style.display = 'none';
        }
      });
      // Ocultar sugerencias si se hace clic fuera
      window.addEventListener('click', (e) => {
        if (!cli.contains(e.target)) {
            clientSuggestions.style.display = 'none';
        }
      });

      // ... (resto del código del formulario, tabla, guardado, etc., sin cambios) ...
    })();
  </script>
</body>
</html>