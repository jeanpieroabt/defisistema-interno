<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Defi Oracle - App</title>
  <link rel="stylesheet" href="style.css">
  
  </head>
<body>

  <div id="toast-container" class="toast-container"></div>

  <div class="container">
    <nav class="navbar">
      <div class="brand">
        <img src="logo.png" alt="logo" />
        <span>Registro de Envíos</span>
      </div>
      <div class="user-menu">
        <button class="btn-menu" id="menuBtn"><span id="userLabel">Usuario</span> ▾</button>
        <div class="dropdown" id="menuDrop">
          <a id="adminLink" href="/admin.html" target="_blank" style="display:none">Administración</a>
          <a id="historicoLink" href="/historico.html" target="_blank" style="display:none">Histórico de Envíos</a>
          <hr/>
          <a href="/logout">Cerrar Sesión</a>
        </div>
      </div>
    </nav>

    <div class="content">
      
      <div id="kpiSaldoVes" class="kpi-ves" style="display: none;">
          <h3>SALDO VES ONLINE DISPONIBLE</h3>
          <strong id="kpiVesOnline">0,00 VES</strong>
      </div>

      <section id="kpisSection" style="display:none">
        <h2>Dashboard en Tiempo Real</h2>
        <div class="kpis-rates">
            <div class="kpi" style="background: #f0f8ff;">
                <div style="color:var(--muted)">Tasa Compra Promedio (VES/CLP)</div>
                <div id="kpiTasaCompra" style="font-weight:800; color:var(--primary)">—</div>
            </div>
            <div class="kpi" style="background: #f0f8ff;">
                <div style="color:var(--muted)">Tasa Venta Promedio HOY (VES/CLP)</div>
                <div id="kpiTasaVenta" style="font-weight:800; color:var(--primary)">—</div>
            </div>
        </div>
        <div class="kpis-grid">
          <div class="kpi"><div style="color:var(--muted)">Ganancia Bruta HOY (CLP)</div><div id="kpiG" style="font-weight:800">—</div></div>
          <div class="kpi"><div style="color:var(--muted)">Total Enviado HOY (CLP)</div><div id="kpiT" style="font-weight:800">—</div></div>
          <div class="kpi"><div style="color:var(--muted)">Margen Bruto HOY</div><div id="kpiM" style="font-weight:800">—</div></div>
        </div>
        <h3 style="margin-top: 15px;">Capital e Inventario</h3>
        <div class="kpis-grid">
          <div class="kpi" style="background: #eaf4ff;"><div class="kpi-h4">Capital Total (CLP)</div><div id="kpiCapitalTotal" style="font-weight:800">—</div></div>
          <div class="kpi"><div class="kpi-h4">Ganancia Acumulada (CLP)</div><div id="kpiGananciaAcumulada" style="font-weight:800">—</div></div>
          
          <div class="kpi">
            <div class="kpi-h4">Inventario VES (Valor en CLP)</div>
            <div id="kpiSaldoClpDisponible" style="font-weight:800">—</div>
          </div>
          </div>
      </section>

      <section id="operatorKpi" style="margin-bottom: 24px; display:none;">
          <h2 style="margin-bottom: 12px;">Tu Total Enviado (Este Mes)</h2>
          <div class="kpi" style="max-width:300px; margin: 0 auto; background:var(--secondary); color:var(--dark);">
              <div style="color:var(--dark); font-weight:700;">CLP Enviado Total Registrado</div>
              <div id="kpiOperatorClp" style="font-size:1.5rem; font-weight:900">0,00</div>
          </div>
      </section>

      <h2>Registrar Nuevo Envío</h2>
      <form id="frm">
        <div class="form-group"><label for="fch">Fecha del Envío</label><input type="date" id="fch" required></div>

        <div class="autocomplete-container form-group">
          <label for="cli">Nombre del Cliente</label>
          <input type="text" id="cli" required autocomplete="off" />
          <div class="autocomplete-suggestions" id="clientSuggestions"></div>
        </div>

        <div class="form-group"><label for="mclp">Monto en CLP ($)</label><input type="number" id="mclp" required></div>
        <div class="form-group"><label for="tasa">Tasa</label><input type="number" id="tasa" step="0.0001" required></div>
        <div class="highlight form-group">
          <div style="font-weight:700;color:var(--muted);margin-bottom:6px">Monto a recibir en VES (preview)</div>
          <div id="vesPreview" style="font-size:1.2rem;font-weight:800">0,00</div>
        </div>
        <div class="form-group"><label for="obs">Observaciones (opcional)</label><input type="text" id="obs"></div>
        <button class="btn btn-primary" type="submit">Guardar Envío</button>
      </form>

      <h2 id="tituloTabla">Envíos Registrados</h2>
      <table>
        <thead>
          <tr><th>Fecha</th><th>Operador</th><th>Cliente</th><th>Monto CLP</th><th>Tasa</th><th>Monto VES</th><th>Obs.</th><th>Acciones</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <h2>Editar Envío</h2>
      <form id="editForm" class="modal-form">
        <div class="form-grid">
          <div><label>Fecha</label><input type="date" id="editFecha" required></div>

          <div class="autocomplete-container">
            <label>Cliente</label>
            <input type="text" id="editCliente" required autocomplete="off">
            <div class="autocomplete-suggestions" id="editClientSuggestions"></div>
          </div>

          <div><label>Monto CLP</label><input type="number" id="editMontoClp" required></div>
          <div><label>Tasa</label><input type="number" id="editTasa" step="0.0001" required></div>
          <div class="form-full"><label>Observaciones</label><input type="text" id="editObs"></div>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-light" id="cancelEdit">Cancelar</button>
          <button type="submit" class="btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    let user = {};
    let operacionesData = [];

    const getLocalYYYYMMDD = () => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        return new Date(now.getTime() - offset).toISOString().slice(0, 10);
    };

    async function cargarOperatorKpi(){
      const k = await (await fetch('/api/monthly-sales')).json();
      const fmt = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      document.getElementById('kpiOperatorClp').textContent = fmt(k.totalClpMensual);
    }
    
    async function cargarSaldoVes(){
        const r = await fetch('/api/dashboard');
        if (r.ok) {
            const d = await r.json();
            const fmtVES = v => (v||0).toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('kpiVesOnline').textContent = `${fmtVES(d.saldoVesOnline)} VES`;
        } else {
             document.getElementById('kpiVesOnline').textContent = `0,00 VES`;
        }
        document.getElementById('kpiSaldoVes').style.display = 'block';
    }

    async function cargarMasterMetrics(){
        if (user.role !== 'master') return;
        const r = await fetch('/api/dashboard');
        if (!r.ok) return; 

        const d = await r.json();
        const fmtCLP = v => (v||0).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
        const fmtRate = v => (v||0).toFixed(6);

        document.getElementById('kpiG').textContent = fmtCLP(d.gananciaBruta);
        document.getElementById('kpiT').textContent = fmtCLP(d.totalClpEnviado);
        document.getElementById('kpiM').textContent = ((d.margenBruto||0).toFixed(1)) + '%';
        document.getElementById('kpiTasaCompra').textContent = fmtRate(d.tasaCompraPromedio);
        document.getElementById('kpiTasaVenta').textContent = fmtRate(d.tasaVentaPromedio);
        document.getElementById('kpiCapitalTotal').textContent = fmtCLP(d.capitalTotalClp);
        document.getElementById('kpiGananciaAcumulada').textContent = fmtCLP(d.totalGananciaAcumuladaClp);
        document.getElementById('kpiSaldoClpDisponible').textContent = fmtCLP(d.saldoDisponibleClp);
    }

    const fila = (op) => {
      const tr = document.createElement('tr');
      const fecha = new Date(op.fecha + 'T00:00:00'); 
      const fechaFormateada = fecha.toLocaleDateString('es-CL', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-'); 
      const fmtCLP = v => Number(v).toLocaleString('es-CL',{style:'currency',currency:'CLP'});
      const fmtVES = v => Number(v).toLocaleString('es-VE');

      let actions = '';
      const puedeEditar = (user.role === 'master') || (user.id === op.usuario_id && op.fecha === getLocalYYYYMMDD());
      if (puedeEditar) {
        actions += `<button class="btn-edit" onclick="abrirModalEdicion(${op.id})">Editar</button>`;
      }
      if (user.role === 'master') {
        actions += ` <button class="btn btn-danger" onclick="deleteOperacion(${op.id})">Borrar</button>`;
      }

      tr.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${op.operador}</td>
        <td>${op.cliente_nombre}</td>
        <td>${fmtCLP(op.monto_clp)}</td>
        <td>${Number(op.tasa).toFixed(4)}</td>
        <td>${fmtVES(op.monto_ves)}</td>
        <td>${op.observaciones || ''}</td>
        <td>${actions}</td>`;
      return tr;
    };

    async function cargarTabla() {
      const r = await fetch('/api/operaciones');
      operacionesData = await r.json();
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      operacionesData.forEach(d => tbody.appendChild(fila(d)));
    }

    async function reloadAllKpis() {
        await cargarSaldoVes(); 
        if (user.role === 'master') await cargarMasterMetrics();
        else await cargarOperatorKpi(); 
    }

    const modal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    function abrirModalEdicion(id) {
        const op = operacionesData.find(d => d.id === id);
        if (!op) return;
        modal.dataset.id = op.id;
        document.getElementById('editFecha').value = op.fecha;
        document.getElementById('editCliente').value = op.cliente_nombre;
        document.getElementById('editMontoClp').value = op.monto_clp;
        document.getElementById('editTasa').value = op.tasa;
        document.getElementById('editObs').value = op.observaciones || '';
        document.getElementById('editFecha').disabled = (user.role !== 'master');
        modal.style.display = 'flex';
    }

    function cerrarModalEdicion() {
        modal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = modal.dataset.id;
        const body = { fecha: document.getElementById('editFecha').value, cliente_nombre: document.getElementById('editCliente').value, monto_clp: document.getElementById('editMontoClp').value, tasa: document.getElementById('editTasa').value, observaciones: document.getElementById('editObs').value };
        const r = await fetch(`/api/operaciones/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) {
            cerrarModalEdicion();
            await cargarTabla();
            await reloadAllKpis();
        }
    });

    async function deleteOperacion(id) {
        if (!confirm('¿Estás seguro de que quieres borrar esta operación?\nEsta acción es irreversible y afectará los saldos globales.')) return;
        const r = await fetch(`/api/operaciones/${id}`, { method: 'DELETE' });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) {
            await cargarTabla();
            await reloadAllKpis();
        }
    }

    function addClientAutocomplete(inputEl, suggestionsEl) {
      let lastQuery = '';
      inputEl.addEventListener('input', async () => {
        const q = String(inputEl.value || '').trim();
        if (q.length < 2) { suggestionsEl.style.display = 'none'; return; }
        if (q === lastQuery) return;
        lastQuery = q;
        const res = await fetch(`/api/clientes/search?term=${encodeURIComponent(q)}`);
        const names = await res.json();
        suggestionsEl.innerHTML = '';
        if (names && names.length) {
          names.forEach(name => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = name;
            item.onclick = () => { inputEl.value = name; suggestionsEl.style.display = 'none'; };
            suggestionsEl.appendChild(item);
          });
          suggestionsEl.style.display = 'block';
        }
      });
      document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target)) suggestionsEl.style.display = 'none'; });
    }

    (async () => {
      const info = await fetch('/api/user-info');
      if (!info.ok) return (location.href = '/login.html');
      user = await info.json();
      document.getElementById('userLabel').textContent = user.username;
      
      // Habilitar el link de Histórico para todos
      document.getElementById('historicoLink').style.display = 'block';
      
      if (user.role === 'master') {
        document.getElementById('adminLink').style.display = 'block';
        document.getElementById('kpisSection').style.display = 'block'; 
        document.getElementById('operatorKpi').style.display = 'none'; 
      } else {
        document.getElementById('tituloTabla').textContent = 'Envíos Registrados (Hoy)';
        document.getElementById('operatorKpi').style.display = 'block';
      }

      const btn = document.getElementById('menuBtn');
      const drop = document.getElementById('menuDrop');
      btn.addEventListener('click', () => drop.classList.toggle('show'));
      window.addEventListener('click', (e) => { if (!btn.contains(e.target)) drop.classList.remove('show'); });

      const fch = document.getElementById('fch');
      fch.value = getLocalYYYYMMDD();
      let niveles = {};
      try { niveles = await (await fetch('/api/tasas')).json(); } catch (e) {}
      const mclp = document.getElementById('mclp');
      const tasa = document.getElementById('tasa');
      const vesPreview = document.getElementById('vesPreview');
      const aplicarTasaAutomatica = () => {
        const v = Number(mclp.value || 0);
        if (v >= 250000 && niveles.tasaNivel3) tasa.value = Number(niveles.tasaNivel3);
        else if (v >= 100000 && niveles.tasaNivel2) tasa.value = Number(niveles.tasaNivel2);
        else if (v >= 5000   && niveles.tasaNivel1) tasa.value = Number(niveles.tasaNivel1);
      };
      const actualizarPreview = () => { vesPreview.textContent = (Number(mclp.value||0) * Number(tasa.value||0)).toLocaleString('es-VE'); };
      mclp.addEventListener('input', () => { aplicarTasaAutomatica(); actualizarPreview(); });
      tasa.addEventListener('input', actualizarPreview);
      document.getElementById('cancelEdit').addEventListener('click', cerrarModalEdicion);
      document.getElementById('frm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = { fecha: fch.value, cliente_nombre: document.getElementById('cli').value.trim(), monto_clp: Number(mclp.value || 0), tasa: Number(tasa.value || 0), monto_ves: Number(mclp.value || 0) * Number(tasa.value || 0), observaciones: document.getElementById('obs').value.trim() };
        const r = await fetch('/api/operaciones', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (!r.ok) {
           const err = await r.json();
           return showToast(`Error: ${err.message || 'Verifique el saldo.'}`, 'error');
        }
        showToast('Envío registrado con éxito.', 'success');
        e.target.reset();
        fch.value = getLocalYYYYMMDD();
        vesPreview.textContent = '0,00';
        await cargarTabla();
        await reloadAllKpis();
      });
      addClientAutocomplete(document.getElementById('cli'), document.getElementById('clientSuggestions'));
      addClientAutocomplete(document.getElementById('editCliente'), document.getElementById('editClientSuggestions'));
      await cargarTabla();
      await reloadAllKpis();
      actualizarPreview();
    })();
  </script>
</body>
</html>