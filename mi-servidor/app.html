<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Defi Oracle - App</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* v2.0 - Saldo VES Grande */
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 800px;
      height: 800px;
      background-image: url('logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0.03;
      z-index: 0;
      pointer-events: none;
    }
    
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .card {
      position: relative;
      z-index: 1;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    
    .hdr {
      background: linear-gradient(135deg, #2D8CDB 0%, #2EC7A3 100%);
      color: white;
      padding: 2rem;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .logo-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logo-header img {
      height: 60px;
      width: auto;
      filter: brightness(0) invert(1);
      object-fit: contain;
    }
    
    .hdr h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .hdr .btns {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .content {
      padding: 2rem;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 1rem auto;
        padding: 0 0.5rem;
      }
      
      .hdr {
        padding: 1.5rem;
        flex-direction: column;
        align-items: flex-start;
      }
      
      .logo-header {
        flex-direction: row;
        width: 100%;
      }
      
      .logo-header img {
        height: 40px;
      }
      
      .hdr h1 {
        font-size: 1.5rem;
      }
      
      .hdr .btns {
        width: 100%;
      }
      
      .btn-back {
        width: 100%;
        justify-content: center;
      }
      
      .content {
        padding: 1rem;
      }
    
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
      }
      
      .navbar .brand {
        justify-content: center;
        font-size: 1.2rem;
      }
      
      .navbar .brand button {
        font-size: 1.5rem !important;
      }
      
      .user-menu {
        width: 100%;
        justify-content: center;
      }
      
      .container {
        padding: 1rem;
      }
      
      .kpis-rates, .kpi-cards {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr !important;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        font-size: 0.85rem;
      }
      
      .modal-content {
        width: 95%;
        padding: 1rem;
      }
    }

    .saldo-ves-banner {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1.75rem 2.25rem;
      border-radius: 14px;
      margin-bottom: 2rem;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.35);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1.25rem;
    }

    .saldo-ves-banner .label {
      color: rgba(255, 255, 255, 0.95) !important;
      font-size: 1.8rem !important;
      font-weight: 800 !important;
      text-transform: uppercase !important;
      letter-spacing: 3px !important;
      margin-bottom: 1rem !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }

    .saldo-ves-banner .valor {
      color: white !important;
      font-size: 6rem !important;
      font-weight: 900 !important;
      line-height: 1 !important;
      text-shadow: 0 6px 16px rgba(0, 0, 0, 0.5) !important;
      letter-spacing: 3px !important;
    }

    .saldo-ves-banner .refresh-btn {
      background: rgba(255, 255, 255, 0.25);
      border: 2px solid rgba(255, 255, 255, 0.4);
      padding: 1.25rem 2rem;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .saldo-ves-banner .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 768px) {
      .saldo-ves-banner {
        padding: 2rem 1.5rem;
        text-align: center;
        justify-content: center;
      }

      .saldo-ves-banner .label {
        font-size: 1.3rem;
      }

      .saldo-ves-banner .valor {
        font-size: 3.5rem;
      }

      .saldo-ves-banner .refresh-btn {
        width: 100%;
        justify-content: center;
        font-size: 1rem;
      }
    }
  </style>
  
  </head>
<body>

  <div id="toast-container" class="toast-container"></div>

  <div class="container">
    <div class="card">
      <div class="hdr">
        <div class="logo-header">
          <img src="logo.png" alt="Defi Oracle">
          <h1>üì¶ Registro de Env√≠os</h1>
        </div>
        <div class="btns">
          <a href="home.html" class="btn-back">üè† Inicio</a>
        </div>
      </div>

      <div class="content">

      <div class="saldo-ves-banner">
        <div>
          <div class="label" style="font-size: 1.1rem !important; font-weight: 700 !important;">üí∞ Saldo VES Disponible</div>
          <div class="valor" id="saldoVesDisplay" style="font-size: 3.2rem !important; font-weight: 800 !important;">-</div>
        </div>
        <button class="refresh-btn" onclick="cargarSaldoVes()" style="font-size: 0.85rem !important; padding: 0.65rem 1.1rem !important;">
          üîÑ Actualizar
        </button>
      </div>

      <h2>Registrar Nuevo Env√≠o</h2>
      <form id="frm">
        <div class="form-group"><label for="fch">Fecha del Env√≠o</label><input type="date" id="fch" required></div>

        <div class="form-group">
            <label for="recibo">N√∫mero de Recibo</label>
            <input type="text" id="recibo" required autocomplete="off" />
            <div id="reciboStatus" style="font-size: 0.8rem; font-weight: 700; margin-top: 4px; height: 1em;"></div>
        </div>

        <div class="autocomplete-container form-group">
          <label for="cli">Nombre del Cliente</label>
          <input type="text" id="cli" required autocomplete="off" />
          <div class="autocomplete-suggestions" id="clientSuggestions"></div>
        </div>

        <div class="form-group"><label for="mclp">Monto en CLP ($)</label><input type="number" id="mclp" required></div>
        <div class="form-group"><label for="tasa">Tasa</label><input type="number" id="tasa" step="0.0001" required></div>
        <div class="highlight form-group">
          <div style="font-weight:700;color:var(--muted);margin-bottom:6px">Monto a recibir en VES (preview)</div>
          <div id="vesPreview" style="font-size:1.2rem;font-weight:800">0,00</div>
        </div>
        <div class="form-group"><label for="obs">Observaciones (opcional)</label><input type="text" id="obs"></div>
        <button id="btnGuardar" class="btn btn-primary" type="submit" disabled>Guardar Env√≠o</button>
      </form>

      </div>
    </div>
  </div>


  <script>
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    let user = {};
    let debounceTimeout;

    // ----------- VALIDACI√ìN EN TIEMPO REAL DE RECIBO (NUEVO Y EDICI√ìN) -----------
    function checkRecibo(inputEl, statusEl, btnEl, excludeId = null) {
        clearTimeout(debounceTimeout);
        statusEl.textContent = 'Verificando...';
        statusEl.style.color = 'var(--medium-grey)';
        btnEl.disabled = true;

        debounceTimeout = setTimeout(async () => {
            const numero = inputEl.value.trim();
            if (!numero) {
                statusEl.textContent = '';
                btnEl.disabled = true;
                return;
            }
            let url = `/api/recibo/check?numero=${encodeURIComponent(numero)}`;
            if (excludeId) {
                url += `&excludeId=${excludeId}`;
            }
            const r = await fetch(url);
            const res = await r.json();
            if (res.usado) {
                statusEl.textContent = 'USADO';
                statusEl.style.color = 'var(--danger)';
                btnEl.disabled = true;
            } else {
                statusEl.textContent = 'Libre';
                statusEl.style.color = 'var(--success)';
                btnEl.disabled = false;
            }
        }, 400);
    }

    const getLocalYYYYMMDD = () => {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        return new Date(now.getTime() - offset).toISOString().slice(0, 10);
    };

    async function cargarSaldoVes() {
        try {
            const r = await fetch('/api/dashboard');
            if (!r.ok) {
                console.error('Error al cargar saldo VES');
                return;
            }
            const data = await r.json();
            const saldoVes = data.saldoVesOnline || 0;
            document.getElementById('saldoVesDisplay').textContent = 
                saldoVes.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Bs.';
        } catch (error) {
            console.error('Error cargando saldo VES:', error);
            document.getElementById('saldoVesDisplay').textContent = 'Error al cargar';
        }
    }

    function addClientAutocomplete(inputEl, suggestionsEl) {
      let lastQuery = '';
      inputEl.addEventListener('input', async () => {
        const q = String(inputEl.value || '').trim();
        if (q.length < 2) { suggestionsEl.style.display = 'none'; return; }
        if (q === lastQuery) return;
        lastQuery = q;
        const res = await fetch(`/api/clientes/search?term=${encodeURIComponent(q)}`);
        const names = await res.json();
        suggestionsEl.innerHTML = '';
        if (names && names.length) {
          names.forEach(name => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = name;
            item.onclick = () => { inputEl.value = name; suggestionsEl.style.display = 'none'; };
            suggestionsEl.appendChild(item);
          });
          suggestionsEl.style.display = 'block';
        }
      });
      document.addEventListener('click', (ev) => { if (!inputEl.contains(ev.target)) suggestionsEl.style.display = 'none'; });
    }

    (async () => {
      const info = await fetch('/api/user-info');
      if (!info.ok) return (location.href = '/login.html');
      user = await info.json();

      // Cargar saldo VES
      await cargarSaldoVes();

      const fch = document.getElementById('fch');
      fch.value = getLocalYYYYMMDD();
      let niveles = {};
      try { niveles = await (await fetch('/api/tasas')).json(); } catch (e) {}
      const mclp = document.getElementById('mclp');
      const tasa = document.getElementById('tasa');
      const vesPreview = document.getElementById('vesPreview');
      const aplicarTasaAutomatica = () => {
        const v = Number(mclp.value || 0);
        if (v >= 250000 && niveles.tasaNivel3) tasa.value = Number(niveles.tasaNivel3);
        else if (v >= 100000 && niveles.tasaNivel2) tasa.value = Number(niveles.tasaNivel2);
        else if (v >= 5000   && niveles.tasaNivel1) tasa.value = Number(niveles.tasaNivel1);
      };
      const actualizarPreview = () => { vesPreview.textContent = (Number(mclp.value||0) * Number(tasa.value||0)).toLocaleString('es-VE'); };
      mclp.addEventListener('input', () => { aplicarTasaAutomatica(); actualizarPreview(); });
      tasa.addEventListener('input', actualizarPreview);
      
      // VALIDACI√ìN AJAX DE RECIBO EN TIEMPO REAL
      document.getElementById('recibo').addEventListener('input', () => checkRecibo(document.getElementById('recibo'), document.getElementById('reciboStatus'), document.getElementById('btnGuardar')));
      
      document.getElementById('frm').addEventListener('submit', async (e) => {
        // Bloquea el submit si el recibo no est√° libre
        if (document.getElementById('btnGuardar').disabled) {
          e.preventDefault();
          showToast('Debes ingresar un n√∫mero de recibo v√°lido y disponible.', 'error');
          return;
        }
        e.preventDefault();
        const body = { 
            fecha: fch.value, 
            numero_recibo: document.getElementById('recibo').value.trim(),
            cliente_nombre: document.getElementById('cli').value.trim(), 
            monto_clp: mclp.value, 
            tasa: tasa.value, 
            monto_ves: Number(mclp.value) * Number(tasa.value), 
            observaciones: document.getElementById('obs').value.trim() 
        };
        const r = await fetch('/api/operaciones', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const res = await r.json();
        showToast(res.message || 'Error', r.ok ? 'success' : 'error');
        if (r.ok) {
            e.target.reset();
            fch.value = getLocalYYYYMMDD();
            document.getElementById('reciboStatus').textContent = '';
            document.getElementById('btnGuardar').disabled = true;
            vesPreview.textContent = '0,00';
            // Actualizar saldo VES despu√©s de registrar el env√≠o
            await cargarSaldoVes();
        }
      });

      addClientAutocomplete(document.getElementById('cli'), document.getElementById('clientSuggestions'));

      actualizarPreview();
    })();
  </script>
</body>
</html>

```
