<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N√≥mina - Defi Oracle</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .nomina-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px solid #2D8CDB;
        }

        .periodo-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .periodo-selector select {
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2D8CDB 0%, #2EC7A3 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 140, 219, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .resumen-periodo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .resumen-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }

        .resumen-card .icono {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .resumen-card .valor {
            font-size: 2rem;
            font-weight: 700;
            color: #2D8CDB;
            margin-bottom: 0.3rem;
        }

        .resumen-card .label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nomina-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #2D8CDB 0%, #2EC7A3 100%);
            color: white;
        }

        th, td {
            padding: 1rem;
            text-align: left;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .monto {
            font-weight: 600;
            color: #2D8CDB;
        }

        .total-pagar {
            font-size: 1.1rem;
            font-weight: 700;
            color: #28a745;
        }

        .estado-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .estado-abierto {
            background: #d1ecf1;
            color: #0c5460;
        }

        .estado-cerrado {
            background: #fff3cd;
            color: #856404;
        }

        .estado-pagado {
            background: #d4edda;
            color: #155724;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            z-index: 999999;
            backdrop-filter: blur(3px);
        }

        .modal.show {
            display: flex !important;
            justify-content: center;
            align-items: center;
        }

        .modal .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
            z-index: 1000000;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state .icono {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .btn-icon {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="nomina-container">
        <!-- Header -->
        <div class="header-section">
            <div>
                <h1>üí∞ N√≥mina Quincenal</h1>
                <p style="color: #666; margin-top: 0.5rem;">Gesti√≥n de pagos y bonificaciones</p>
            </div>
            <div class="periodo-selector">
                <select id="periodoSelect" onchange="cargarNomina()">
                    <option value="">Cargando periodos...</option>
                </select>
                <button class="btn btn-primary" onclick="calcularNomina()">
                    üîÑ Recalcular N√≥mina
                </button>
            </div>
        </div>

        <!-- Resumen del periodo -->
        <div class="resumen-periodo" id="resumenPeriodoContainer" style="display: none;">
            <div class="resumen-card">
                <div class="icono">üìÖ</div>
                <div class="valor" id="resumenPeriodo"></div>
                <div class="label">Periodo</div>
            </div>
            <div class="resumen-card">
                <div class="icono">üë•</div>
                <div class="valor" id="resumenOperadores">0</div>
                <div class="label">Operadores</div>
            </div>
            <div class="resumen-card">
                <div class="icono">üíµ</div>
                <div class="valor" id="resumenTotal">$0.00</div>
                <div class="label">Total a Pagar</div>
            </div>
            <div class="resumen-card">
                <div class="icono">üìä</div>
                <div class="valor" id="resumenEstado">-</div>
                <div class="label">Estado</div>
            </div>
        </div>

        <!-- Acciones del periodo -->
        <div style="text-align: right; margin-bottom: 1.5rem;" id="accionesPeriodo">
            <button class="btn btn-warning" id="btnCerrar" onclick="cerrarPeriodo()" style="display: none;">
                üîí Cerrar Periodo
            </button>
            <button class="btn btn-success" id="btnPagar" onclick="marcarComoPagado()" style="display: none;">
                ‚úÖ Marcar como Pagado
            </button>
        </div>

        <!-- Tabla de n√≥mina -->
        <div class="nomina-table">
            <div id="loadingNomina" class="loading">
                <div>‚è≥ Cargando n√≥mina...</div>
            </div>
            <div id="emptyNomina" class="empty-state" style="display: none;">
                <div class="icono">üìã</div>
                <div>No hay registros de n√≥mina para este periodo</div>
                <button class="btn btn-primary" onclick="calcularNomina()" style="margin-top: 1.5rem;">
                    Calcular N√≥mina
                </button>
            </div>
            <table id="tablaNomina" style="display: none;">
                <thead>
                    <tr>
                        <th>Operador</th>
                        <th class="text-center" title="Horas trabajadas (m√°x 54h pagadas)">Horas</th>
                        <th class="text-center" title="Millones CLP comisionables">Millones</th>
                        <th class="text-right" title="$1.38/hora √ó horas (m√°x 54h = $75)">Base</th>
                        <th class="text-right" title="$15 quincenal si cumple 54+ horas">Asistencia</th>
                        <th class="text-right" title="$15 manual - agregar desde Bonos">At. R√°pida</th>
                        <th class="text-right" title="$2 por mill√≥n CLP">Comisiones</th>
                        <th class="text-right" title="$8 por domingo trabajado">Domingos</th>
                        <th class="text-right" title="Bonos extras manuales">Extras</th>
                        <th class="text-right">Total</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody id="nominaBody">
                </tbody>
            </table>
        </div>

        <!-- Volver -->
        <div style="margin-top: 2rem;">
            <a href="home.html" class="btn" style="background: #6c757d; color: white;">
                ‚Üê Volver al Inicio
            </a>
        </div>
    </div>

    <!--Modal para bonos extras (FUERA del contenedor principal) -->
    <div class="modal" id="modalBonos" style="display: none;">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">üí∞ Agregar Bonos</div>
            <div class="form-group">
                <label>Operador:</label>
                <input type="text" id="modalOperadorNombre" readonly style="background: #f8f9fa;">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="modalAtencionRapida" style="width: 20px; height: 20px;">
                    <span>Bono Atenci√≥n R√°pida ($15 USD)</span>
                </label>
            </div>
            <div class="form-group">
                <label>Bonos Extras (USD):</label>
                <input type="number" id="modalBonosInput" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>Nota / Motivo:</label>
                <textarea id="modalNota" placeholder="Ej: Bono por desempe√±o excepcional, incentivo, etc."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" style="background: #6c757d; color: white;" id="btnCancelarModal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnGuardarBonos">
                    Guardar
                </button>
                </button>
            </div>
        </div>
    </div>

    <script>
        let periodos = [];
        let periodoActual = null;
        let nominaActual = [];
        let nominaIdSeleccionada = null;

        // Cargar periodos al iniciar
        (async function init() {
            await cargarPeriodos();
            await cargarNomina();
        })();

        async function cargarPeriodos() {
            try {
                const response = await fetch('/api/nomina/periodos');
                periodos = await response.json();

                const select = document.getElementById('periodoSelect');
                select.innerHTML = '';

                if (periodos.length === 0) {
                    // Crear periodo actual si no existe
                    const responsePeriodo = await fetch('/api/nomina/periodo-actual');
                    const nuevoPeriodo = await responsePeriodo.json();
                    periodos = [nuevoPeriodo];
                }

                periodos.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.id;
                    const nombreMes = new Date(p.anio, p.mes - 1).toLocaleString('es', { month: 'long' });
                    option.textContent = `${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)} ${p.anio} - ${p.quincena === 1 ? '1ra' : '2da'} Quincena (${p.estado})`;
                    if (p.estado === 'abierto') {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando periodos:', error);
            }
        }

        async function cargarNomina() {
            const periodoId = document.getElementById('periodoSelect').value;
            if (!periodoId) return;

            document.getElementById('loadingNomina').style.display = 'block';
            document.getElementById('emptyNomina').style.display = 'none';
            document.getElementById('tablaNomina').style.display = 'none';
            document.getElementById('resumenPeriodo').style.display = 'none';

            try {
                const response = await fetch(`/api/nomina/periodo/${periodoId}`);
                nominaActual = await response.json();

                periodoActual = periodos.find(p => p.id == periodoId);

                if (nominaActual.length === 0) {
                    document.getElementById('loadingNomina').style.display = 'none';
                    document.getElementById('emptyNomina').style.display = 'block';
                } else {
                    mostrarNomina();
                }

                actualizarResumen();
                actualizarBotones();
            } catch (error) {
                console.error('Error cargando n√≥mina:', error);
                document.getElementById('loadingNomina').style.display = 'none';
            }
        }

        function mostrarNomina() {
            const tbody = document.getElementById('nominaBody');
            tbody.innerHTML = '';

            nominaActual.forEach(n => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${n.username}</strong></td>
                    <td class="text-center">${n.horas_trabajadas.toFixed(1)}h</td>
                    <td class="text-center">${n.millones_comisionables.toFixed(2)}M</td>
                    <td class="text-right monto">$${n.sueldo_base.toFixed(2)}</td>
                    <td class="text-right monto">$${n.bono_asistencia.toFixed(2)}</td>
                    <td class="text-right monto">$${n.bono_atencion_rapida.toFixed(2)}</td>
                    <td class="text-right monto">$${n.comision_ventas.toFixed(2)}</td>
                    <td class="text-right monto">$${n.bono_domingos.toFixed(2)} (${n.domingos_trabajados})</td>
                    <td class="text-right monto">$${n.bonos_extra.toFixed(2)}</td>
                    <td class="text-right total-pagar">$${n.total_pagar.toFixed(2)}</td>
                    <td class="text-center">
                        ${periodoActual.estado === 'abierto' ? 
                            `<button type="button" class="btn btn-icon btn-primary btn-bonos" data-nomina-id="${n.id}" data-username="${n.username}" data-atencion="${n.bono_atencion_rapida}" data-bonos="${n.bonos_extra}">
                                ‚ûï Bonos
                            </button>` : 
                            '<span style="color: #999;">Cerrado</span>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Agregar event listeners a todos los botones de bonos
            document.querySelectorAll('.btn-bonos').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const nominaId = parseInt(this.getAttribute('data-nomina-id'));
                    const username = this.getAttribute('data-username');
                    const atencion = parseFloat(this.getAttribute('data-atencion'));
                    const bonos = parseFloat(this.getAttribute('data-bonos'));
                    
                    // CR√çTICO: Esperar a que el evento del click termine completamente
                    setTimeout(() => {
                        abrirModalBonos(nominaId, username, atencion, bonos);
                    }, 150);
                    
                    return false;
                });
            });

            document.getElementById('loadingNomina').style.display = 'none';
            document.getElementById('tablaNomina').style.display = 'table';
        }

        function actualizarResumen() {
            if (!periodoActual) return;

            document.getElementById('resumenPeriodoContainer').style.display = 'grid';

            const nombreMes = new Date(periodoActual.anio, periodoActual.mes - 1).toLocaleString('es', { month: 'short' });
            document.getElementById('resumenPeriodo').textContent = 
                `${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)} ${periodoActual.quincena === 1 ? '1-15' : '16-30'}`;

            document.getElementById('resumenOperadores').textContent = nominaActual.length;

            const totalPagar = nominaActual.reduce((sum, n) => sum + n.total_pagar, 0);
            document.getElementById('resumenTotal').textContent = `$${totalPagar.toFixed(2)}`;

            const estadoBadge = `<span class="estado-badge estado-${periodoActual.estado}">${periodoActual.estado.toUpperCase()}</span>`;
            document.getElementById('resumenEstado').innerHTML = estadoBadge;
        }

        function actualizarBotones() {
            const btnCerrar = document.getElementById('btnCerrar');
            const btnPagar = document.getElementById('btnPagar');

            if (periodoActual.estado === 'abierto') {
                btnCerrar.style.display = 'inline-block';
                btnPagar.style.display = 'none';
            } else if (periodoActual.estado === 'cerrado') {
                btnCerrar.style.display = 'none';
                btnPagar.style.display = 'inline-block';
            } else {
                btnCerrar.style.display = 'none';
                btnPagar.style.display = 'none';
            }
        }

        async function calcularNomina() {
            const periodoId = document.getElementById('periodoSelect').value;
            if (!periodoId) return;

            if (!confirm('¬øRecalcular la n√≥mina de este periodo? Esto actualizar√° todos los valores autom√°ticamente.')) {
                return;
            }

            try {
                document.getElementById('loadingNomina').style.display = 'block';
                document.getElementById('tablaNomina').style.display = 'none';

                const response = await fetch(`/api/nomina/calcular/${periodoId}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ N√≥mina calculada exitosamente');
                    await cargarNomina();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error calculando n√≥mina:', error);
                alert('‚ùå Error calculando n√≥mina');
            }
        }

        function abrirModalBonos(nominaId, username, atencionRapida, bonosActuales) {
            nominaIdSeleccionada = nominaId;
            document.getElementById('modalOperadorNombre').value = username;
            document.getElementById('modalAtencionRapida').checked = atencionRapida > 0;
            document.getElementById('modalBonosInput').value = bonosActuales || 0;
            document.getElementById('modalNota').value = '';
            document.getElementById('modalBonos').style.display = 'flex';
            
            // Agregar listener para clicks fuera del modal despu√©s de un delay
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 200);
        }

        function cerrarModal() {
            document.getElementById('modalBonos').style.display = 'none';
            nominaIdSeleccionada = null;
            document.removeEventListener('click', handleClickOutside);
        }

        function handleClickOutside(event) {
            const modal = document.getElementById('modalBonos');
            const modalContent = modal.querySelector('.modal-content');
            
            if (!modalContent.contains(event.target)) {
                cerrarModal();
            }
        }

        // Event listeners para botones del modal
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('btnCancelarModal').addEventListener('click', cerrarModal);
            document.getElementById('btnGuardarBonos').addEventListener('click', guardarBonos);
        });

        async function guardarBonos() {
            const atencionRapida = document.getElementById('modalAtencionRapida').checked ? 15.00 : 0;
            const bonos = parseFloat(document.getElementById('modalBonosInput').value) || 0;
            const nota = document.getElementById('modalNota').value;

            try {
                const response = await fetch(`/api/nomina/${nominaIdSeleccionada}/bonos`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        bono_atencion_rapida: atencionRapida,
                        bonos_extra: bonos, 
                        nota_bonos: nota 
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Bonos actualizados exitosamente');
                    cerrarModal();
                    await cargarNomina();
                } else {
                    const result = await response.json();
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error guardando bonos:', error);
                alert('‚ùå Error guardando bonos');
            }
        }

        async function cerrarPeriodo() {
            if (!confirm('¬øCerrar este periodo? No podr√°s modificar los valores despu√©s.')) {
                return;
            }

            const periodoId = document.getElementById('periodoSelect').value;

            try {
                const response = await fetch(`/api/nomina/periodo/${periodoId}/cerrar`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('‚úÖ Periodo cerrado exitosamente');
                    await cargarPeriodos();
                    await cargarNomina();
                } else {
                    const result = await response.json();
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error cerrando periodo:', error);
                alert('‚ùå Error cerrando periodo');
            }
        }

        async function marcarComoPagado() {
            if (!confirm('¬øMarcar este periodo como pagado?')) {
                return;
            }

            const periodoId = document.getElementById('periodoSelect').value;

            try {
                const response = await fetch(`/api/nomina/periodo/${periodoId}/pagar`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('‚úÖ Periodo marcado como pagado');
                    await cargarPeriodos();
                    await cargarNomina();
                } else {
                    const result = await response.json();
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error marcando como pagado:', error);
                alert('‚ùå Error marcando como pagado');
            }
        }
    </script>
</body>
</html>
