<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1974CE">
    <title>Historial - Defi Oracle</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .hist-header {
            background: var(--bg-white);
            padding: var(--space-xl);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            border-bottom: 1px solid var(--border-light);
        }

        .btn-back {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: var(--space-xs);
        }

        .hist-header-title {
            font-size: var(--font-h2);
            font-weight: var(--font-semibold);
        }

        .hist-filters {
            padding: var(--space-lg);
            background: var(--bg-white);
        }

        .filter-chips {
            display: flex;
            gap: var(--space-sm);
            overflow-x: auto;
            padding-bottom: var(--space-sm);
        }

        .filter-chip {
            padding: var(--space-sm) var(--space-md);
            background: var(--light-bg);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            font-size: var(--font-small);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .hist-content {
            padding: var(--space-lg);
        }

        .hist-group {
            margin-bottom: var(--space-xl);
        }

        .hist-date {
            font-size: var(--font-small);
            color: var(--neutral-gray);
            font-weight: var(--font-medium);
            margin-bottom: var(--space-md);
            padding-left: var(--space-sm);
        }

        .hist-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .hist-card:hover {
            box-shadow: var(--shadow-md);
        }

        .hist-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .hist-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            background: var(--secondary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-semibold);
            color: var(--primary-blue);
        }

        .hist-info {
            flex: 1;
        }

        .hist-name {
            font-weight: var(--font-medium);
        }

        .hist-method {
            font-size: var(--font-caption);
            color: var(--neutral-gray);
        }

        .hist-amount {
            text-align: right;
        }

        .hist-clp {
            font-weight: var(--font-semibold);
        }

        .hist-ves {
            font-size: var(--font-caption);
            color: var(--neutral-gray);
        }

        .hist-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
        }

        .hist-code {
            font-size: var(--font-caption);
            color: var(--neutral-gray);
            font-family: monospace;
        }

        .hist-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--font-small);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
        }

        .hist-status.completado {
            background: #D1FAE5;
            color: #059669;
        }

        .hist-status.pendiente {
            background: #FEF3C7;
            color: #D97706;
        }

        .hist-status.procesando {
            background: var(--secondary-blue);
            color: var(--primary-blue);
        }

        .hist-status.cancelado {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-3xl);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: var(--space-lg);
        }

        .empty-title {
            font-size: var(--font-h2);
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-sm);
        }

        .empty-text {
            color: var(--neutral-gray);
            margin-bottom: var(--space-xl);
        }

        /* Detail Modal */
        .detail-header {
            text-align: center;
            padding: var(--space-xl);
            border-bottom: 1px solid var(--border-light);
        }

        .detail-status-icon {
            font-size: 48px;
            margin-bottom: var(--space-md);
        }

        .detail-title {
            font-size: var(--font-h2);
            font-weight: var(--font-semibold);
        }

        .detail-body {
            padding: var(--space-xl);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--neutral-gray);
        }

        .detail-value {
            font-weight: var(--font-medium);
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="page">
            <!-- Header -->
            <header class="hist-header">
                <button class="btn-back" onclick="volver()">‚Üê</button>
                <h1 class="hist-header-title">Historial de env√≠os</h1>
            </header>

            <!-- Filters -->
            <div class="hist-filters">
                <div class="filter-chips">
                    <button class="filter-chip active" data-filter="todos" onclick="filtrar('todos')">Todos</button>
                    <button class="filter-chip" data-filter="completado" onclick="filtrar('completado')">Completados</button>
                    <button class="filter-chip" data-filter="pendiente" onclick="filtrar('pendiente')">Pendientes</button>
                    <button class="filter-chip" data-filter="procesando" onclick="filtrar('procesando')">En proceso</button>
                </div>
            </div>

            <!-- Content -->
            <main class="hist-content" id="histContent">
                <!-- Se llena din√°micamente -->
            </main>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">üì≠</div>
                <h2 class="empty-title">Sin env√≠os</h2>
                <p class="empty-text">A√∫n no has realizado ning√∫n env√≠o</p>
                <button class="btn btn-primary" onclick="window.location.href='enviar.html'">Hacer mi primer env√≠o</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-backdrop" id="detailModal" style="display: none;">
        <div class="modal" style="max-height: 80vh; overflow-y: auto;">
            <div class="detail-header">
                <div class="detail-status-icon" id="detailStatusIcon">‚úÖ</div>
                <h3 class="detail-title" id="detailTitle">Env√≠o completado</h3>
            </div>
            <div class="detail-body">
                <div class="detail-row">
                    <span class="detail-label">C√≥digo</span>
                    <span class="detail-value" id="detailCode">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Fecha</span>
                    <span class="detail-value" id="detailFecha">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destinatario</span>
                    <span class="detail-value" id="detailDestinatario">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Banco</span>
                    <span class="detail-value" id="detailBanco">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">M√©todo</span>
                    <span class="detail-value" id="detailMetodo">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Monto enviado</span>
                    <span class="detail-value" id="detailMontoCLP">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tasa aplicada</span>
                    <span class="detail-value" id="detailTasa">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Monto recibido</span>
                    <span class="detail-value" id="detailMontoVES" style="color: var(--accent-green); font-size: 18px;">-</span>
                </div>
            </div>
            <div style="padding: 0 var(--space-xl) var(--space-xl);">
                <button class="btn btn-primary" style="width: 100%;" onclick="cerrarModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        let envios = [];
        let filtroActual = 'todos';

        document.addEventListener('DOMContentLoaded', () => {
            verificarSesion();
            cargarHistorial();
        });

        function verificarSesion() {
            const token = localStorage.getItem('clienteToken');
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        async function cargarHistorial() {
            const token = localStorage.getItem('clienteToken');
            
            try {
                const response = await fetch('/api/cliente/solicitudes', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    envios = await response.json();
                } else {
                    envios = getMockData();
                }
            } catch {
                envios = getMockData();
            }

            renderizarHistorial();
        }

        function getMockData() {
            return [
                {
                    id: 1,
                    codigo: 'TRX-A1B2C3D4',
                    fecha: '2024-01-15T14:30:00',
                    destinatario: 'Mar√≠a Garc√≠a L√≥pez',
                    alias: 'Mam√°',
                    banco: 'Banco de Venezuela',
                    metodo: 'pago_movil',
                    monto_clp: 50000,
                    monto_ves: 2250,
                    tasa: 0.045,
                    estado: 'completado'
                },
                {
                    id: 2,
                    codigo: 'TRX-E5F6G7H8',
                    fecha: '2024-01-14T10:15:00',
                    destinatario: 'Carlos Garc√≠a L√≥pez',
                    alias: 'Hermano',
                    banco: 'Banesco',
                    metodo: 'transferencia',
                    monto_clp: 100000,
                    monto_ves: 4500,
                    tasa: 0.045,
                    estado: 'procesando'
                },
                {
                    id: 3,
                    codigo: 'TRX-I9J0K1L2',
                    fecha: '2024-01-10T16:45:00',
                    destinatario: 'Ana Mart√≠nez',
                    alias: null,
                    banco: 'Mercantil',
                    metodo: 'pago_movil',
                    monto_clp: 25000,
                    monto_ves: 1125,
                    tasa: 0.045,
                    estado: 'completado'
                }
            ];
        }

        function renderizarHistorial() {
            const container = document.getElementById('histContent');
            const emptyState = document.getElementById('emptyState');

            let filtrados = envios;
            if (filtroActual !== 'todos') {
                filtrados = filtrados.filter(e => e.estado === filtroActual);
            }

            if (filtrados.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Agrupar por fecha
            const grupos = {};
            filtrados.forEach(e => {
                const fecha = new Date(e.fecha);
                const key = fecha.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });
                if (!grupos[key]) grupos[key] = [];
                grupos[key].push(e);
            });

            container.innerHTML = Object.entries(grupos).map(([fecha, items]) => `
                <div class="hist-group">
                    <h3 class="hist-date">${capitalizar(fecha)}</h3>
                    ${items.map(e => `
                        <div class="hist-card" onclick="verDetalle(${e.id})">
                            <div class="hist-card-header">
                                <div class="hist-avatar">${getInitials(e.destinatario)}</div>
                                <div class="hist-info">
                                    <p class="hist-name">${e.alias || e.destinatario}</p>
                                    <p class="hist-method">${e.metodo === 'pago_movil' ? 'üì± Pago M√≥vil' : 'üè¶ Transferencia'}</p>
                                </div>
                                <div class="hist-amount">
                                    <p class="hist-clp">$${e.monto_clp.toLocaleString('es-CL')}</p>
                                    <p class="hist-ves">Bs. ${e.monto_ves.toLocaleString('es-VE')}</p>
                                </div>
                            </div>
                            <div class="hist-card-footer">
                                <span class="hist-code">${e.codigo}</span>
                                <span class="hist-status ${e.estado}">${getStatusLabel(e.estado)}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function getInitials(nombre) {
            return nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        function capitalizar(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getStatusLabel(estado) {
            const labels = {
                'completado': '‚úì Completado',
                'pendiente': '‚è≥ Pendiente',
                'procesando': 'üîÑ Procesando',
                'cancelado': '‚úï Cancelado'
            };
            return labels[estado] || estado;
        }

        function getStatusIcon(estado) {
            const icons = {
                'completado': '‚úÖ',
                'pendiente': '‚è≥',
                'procesando': 'üîÑ',
                'cancelado': '‚ùå'
            };
            return icons[estado] || 'üìã';
        }

        function getStatusTitle(estado) {
            const titles = {
                'completado': 'Env√≠o completado',
                'pendiente': 'Esperando pago',
                'procesando': 'En proceso',
                'cancelado': 'Env√≠o cancelado'
            };
            return titles[estado] || 'Env√≠o';
        }

        function filtrar(filtro) {
            filtroActual = filtro;
            
            document.querySelectorAll('.filter-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.filter === filtro);
            });

            renderizarHistorial();
        }

        function verDetalle(id) {
            const envio = envios.find(e => e.id === id);
            if (!envio) return;

            document.getElementById('detailStatusIcon').textContent = getStatusIcon(envio.estado);
            document.getElementById('detailTitle').textContent = getStatusTitle(envio.estado);
            document.getElementById('detailCode').textContent = envio.codigo;
            document.getElementById('detailFecha').textContent = new Date(envio.fecha).toLocaleString('es-CL');
            document.getElementById('detailDestinatario').textContent = envio.destinatario;
            document.getElementById('detailBanco').textContent = envio.banco;
            document.getElementById('detailMetodo').textContent = envio.metodo === 'pago_movil' ? 'Pago M√≥vil' : 'Transferencia';
            document.getElementById('detailMontoCLP').textContent = `$${envio.monto_clp.toLocaleString('es-CL')} CLP`;
            document.getElementById('detailTasa').textContent = `1 CLP = ${envio.tasa} VES`;
            document.getElementById('detailMontoVES').textContent = `Bs. ${envio.monto_ves.toLocaleString('es-VE')}`;

            document.getElementById('detailModal').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function volver() {
            window.history.back();
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-backdrop')) {
                cerrarModal();
            }
        });
    </script>
</body>
</html>
