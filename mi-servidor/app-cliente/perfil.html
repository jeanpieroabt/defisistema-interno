<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1974CE">
    <title>Mi Perfil - Defi Oracle</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script>
        (function() {
            const stored = localStorage.getItem('apiBaseUrlOverride');
            const isLocal = ['localhost', '127.0.0.1', '::1'].includes(location.hostname) || location.protocol === 'file:';
            if (isLocal) {
                window.API_BASE_URL = location.origin || 'http://localhost:3000';
                localStorage.setItem('apiBaseUrlOverride', window.API_BASE_URL);
                return;
            }
            if (stored) {
                window.API_BASE_URL = stored;
                return;
            }
            window.API_BASE_URL = window.API_BASE_URL || 'https://defisistema-interno.onrender.com';
        })();
    </script>
    <style>
        :root {
            --primary-blue: #1974CE;
            --secondary-blue: #D8E2E9;
            --accent-green: #5C8240;
            --dark-slate: #211C10;
            --neutral-gray: #9AA1A1;
            --light-bg: #E3EAEE;
            --brand-cyan: #2FC7B8;
            --white: #FFFFFF;
            --grad-brand-soft: linear-gradient(135deg, rgba(25,116,206,0.10), rgba(47,199,184,0.10));
            --grad-brand-card: linear-gradient(135deg, #1974CE 0%, #1F7FDB 35%, #2FC7B8 100%);
            --grad-brand-button: linear-gradient(90deg, #1974CE 0%, #2FC7B8 100%);
            --radius-sm: 10px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-xxl: 24px;
            --radius-full: 50%;
            --shadow-soft: 0 4px 12px rgba(15, 42, 84, 0.08);
            --shadow-card: 0 8px 22px rgba(12, 60, 124, 0.12);
            --shadow-button: 0 10px 18px rgba(25, 116, 206, 0.18);
            --shadow-button-hover: 0 16px 26px rgba(25, 116, 206, 0.22);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-xs: 11px;
            --font-sm: 13px;
            --font-base: 15px;
            --font-lg: 17px;
            --font-xl: 20px;
            --font-2xl: 24px;
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            --space-3xl: 32px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--grad-brand-soft);
            color: var(--dark-slate);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: transparent;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 140px;
            background: transparent;
        }

        .page-content {
            flex: 1;
            padding: var(--space-3xl);
            display: flex;
            flex-direction: column;
            gap: var(--space-3xl);
            background: rgba(255, 255, 255, 0.88);
            border-radius: var(--radius-xxl);
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255, 255, 255, 0.45);
            margin: var(--space-2xl);
            margin-bottom: 0;
            backdrop-filter: blur(18px);
        }

        @media (max-width: 420px) {
            .page-content {
                margin: var(--space-lg);
                margin-bottom: 0;
                padding: var(--space-2xl) var(--space-xl);
            }
        }

        /* Profile Hero */
        .profile-hero {
            background: var(--grad-brand-card);
            color: var(--white);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
        }

        .profile-hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(150deg, rgba(255,255,255,0.16), rgba(255,255,255,0));
        }

        .profile-hero-top {
            display: flex;
            align-items: center;
            gap: var(--space-xl);
            position: relative;
            z-index: 1;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: rgba(255,255,255,0.18);
            border: 2px solid rgba(255,255,255,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 700;
            overflow: hidden;
            backdrop-filter: blur(6px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .profile-name {
            font-size: var(--font-2xl);
            font-weight: 800;
            letter-spacing: -0.2px;
        }

        .profile-email {
            font-size: var(--font-sm);
            opacity: 0.9;
        }

        .profile-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            margin-top: 10px;
            background: rgba(255,255,255,0.18);
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.28);
            font-size: var(--font-xs);
            font-weight: 700;
        }

        /* Stats */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.94);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .metric-label {
            font-size: var(--font-xs);
            color: var(--neutral-gray);
            letter-spacing: 0.2px;
        }

        .metric-value {
            font-size: var(--font-2xl);
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: -0.3px;
        }

        /* Action lists */
        .section-title {
            font-size: var(--font-sm);
            font-weight: 700;
            color: var(--neutral-gray);
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: var(--space-sm);
        }

        .action-card {
            background: rgba(255,255,255,0.94);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(0,0,0,0.04);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-lg);
            border-bottom: 1px solid rgba(0,0,0,0.04);
            text-decoration: none;
            color: inherit;
            transition: background 0.2s ease, transform 0.15s ease;
            cursor: pointer;
        }

        .action-item:last-child {
            border-bottom: none;
        }

        .action-item:hover {
            background: rgba(25, 116, 206, 0.04);
            transform: translateY(-1px);
        }

        .action-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: var(--secondary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--primary-blue);
        }

        .action-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .action-title {
            font-weight: 700;
            font-size: var(--font-base);
        }

        .action-desc {
            font-size: var(--font-sm);
            color: var(--neutral-gray);
        }

        .action-chevron {
            color: var(--neutral-gray);
            font-weight: 700;
        }

        .action-item.danger .action-icon {
            background: #FEE2E2;
            color: #DC2626;
        }

        .action-item.danger .action-title {
            color: #DC2626;
        }

        .version-box {
            text-align: center;
            color: var(--neutral-gray);
            font-size: var(--font-xs);
        }

        /* Bottom nav */
        .glass-nav {
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 36px);
            max-width: 420px;
            padding: 14px 18px;
            padding-bottom: calc(14px + env(safe-area-inset-bottom, 0));
            border-radius: 22px;
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.65);
            box-shadow: 0 18px 36px rgba(20, 52, 102, 0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            z-index: 120;
        }

        @media (max-width: 520px) {
            .glass-nav {
                bottom: clamp(12px, env(safe-area-inset-bottom, 0) + 6px, 20px);
                width: calc(100% - 24px);
                padding: 12px 14px;
            }
        }

        .glass-nav-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-decoration: none;
            color: #7E8A9D;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 6px;
            min-width: 56px;
            transition: color 0.25s ease;
        }

        .glass-nav-item .icon {
            width: 34px;
            height: 34px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
            background: transparent;
            transition: background 0.25s ease, box-shadow 0.25s ease, color 0.25s ease;
        }

        .glass-nav-item .icon svg {
            width: 20px;
            height: 20px;
            stroke-width: 1.7;
        }

        .glass-nav-item .label {
            font-size: 11px;
            letter-spacing: 0.25px;
            color: inherit;
        }

        .glass-nav-item:hover:not(.active) {
            color: var(--primary-blue);
        }

        .glass-nav-item.active {
            color: var(--primary-blue);
        }

        .glass-nav-item.active .icon {
            color: var(--white);
            background: linear-gradient(120deg, var(--primary-blue) 0%, var(--brand-cyan) 100%);
            box-shadow: 0 10px 22px rgba(25, 116, 206, 0.22);
        }

        .glass-nav-item.active .label {
            color: var(--primary-blue);
        }

        .glass-nav-fab {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: var(--primary-blue);
            transform: translateY(-12px);
        }

        .glass-nav-fab-button {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--brand-cyan) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 36px rgba(25, 116, 206, 0.26);
            border: 3px solid rgba(255, 255, 255, 0.92);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .glass-nav-fab-button svg {
            width: 26px;
            height: 26px;
            color: #FFFFFF;
            stroke-width: 1.8;
        }

        .glass-nav-fab-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 24px 40px rgba(25, 116, 206, 0.30);
        }

        .glass-nav-fab .label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.25px;
            color: var(--primary-blue);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: var(--space-lg);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Estilos para Seccion de Referidos */
        .referido-card {
            background: rgba(255, 255, 255, 0.94);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: var(--shadow-soft);
            margin-bottom: var(--space-md);
        }

        .referido-card.referido-activo {
            background: linear-gradient(135deg, rgba(92, 130, 64, 0.08), rgba(47, 199, 184, 0.08));
            border: 1px solid rgba(92, 130, 64, 0.2);
        }

        .referido-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            cursor: pointer;
        }

        .referido-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: rgba(25, 116, 206, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            flex-shrink: 0;
        }

        .referido-info {
            flex: 1;
        }

        .referido-info h4 {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-slate);
            margin: 0 0 2px 0;
        }

        .referido-info p {
            font-size: var(--font-sm);
            color: var(--neutral-gray);
            margin: 0;
        }

        .codigo-box {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--light-bg);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-top: var(--space-md);
        }

        .codigo-valor {
            flex: 1;
            font-size: var(--font-xl);
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
        }

        .btn-copiar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--white);
            border: 1px solid rgba(25, 116, 206, 0.3);
            border-radius: var(--radius-sm);
            color: var(--primary-blue);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-copiar:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-compartir {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            margin-top: var(--space-md);
            background: var(--grad-brand-button);
            border: none;
            border-radius: var(--radius-md);
            color: var(--white);
            font-size: var(--font-base);
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-button);
            transition: all 0.2s ease;
        }

        .btn-compartir:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-button-hover);
        }

        .input-codigo-wrapper {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .input-codigo {
            flex: 1;
            padding: 12px 14px;
            border: 2px solid rgba(25, 116, 206, 0.2);
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .input-codigo:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(25, 116, 206, 0.1);
        }

        .btn-aplicar {
            padding: 12px 20px;
            background: var(--accent-green);
            border: none;
            border-radius: var(--radius-md);
            color: var(--white);
            font-size: var(--font-base);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-aplicar:hover {
            background: #4a6b33;
        }

        .referido-nota {
            font-size: var(--font-xs);
            color: var(--neutral-gray);
            margin-top: var(--space-sm);
            text-align: center;
        }

        .referidos-lista {
            margin-top: var(--space-md);
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            padding-top: var(--space-md);
        }

        .referido-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        }

        .referido-item:last-child {
            border-bottom: none;
        }

        .referido-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--secondary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--primary-blue);
            font-size: var(--font-sm);
        }

        .referido-detalle {
            flex: 1;
        }

        .referido-nombre {
            font-weight: 600;
            font-size: var(--font-sm);
            color: var(--dark-slate);
        }

        .referido-progreso-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .referido-progreso-bar {
            flex: 1;
            height: 6px;
            background: var(--light-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .referido-progreso-fill {
            height: 100%;
            background: var(--grad-brand-button);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .referido-progreso-text {
            font-size: var(--font-xs);
            color: var(--neutral-gray);
            min-width: 45px;
            text-align: right;
        }

        .referido-estado {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: var(--font-xs);
            font-weight: 700;
        }

        .referido-estado.pendiente {
            background: rgba(249, 115, 22, 0.12);
            color: #F97316;
        }

        .referido-estado.completado {
            background: rgba(92, 130, 64, 0.12);
            color: #5C8240;
        }

        .referido-estado.pagado {
            background: rgba(25, 116, 206, 0.12);
            color: var(--primary-blue);
        }

        .referido-estado.usado {
            background: rgba(156, 163, 175, 0.12);
            color: #6B7280;
        }

        .referido-estado.expirado {
            background: rgba(156, 163, 175, 0.12);
            color: #6B7280;
        }

        .referidos-empty {
            text-align: center;
            padding: var(--space-xl);
            color: var(--neutral-gray);
        }

        .referidos-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-sm);
            opacity: 0.5;
        }

        .referido-acciones {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .btn-reclamar-bono {
            background: linear-gradient(135deg, #3B7D3C, #4A9D4B);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-reclamar-bono:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59, 125, 60, 0.3);
        }

        .cupon-info {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            border: 1px dashed #D97706;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .cupon-info:hover {
            transform: scale(1.02);
            background: linear-gradient(135deg, #FDE68A, #FCD34D);
        }

        .cupon-codigo {
            font-weight: 700;
            color: #92400E;
            font-size: 12px;
            display: block;
        }

        .cupon-info small {
            color: #B45309;
            font-size: 10px;
        }

        .referido-item.cancelado {
            opacity: 0.5;
            background: #FEE2E2;
        }

        .referido-estado.reclamado {
            background: #FEF3C7;
            color: #92400E;
        }

        .referido-estado.cancelado {
            background: #FEE2E2;
            color: #DC2626;
        }

        .modal-container {
            background: var(--white);
            border-radius: var(--radius-xxl);
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            transform: translateY(20px) scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            background: var(--grad-brand-card);
            color: var(--white);
            padding: var(--space-2xl);
            border-radius: var(--radius-xxl) var(--radius-xxl) 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(150deg, rgba(255,255,255,0.16), rgba(255,255,255,0));
            border-radius: var(--radius-xxl) var(--radius-xxl) 0 0;
        }

        .modal-title {
            font-size: var(--font-xl);
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: var(--space-2xl);
            display: flex;
            flex-direction: column;
            gap: var(--space-xl);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }

        .form-label {
            font-size: var(--font-sm);
            font-weight: 700;
            color: var(--dark-slate);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .form-input, .form-select {
            width: 100%;
            padding: var(--space-lg);
            border: 2px solid var(--secondary-blue);
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: var(--font-base);
            color: var(--dark-slate);
            background: var(--white);
            transition: all 0.2s ease;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(25, 116, 206, 0.1);
        }

        .form-input::placeholder {
            color: var(--neutral-gray);
        }

        .form-input:disabled {
            background: var(--light-bg);
            color: var(--neutral-gray);
            cursor: not-allowed;
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: var(--space-xl);
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: var(--grad-brand-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: var(--white);
            overflow: hidden;
            border: 3px solid var(--white);
            box-shadow: var(--shadow-card);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .btn-upload {
            padding: var(--space-md) var(--space-lg);
            background: var(--secondary-blue);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--primary-blue);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-upload:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        .avatar-hint {
            font-size: var(--font-xs);
            color: var(--neutral-gray);
        }

        .modal-footer {
            padding: 0 var(--space-2xl) var(--space-2xl);
            display: flex;
            gap: var(--space-md);
        }

        .btn-cancel {
            flex: 1;
            padding: var(--space-lg);
            background: var(--light-bg);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--neutral-gray);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel:hover {
            background: var(--secondary-blue);
            color: var(--dark-slate);
        }

        .btn-save {
            flex: 2;
            padding: var(--space-lg);
            background: var(--grad-brand-button);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-family);
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-button);
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-button-hover);
        }

        .btn-save:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--dark-slate);
            color: var(--white);
            padding: var(--space-lg) var(--space-2xl);
            border-radius: var(--radius-lg);
            font-size: var(--font-sm);
            font-weight: 600;
            box-shadow: var(--shadow-card);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 300;
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.error {
            background: #DC2626;
        }

        .toast.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .form-section-title {
            font-size: var(--font-sm);
            font-weight: 700;
            color: var(--primary-blue);
            margin-top: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--secondary-blue);
        }

        /* Verificacion styles */
        .verificacion-banner {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            padding: var(--space-lg);
            background: linear-gradient(135deg, rgba(25, 116, 206, 0.08), rgba(47, 199, 184, 0.08));
            border: 1px solid rgba(25, 116, 206, 0.2);
            border-radius: var(--radius-lg);
        }

        .verificacion-banner.pendiente {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.08), rgba(255, 152, 0, 0.08));
            border-color: rgba(255, 193, 7, 0.3);
        }

        .verificacion-banner.verificado {
            background: linear-gradient(135deg, rgba(92, 130, 64, 0.08), rgba(76, 175, 80, 0.08));
            border-color: rgba(92, 130, 64, 0.3);
        }

        .verificacion-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: rgba(25, 116, 206, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            flex-shrink: 0;
        }

        .verificacion-banner.pendiente .verificacion-icon {
            background: rgba(255, 193, 7, 0.15);
            color: #F59E0B;
        }

        .verificacion-banner.verificado .verificacion-icon {
            background: rgba(92, 130, 64, 0.15);
            color: var(--accent-green);
        }

        .verificacion-content {
            flex: 1;
        }

        .verificacion-title {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-slate);
            margin-bottom: 2px;
        }

        .verificacion-desc {
            font-size: var(--font-sm);
            color: var(--neutral-gray);
        }

        .btn-verificar {
            padding: 10px 20px;
            background: var(--grad-brand-button);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-verificar:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-button);
        }

        .btn-verificar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Upload document styles */
        .upload-area {
            border: 2px dashed var(--secondary-blue);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(25, 116, 206, 0.02);
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: rgba(25, 116, 206, 0.05);
        }

        .upload-area.has-file {
            border-color: var(--accent-green);
            background: rgba(92, 130, 64, 0.05);
        }

        .upload-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto var(--space-md);
            background: var(--secondary-blue);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
        }

        .upload-text {
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--dark-slate);
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: var(--font-sm);
            color: var(--neutral-gray);
        }

        .upload-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: var(--radius-md);
            margin-top: var(--space-md);
        }

        .doc-upload-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
        }

        @media (max-width: 420px) {
            .doc-upload-row {
                grid-template-columns: 1fr;
            }
        }

        .profile-badge.pendiente {
            background: rgba(255, 193, 7, 0.18);
            border-color: rgba(255, 193, 7, 0.3);
            color: #D97706;
        }

        .profile-badge.no-verificado {
            background: rgba(220, 38, 38, 0.12);
            border-color: rgba(220, 38, 38, 0.2);
            color: #DC2626;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="page">
            <main class="page-content">
                <section class="profile-hero">
                    <div class="profile-hero-top">
                        <div class="profile-avatar" id="profileAvatar">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="profile-meta">
                            <p class="profile-email" id="greetingTime">Bienvenido</p>
                            <h1 class="profile-name" id="profileName">Usuario</h1>
                            <p class="profile-email" id="profileEmail">correo@ejemplo.com</p>
                            <span class="profile-badge">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span id="badgeVerificacion">Cuenta verificada</span>
                            </span>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <span class="metric-label">Envios realizados</span>
                            <span class="metric-value" id="statEnvios">0</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Total enviado</span>
                            <span class="metric-value" id="statTotal">$0</span>
                        </div>
                    </div>
                </section>

                <!-- Seccion Verificacion -->
                <section id="seccionVerificacion" style="display: none;">
                    <div class="verificacion-banner" id="bannerVerificacion">
                        <div class="verificacion-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                        </div>
                        <div class="verificacion-content">
                            <p class="verificacion-title" id="verificacionTitulo">Verifica tu cuenta</p>
                            <p class="verificacion-desc" id="verificacionDesc">Sube tu documento de identidad para habilitar envios</p>
                        </div>
                        <button class="btn-verificar" id="btnVerificar" onclick="abrirModalVerificacion()">Verificar</button>
                    </div>
                </section>

                <section>
                    <h3 class="section-title">Mi cuenta</h3>
                    <div class="action-card">
                        <div class="action-item" onclick="editarPerfil()">
                            <div class="action-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </div>
                            <div class="action-text">
                                <span class="action-title">Editar perfil</span>
                                <span class="action-desc">Nombre, telefono, RUT, direccion</span>
                            </div>
                            <span class="action-chevron">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="action-item" id="itemVerificarCuenta" onclick="abrirModalVerificacion()" style="display: none;">
                            <div class="action-icon" style="background: rgba(25, 116, 206, 0.12); color: var(--primary-blue);">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                    <polyline points="9 12 12 15 16 10"></polyline>
                                </svg>
                            </div>
                            <div class="action-text">
                                <span class="action-title">Verificar cuenta</span>
                                <span class="action-desc" id="descVerificarItem">Sube tu documento de identidad</span>
                            </div>
                            <span class="action-chevron">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="action-item danger" onclick="cerrarSesion()">
                            <div class="action-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                    <polyline points="16 17 21 12 16 7"></polyline>
                                    <line x1="21" y1="12" x2="9" y2="12"></line>
                                </svg>
                            </div>
                            <div class="action-text">
                                <span class="action-title">Cerrar sesion</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECCION DE REFERIDOS -->
                <section id="seccionReferidos">
                    <h3 class="section-title">&#127873; Programa de Referidos</h3>
                    
                    <!-- Mi Codigo de Referido -->
                    <div class="referido-card">
                        <div class="referido-header">
                            <div class="referido-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    <path d="M21 21v-2a4 4 0 0 0-3-3.87"></path>
                                </svg>
                            </div>
                            <div class="referido-info">
                                <h4>Tu Codigo de Referido</h4>
                                <p>Comparte y gana $10.000 CLP por cada amigo</p>
                            </div>
                        </div>
                        <div class="codigo-box">
                            <span class="codigo-valor" id="miCodigoReferido">Cargando...</span>
                            <button class="btn-copiar" onclick="copiarCodigoReferido()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                Copiar
                            </button>
                        </div>
                        <button class="btn-compartir" onclick="compartirCodigoReferido()">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            Compartir con amigos
                        </button>
                    </div>

                    <!-- Aplicar Codigo (si no tiene referidor) -->
                    <div class="referido-card" id="cardAplicarCodigo" style="display: none;">
                        <div class="referido-header">
                            <div class="referido-icon" style="background: rgba(92, 130, 64, 0.12); color: #5C8240;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <div class="referido-info">
                                <h4>&#191;Tienes un codigo de referido?</h4>
                                <p>Ingresalo aqui para desbloquear tu Tasa Preferencial</p>
                            </div>
                        </div>
                        <div class="input-codigo-wrapper">
                            <input type="text" id="inputCodigoReferido" placeholder="Ej: JUA4F2B1" maxlength="10" class="input-codigo">
                            <button class="btn-aplicar" onclick="aplicarCodigoReferido()">Aplicar</button>
                        </div>
                        <p class="referido-nota" id="notaReferidor"></p>
                    </div>

                    <!-- Ya tiene referidor -->
                    <div class="referido-card referido-activo" id="cardReferidoPor" style="display: none;">
                        <div class="referido-header">
                            <div class="referido-icon" style="background: rgba(92, 130, 64, 0.12); color: #5C8240;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </div>
                            <div class="referido-info">
                                <h4>Fuiste referido por</h4>
                                <p id="nombreReferidor">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Mis Referidos -->
                    <div class="referido-card" id="cardMisReferidos">
                        <div class="referido-header" onclick="toggleMisReferidos()">
                            <div class="referido-icon" style="background: rgba(249, 115, 22, 0.12); color: #F97316;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                            </div>
                            <div class="referido-info">
                                <h4>Mis Referidos</h4>
                                <p id="statsReferidos">0 referidos - $0 ganado</p>
                            </div>
                            <span class="action-chevron" id="chevronReferidos">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </span>
                        </div>
                        <div class="referidos-lista" id="listaReferidos" style="display: none;">
                            <!-- Lista de referidos se carga dinamicamente -->
                        </div>
                    </div>
                </section>

                <div class="version-box">
                    Defi Oracle v1.0.0 - 2024
                </div>
            </main>

            <nav class="glass-nav">
                <a href="home.html" class="glass-nav-item">
                    <span class="icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </span>
                    <span class="label">Inicio</span>
                </a>
                <a href="destinatarios.html" class="glass-nav-item">
                    <span class="icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </span>
                    <span class="label">Destinatarios</span>
                </a>
                <a href="enviar.html" class="glass-nav-fab">
                    <div class="glass-nav-fab-button">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </div>
                    <span class="label">Enviar</span>
                </a>
                <a href="soporte.html" class="glass-nav-item">
                    <span class="icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </span>
                    <span class="label">Soporte</span>
                </a>
                <a href="perfil.html" class="glass-nav-item active">
                    <span class="icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </span>
                    <span class="label">Perfil</span>
                </a>
            </nav>
        </div>

        <!-- Modal Editar Perfil -->
        <div class="modal-overlay" id="modalEditarPerfil">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">Editar Perfil</h2>
                    <button class="modal-close" onclick="cerrarModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Foto de perfil -->
                    <div class="form-group">
                        <label class="form-label">Foto de perfil</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatarPreview">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <div class="avatar-actions">
                                <input type="file" id="inputFoto" accept="image/*" style="display: none;" onchange="previsualizarFoto(event)">
                                <button class="btn-upload" onclick="document.getElementById('inputFoto').click()">
                                    Cambiar foto
                                </button>
                                <span class="avatar-hint">JPG, PNG. Max 2MB</span>
                            </div>
                        </div>
                    </div>

                    <!-- Nombre completo -->
                    <div class="form-group">
                        <label class="form-label">Nombre completo *</label>
                        <input type="text" class="form-input" id="inputNombre" placeholder="Tu nombre completo">
                    </div>

                    <!-- Email (solo lectura) -->
                    <div class="form-group">
                        <label class="form-label">Correo electronico</label>
                        <input type="email" class="form-input" id="inputEmail" placeholder="correo@ejemplo.com" disabled>
                    </div>

                    <p class="form-section-title">Documento de identidad</p>

                    <!-- Tipo y numero de documento -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo *</label>
                            <select class="form-select" id="inputDocTipo">
                                <option value="">Seleccionar</option>
                                <option value="rut">RUT (Chile)</option>
                                <option value="dni">DNI</option>
                                <option value="pasaporte">Pasaporte</option>
                                <option value="cedula">Cedula</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Numero *</label>
                            <input type="text" class="form-input" id="inputDocNumero" placeholder="12.345.678-9">
                        </div>
                    </div>

                    <p class="form-section-title">Contacto y ubicacion</p>

                    <!-- Telefono -->
                    <div class="form-group">
                        <label class="form-label">Telefono *</label>
                        <input type="tel" class="form-input" id="inputTelefono" placeholder="+56 9 1234 5678">
                    </div>

                    <!-- Pais y Ciudad -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pais *</label>
                            <select class="form-select" id="inputPais">
                                <option value="">Seleccionar</option>
                                <option value="Chile">Chile</option>
                                <option value="Venezuela">Venezuela</option>
                                <option value="Peru">Peru</option>
                                <option value="Colombia">Colombia</option>
                                <option value="Argentina">Argentina</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ciudad</label>
                            <input type="text" class="form-input" id="inputCiudad" placeholder="Santiago">
                        </div>
                    </div>

                    <!-- Direccion -->
                    <div class="form-group">
                        <label class="form-label">Direccion</label>
                        <input type="text" class="form-input" id="inputDireccion" placeholder="Calle, numero, comuna">
                    </div>

                    <!-- Fecha de nacimiento -->
                    <div class="form-group">
                        <label class="form-label">Fecha de nacimiento</label>
                        <input type="date" class="form-input" id="inputFechaNac">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                    <button class="btn-save" id="btnGuardar" onclick="guardarPerfil()">Guardar cambios</button>
                </div>
            </div>
        </div>

        <!-- Modal Verificacion de Cuenta -->
        <div class="modal-overlay" id="modalVerificacion">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">Verificar Cuenta</h2>
                    <button class="modal-close" onclick="cerrarModalVerificacion()">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="font-size: var(--font-sm); color: var(--neutral-gray); margin-bottom: var(--space-xl);">
                        Sube fotos de tu documento de identidad por ambos lados para verificar tu cuenta y habilitar envios.
                    </p>

                    <div class="doc-upload-row">
                        <!-- Frente del documento -->
                        <div class="form-group">
                            <label class="form-label">Frente del documento *</label>
                            <div class="upload-area" id="uploadFrente" onclick="document.getElementById('inputDocFrente').click()">
                                <input type="file" id="inputDocFrente" accept="image/*" style="display: none;" onchange="previsualizarDoc('frente', event)">
                                <div class="upload-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                </div>
                                <p class="upload-text">Subir imagen</p>
                                <p class="upload-hint">JPG, PNG. Max 5MB</p>
                                <img id="previewFrente" class="upload-preview" style="display: none;">
                            </div>
                        </div>

                        <!-- Reverso del documento -->
                        <div class="form-group">
                            <label class="form-label">Reverso del documento *</label>
                            <div class="upload-area" id="uploadReverso" onclick="document.getElementById('inputDocReverso').click()">
                                <input type="file" id="inputDocReverso" accept="image/*" style="display: none;" onchange="previsualizarDoc('reverso', event)">
                                <div class="upload-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                </div>
                                <p class="upload-text">Subir imagen</p>
                                <p class="upload-hint">JPG, PNG. Max 5MB</p>
                                <img id="previewReverso" class="upload-preview" style="display: none;">
                            </div>
                        </div>
                    </div>

                    <div style="background: rgba(25, 116, 206, 0.06); border-radius: var(--radius-md); padding: var(--space-lg); margin-top: var(--space-lg);">
                        <p style="font-size: var(--font-xs); color: var(--neutral-gray); display: flex; align-items: flex-start; gap: 8px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            Tu documento sera revisado por nuestro equipo. El proceso puede tardar hasta 24 horas habiles.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="cerrarModalVerificacion()">Cancelar</button>
                    <button class="btn-save" id="btnEnviarVerificacion" onclick="enviarVerificacion()">Enviar documentos</button>
                </div>
            </div>
        </div>

        <!-- Toast notificacion -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        const API_BASE = window.API_BASE_URL || '';
        let docFrente = null;
        let docReverso = null;

        document.addEventListener('DOMContentLoaded', () => {
            verificarSesion();
            cargarPerfil();
            cargarEstadisticas();
            pintarSaludo();
            verificarEstadoVerificacion();
        });

        function pintarSaludo() {
            const greetingEl = document.getElementById('greetingTime');
            if (!greetingEl) return;
            const hour = new Date().getHours();
            let saludo = 'Buenas noches';
            if (hour >= 5 && hour < 12) saludo = 'Buenos dias';
            else if (hour >= 12 && hour < 19) saludo = 'Buenas tardes';
            greetingEl.textContent = saludo;
        }

        async function verificarSesion() {
            const token = localStorage.getItem('clienteToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/api/cliente/auth/verificar`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!resp.ok) {
                    throw new Error('Sesion invalida');
                }
            } catch (err) {
                localStorage.removeItem('clienteToken');
                localStorage.removeItem('clienteData');
                window.location.href = 'login.html';
            }
        }

        async function cargarPerfil() {
            const token = localStorage.getItem('clienteToken');
            try {
                const response = await fetch(`${API_BASE}/api/cliente/perfil`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('clienteData', JSON.stringify(data));
                    mostrarPerfil(data);
                } else {
                    mostrarPerfilLocal();
                }
            } catch {
                mostrarPerfilLocal();
            }
        }

        function mostrarPerfil(data) {
            document.getElementById('profileName').textContent = data.nombre || 'Usuario';
            document.getElementById('profileEmail').textContent = data.email || '';

            const avatarEl = document.getElementById('profileAvatar');
            if (data.foto_url) {
                avatarEl.innerHTML = `<img src="${data.foto_url}" alt="Avatar">`;
            } else if (data.nombre) {
                const initials = data.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                avatarEl.innerHTML = initials;
                avatarEl.style.fontSize = '32px';
            }
        }

        function mostrarPerfilLocal() {
            const userData = JSON.parse(localStorage.getItem('clienteData') || '{}');
            mostrarPerfil(userData);
        }

        async function cargarEstadisticas() {
            const token = localStorage.getItem('clienteToken');
            try {
                const response = await fetch(`${API_BASE}/api/cliente/estadisticas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statEnvios').textContent = data.total_envios || 0;
                    document.getElementById('statTotal').textContent = `$${(data.total_enviado || 0).toLocaleString('es-CL')}`;
                }
            } catch {
                document.getElementById('statEnvios').textContent = '0';
                document.getElementById('statTotal').textContent = '$0';
            }
        }

        let fotoSeleccionada = null;

        function editarPerfil() {
            const modal = document.getElementById('modalEditarPerfil');
            const userData = JSON.parse(localStorage.getItem('clienteData') || '{}');
            
            // Rellenar todos los campos del formulario
            document.getElementById('inputNombre').value = userData.nombre || '';
            document.getElementById('inputEmail').value = userData.email || '';
            document.getElementById('inputDocTipo').value = userData.documento_tipo || '';
            document.getElementById('inputDocNumero').value = userData.documento_numero || '';
            document.getElementById('inputTelefono').value = userData.telefono || '';
            document.getElementById('inputPais').value = userData.pais || '';
            document.getElementById('inputCiudad').value = userData.ciudad || '';
            document.getElementById('inputDireccion').value = userData.direccion || '';
            document.getElementById('inputFechaNac').value = userData.fecha_nacimiento || '';
            
            // Avatar preview
            const avatarPreview = document.getElementById('avatarPreview');
            if (userData.foto_url) {
                avatarPreview.innerHTML = `<img src="${userData.foto_url}" alt="Avatar">`;
            } else if (userData.nombre) {
                const initials = userData.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                avatarPreview.innerHTML = initials;
                avatarPreview.style.fontSize = '28px';
            } else {
                avatarPreview.innerHTML = `<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
            }
            
            fotoSeleccionada = null;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function cerrarModal() {
            const modal = document.getElementById('modalEditarPerfil');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            fotoSeleccionada = null;
        }

        function previsualizarFoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                mostrarToast('La imagen no puede superar 2MB', 'error');
                return;
            }

            if (!file.type.startsWith('image/')) {
                mostrarToast('Solo se permiten imagenes', 'error');
                return;
            }

            fotoSeleccionada = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        }

        async function guardarPerfil() {
            const btn = document.getElementById('btnGuardar');
            const token = localStorage.getItem('clienteToken');
            
            // Obtener valores del formulario
            const nombre = document.getElementById('inputNombre').value.trim();
            const telefono = document.getElementById('inputTelefono').value.trim();
            const documento_tipo = document.getElementById('inputDocTipo').value;
            const documento_numero = document.getElementById('inputDocNumero').value.trim();
            const pais = document.getElementById('inputPais').value;
            const ciudad = document.getElementById('inputCiudad').value.trim();
            const direccion = document.getElementById('inputDireccion').value.trim();
            const fecha_nacimiento = document.getElementById('inputFechaNac').value;

            // Validaciones
            if (!nombre) {
                mostrarToast('El nombre es requerido', 'error');
                return;
            }
            if (!telefono) {
                mostrarToast('El telefono es requerido', 'error');
                return;
            }
            if (!documento_tipo) {
                mostrarToast('Selecciona el tipo de documento', 'error');
                return;
            }
            if (!documento_numero) {
                mostrarToast('El numero de documento es requerido', 'error');
                return;
            }
            if (!pais) {
                mostrarToast('Selecciona tu pais', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Guardando...';

            try {
                // Enviar como JSON al servidor
                const response = await fetch(`${API_BASE}/api/cliente/perfil`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre,
                        telefono,
                        documento_tipo,
                        documento_numero,
                        pais,
                        ciudad,
                        direccion,
                        fecha_nacimiento
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Actualizar localStorage con datos del servidor
                    if (result.usuario) {
                        localStorage.setItem('clienteData', JSON.stringify(result.usuario));
                        mostrarPerfil(result.usuario);
                    }
                    cerrarModal();
                    mostrarToast('Perfil actualizado correctamente', 'success');
                } else {
                    mostrarToast(result.error || 'Error al guardar', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error de conexion. Intenta de nuevo.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Guardar cambios';
            }
        }

        function mostrarToast(mensaje, tipo = '') {
            const toast = document.getElementById('toast');
            toast.textContent = mensaje;
            toast.className = 'toast ' + tipo;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        document.getElementById('modalEditarPerfil').addEventListener('click', function(e) {
            if (e.target === this) cerrarModal();
        });

        document.getElementById('modalVerificacion').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalVerificacion();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarModal();
                cerrarModalVerificacion();
            }
        });

        // =============================================
        // FUNCIONES DE VERIFICACION DE CUENTA
        // =============================================

        async function verificarEstadoVerificacion() {
            const token = localStorage.getItem('clienteToken');
            try {
                const response = await fetch(`${API_BASE}/api/cliente/verificacion/estado`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    actualizarUIVerificacion(data.estado);
                }
            } catch (error) {
                console.error('Error verificando estado:', error);
            }
        }

        function actualizarUIVerificacion(estado) {
            const badge = document.querySelector('.profile-badge');
            const seccionVerif = document.getElementById('seccionVerificacion');
            const bannerVerif = document.getElementById('bannerVerificacion');
            const itemVerificar = document.getElementById('itemVerificarCuenta');
            const badgeTexto = document.getElementById('badgeVerificacion');

            // Estados: 'no_verificado', 'pendiente', 'verificado', 'rechazado'
            switch (estado) {
                case 'verificado':
                    badge.className = 'profile-badge';
                    badge.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg> Cuenta verificada`;
                    seccionVerif.style.display = 'none';
                    if (itemVerificar) itemVerificar.style.display = 'none';
                    break;

                case 'pendiente':
                    badge.className = 'profile-badge pendiente';
                    badge.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Verificacion en proceso`;
                    seccionVerif.style.display = 'block';
                    bannerVerif.className = 'verificacion-banner pendiente';
                    document.getElementById('verificacionTitulo').textContent = 'Verificacion en proceso';
                    document.getElementById('verificacionDesc').textContent = 'Estamos revisando tus documentos. Te notificaremos pronto.';
                    document.getElementById('btnVerificar').style.display = 'none';
                    if (itemVerificar) {
                        itemVerificar.style.display = 'flex';
                        document.getElementById('descVerificarItem').textContent = 'En proceso de revision';
                        itemVerificar.onclick = null;
                        itemVerificar.style.cursor = 'default';
                    }
                    break;

                case 'rechazado':
                    badge.className = 'profile-badge no-verificado';
                    badge.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg> Verificacion rechazada`;
                    seccionVerif.style.display = 'block';
                    bannerVerif.className = 'verificacion-banner';
                    document.getElementById('verificacionTitulo').textContent = 'Documentos rechazados';
                    document.getElementById('verificacionDesc').textContent = 'Por favor sube nuevamente tus documentos';
                    document.getElementById('btnVerificar').style.display = 'block';
                    document.getElementById('btnVerificar').textContent = 'Reintentar';
                    if (itemVerificar) {
                        itemVerificar.style.display = 'flex';
                        document.getElementById('descVerificarItem').textContent = 'Sube nuevamente tus documentos';
                    }
                    break;

                default: // no_verificado
                    badge.className = 'profile-badge no-verificado';
                    badge.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> Sin verificar`;
                    seccionVerif.style.display = 'block';
                    bannerVerif.className = 'verificacion-banner';
                    document.getElementById('verificacionTitulo').textContent = 'Verifica tu cuenta';
                    document.getElementById('verificacionDesc').textContent = 'Sube tu documento de identidad para habilitar envios';
                    document.getElementById('btnVerificar').style.display = 'block';
                    document.getElementById('btnVerificar').textContent = 'Verificar';
                    if (itemVerificar) {
                        itemVerificar.style.display = 'flex';
                        document.getElementById('descVerificarItem').textContent = 'Sube tu documento de identidad';
                    }
                    break;
            }
        }

        function abrirModalVerificacion() {
            const modal = document.getElementById('modalVerificacion');
            // Reset previews
            docFrente = null;
            docReverso = null;
            document.getElementById('previewFrente').style.display = 'none';
            document.getElementById('previewReverso').style.display = 'none';
            document.getElementById('uploadFrente').classList.remove('has-file');
            document.getElementById('uploadReverso').classList.remove('has-file');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function cerrarModalVerificacion() {
            const modal = document.getElementById('modalVerificacion');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        function previsualizarDoc(lado, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                mostrarToast('La imagen no puede superar 5MB', 'error');
                return;
            }

            if (!file.type.startsWith('image/')) {
                mostrarToast('Solo se permiten imagenes', 'error');
                return;
            }

            if (lado === 'frente') {
                docFrente = file;
            } else {
                docReverso = file;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(lado === 'frente' ? 'previewFrente' : 'previewReverso');
                const uploadArea = document.getElementById(lado === 'frente' ? 'uploadFrente' : 'uploadReverso');
                preview.src = e.target.result;
                preview.style.display = 'block';
                uploadArea.classList.add('has-file');
            };
            reader.readAsDataURL(file);
        }

        async function enviarVerificacion() {
            if (!docFrente || !docReverso) {
                mostrarToast('Debes subir ambas caras del documento', 'error');
                return;
            }

            const btn = document.getElementById('btnEnviarVerificacion');
            const token = localStorage.getItem('clienteToken');

            btn.disabled = true;
            btn.textContent = 'Enviando...';

            try {
                const formData = new FormData();
                formData.append('doc_frente', docFrente);
                formData.append('doc_reverso', docReverso);

                const response = await fetch(`${API_BASE}/api/cliente/verificacion/solicitar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    cerrarModalVerificacion();
                    mostrarToast('Documentos enviados. Te notificaremos cuando sean revisados.', 'success');
                    actualizarUIVerificacion('pendiente');
                } else {
                    mostrarToast(result.error || 'Error al enviar documentos', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error de conexion. Intenta de nuevo.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Enviar documentos';
            }
        }

        // =================================================================
        // FUNCIONES DE REFERIDOS
        // =================================================================
        
        let miCodigoReferido = '';
        let misReferidosData = [];

        async function cargarDatosReferidos() {
            const token = localStorage.getItem('clienteToken');
            
            try {
                // Cargar mi codigo de referido
                const resCodigo = await fetch(`${API_BASE}/api/cliente/referidos/mi-codigo`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (resCodigo.ok) {
                    const dataCodigo = await resCodigo.json();
                    miCodigoReferido = dataCodigo.codigo;
                    document.getElementById('miCodigoReferido').textContent = dataCodigo.codigo;
                }

                // Verificar si ya tiene referidor
                const resReferidor = await fetch(`${API_BASE}/api/cliente/referidos/mi-referidor`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (resReferidor.ok) {
                    const dataReferidor = await resReferidor.json();
                    if (dataReferidor.tiene_referidor) {
                        document.getElementById('cardAplicarCodigo').style.display = 'none';
                        document.getElementById('cardReferidoPor').style.display = 'block';
                        document.getElementById('nombreReferidor').textContent = dataReferidor.referidor;
                    } else {
                        document.getElementById('cardAplicarCodigo').style.display = 'block';
                        document.getElementById('cardReferidoPor').style.display = 'none';
                    }
                }

                // Cargar mis referidos
                const resReferidos = await fetch(`${API_BASE}/api/cliente/referidos/mis-referidos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (resReferidos.ok) {
                    const dataReferidos = await resReferidos.json();
                    misReferidosData = dataReferidos.referidos;
                    actualizarUIReferidos(dataReferidos);
                }
            } catch (error) {
                console.error('Error cargando datos de referidos:', error);
            }
        }

        function actualizarUIReferidos(data) {
            const stats = data.estadisticas;
            let statsText = `${stats.total_referidos} referido${stats.total_referidos !== 1 ? 's' : ''}`;
            
            // Mostrar total por cobrar o ganado
            const totalPorCobrar = stats.total_por_cobrar || 0;
            const totalGanado = stats.total_ganado || 0;
            
            if (totalPorCobrar > 0) {
                statsText += ` - $${totalPorCobrar.toLocaleString('es-CL')} por cobrar`;
            }
            if (totalGanado > 0) {
                statsText += ` - $${totalGanado.toLocaleString('es-CL')} cobrado`;
            }
            if (totalPorCobrar === 0 && totalGanado === 0) {
                statsText += ` - $0 ganado`;
            }
            
            document.getElementById('statsReferidos').textContent = statsText;

            const listaEl = document.getElementById('listaReferidos');
            
            if (data.referidos.length === 0) {
                listaEl.innerHTML = `
                    <div class="referidos-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <p>Aun no tienes referidos</p>
                        <p style="font-size: 12px;">Comparte tu codigo para empezar a ganar</p>
                    </div>
                `;
                return;
            }

            listaEl.innerHTML = data.referidos.map(r => {
                const initials = r.nombre.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const estadoClass = r.cupon_usado ? 'usado' : r.estado_bono;
                let estadoText = {
                    'pendiente': 'En progreso',
                    'completado': 'Bono listo',
                    'reclamado': 'En revision',
                    'pagado': 'Cupon activo',
                    'expirado': 'Expirado',
                    'cancelado': 'Cancelado'
                }[r.estado_bono] || r.estado_bono;
                
                // Si el cupon ya fue usado, cambiar el texto
                if (r.estado_bono === 'pagado' && r.cupon_usado) {
                    estadoText = 'Cupon usado';
                }

                // Mostrar boton de reclamar solo si el bono esta completado
                const botonReclamar = r.estado_bono === 'completado' ? 
                    `<button class="btn-reclamar-bono" onclick="reclamarBono(${r.bono_id}, '${r.nombre}')">
                        &#127873; Reclamar
                    </button>` : '';
                
                // Mostrar cupon si esta pagado
                const infoCupon = r.estado_bono === 'pagado' && r.codigo_cupon ? 
                    `<div class="cupon-info" onclick="copiarCupon('${r.codigo_cupon}')">
                        <span class="cupon-codigo">&#127915; ${r.codigo_cupon}</span>
                        <small>Toca para copiar</small>
                    </div>` : '';

                return `
                    <div class="referido-item ${r.estado_bono === 'cancelado' ? 'cancelado' : ''}">
                        <div class="referido-avatar">${initials}</div>
                        <div class="referido-detalle">
                            <div class="referido-nombre">${r.nombre}</div>
                            <div class="referido-progreso-wrapper">
                                <div class="referido-progreso-bar">
                                    <div class="referido-progreso-fill" style="width: ${r.progreso}%"></div>
                                </div>
                                <span class="referido-progreso-text">${r.progreso}%</span>
                            </div>
                            ${infoCupon}
                        </div>
                        <div class="referido-acciones">
                            <span class="referido-estado ${estadoClass}">${estadoText}</span>
                            ${botonReclamar}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function reclamarBono(bonoId, nombreReferido) {
            if (!confirm('Deseas reclamar el bono por referir a ' + nombreReferido + '?\\n\\nEl equipo de administracion revisara tu solicitud.')) {
                return;
            }
            
            try {
                const res = await fetch('/api/cliente/referidos/reclamar/' + bonoId, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('clienteToken')
                    }
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    mostrarToast(data.mensaje || 'Bono reclamado exitosamente', 'success');
                    cargarDatosReferidos(); // Recargar lista
                } else {
                    mostrarToast(data.error || 'Error al reclamar bono', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al reclamar bono', 'error');
            }
        }

        function copiarCupon(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                mostrarToast('Cupon copiado: ' + codigo, 'success');
            }).catch(() => {
                mostrarToast('Cupon: ' + codigo, 'info');
            });
        }

        function toggleMisReferidos() {
            const lista = document.getElementById('listaReferidos');
            const chevron = document.getElementById('chevronReferidos');
            
            if (lista.style.display === 'none') {
                lista.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
            } else {
                lista.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function copiarCodigoReferido() {
            if (!miCodigoReferido) return;
            
            navigator.clipboard.writeText(miCodigoReferido).then(() => {
                mostrarToast('Codigo copiado al portapapeles', 'success');
            }).catch(() => {
                // Fallback para navegadores sin clipboard API
                const input = document.createElement('input');
                input.value = miCodigoReferido;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                mostrarToast('Codigo copiado al portapapeles', 'success');
            });
        }

        function compartirCodigoReferido() {
            if (!miCodigoReferido) return;
            
            const mensaje = `Ey  Si vas a enviar dinero, hazlo por Defi Oracle: defioracleapp.com\nUsa mi codigo ${miCodigoReferido}.\nCuando superes $100.000 CLP enviados (puede ser en varias transacciones), se activa el bono del referido.\nTu aprovechas una excelente tasa para que te llegue mas dinero y un buen servicio, y yo recibo el bono `;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Defi Oracle - Codigo de Referido',
                    text: mensaje
                }).catch(() => {});
            } else {
                // Fallback: copiar mensaje
                navigator.clipboard.writeText(mensaje).then(() => {
                    mostrarToast('Mensaje copiado. Pegalo en WhatsApp o donde quieras', 'success');
                });
            }
        }

        async function aplicarCodigoReferido() {
            const input = document.getElementById('inputCodigoReferido');
            const codigo = input.value.trim().toUpperCase();
            
            if (!codigo) {
                mostrarToast('Ingresa un codigo de referido', 'error');
                return;
            }

            const token = localStorage.getItem('clienteToken');
            
            try {
                const response = await fetch(`${API_BASE}/api/cliente/referidos/aplicar`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ codigo })
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarToast(result.mensaje, 'success');
                    document.getElementById('cardAplicarCodigo').style.display = 'none';
                    document.getElementById('cardReferidoPor').style.display = 'block';
                    document.getElementById('nombreReferidor').textContent = result.referidor;
                } else {
                    mostrarToast(result.error || 'Codigo no valido', 'error');
                }
            } catch (error) {
                console.error('Error aplicando codigo:', error);
                mostrarToast('Error de conexion. Intenta de nuevo.', 'error');
            }
        }

        // Cargar datos de referidos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatosReferidos();
        });

        function cerrarSesion() {
            localStorage.removeItem('clienteToken');
            localStorage.removeItem('clienteData');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>