<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1974CE">
  <title>Enviar dinero ¬∑ Defi Oracle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    window.API_BASE_URL = window.API_BASE_URL || 'https://defisistema-interno.onrender.com';
  </script>
  <style>
    :root {
      --primary: #1974CE;
      --primary-strong: #145DA6;
      --accent: #5C8240;
      --bg: #E3EAEE;
      --panel: #FFFFFF;
      --panel-2: #F8FAFC;
      --border: #D8E2E9;
      --text: #211C10;
      --text-dim: #64748B;
      --muted: #9AA1A1;
      --success: #4ADE80;
      --warning: #FBBF24;
      --danger: #EF4444;
      --neon: #00F6FF;
      --neon-glow: rgba(0, 246, 255, 0.4);
      --brand-teal: #23C6B8;
      --brand-teal-soft: rgba(35, 198, 184, 0.14);
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 18px;
      --radius-xl: 22px;
      --shadow-1: 0 20px 60px rgba(14, 77, 157, 0.08);
      --shadow-2: 0 12px 36px rgba(14, 77, 157, 0.06);
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 32px;
      --space-8: 40px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .app-shell {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: var(--space-5) var(--space-5) 110px;
    }
    header.topbar {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-4);
      background: linear-gradient(120deg, #1974CE 0%, #145DA6 52%, #0C3C7C 70%, #23C6B8 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2);
      position: sticky;
      top: var(--space-4);
      z-index: 10;
      backdrop-filter: blur(12px);
    }
    .back-btn {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.2s ease;
    }
    .back-btn:hover { transform: translateY(-1px); border-color: var(--primary); }
    .titles h1 { margin: 0; font-size: 18px; letter-spacing: -0.01em; }
    .titles p { margin: 2px 0 0; color: var(--muted); font-size: 13px; }

    .btn-primary {
      width: 100%;
      min-height: 54px;
      border: none;
      border-radius: 16px;
      background: linear-gradient(120deg, #1974CE 0%, #145DA6 52%, #0C3C7C 70%, #23C6B8 100%);
      color: #FFFFFF;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      position: relative;
      z-index: 0;
      overflow: hidden;
      box-shadow: 0 16px 34px rgba(25, 116, 206, 0.28);
      transition: transform 0.12s ease, box-shadow 0.2s ease, filter 0.2s ease, opacity 0.2s ease;
    }
    .btn-primary::before {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: 14px;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.18) 0%, rgba(216, 226, 233, 0.08) 60%, rgba(92, 130, 64, 0.16) 100%);
      opacity: 0.85;
      z-index: -1;
      transition: opacity 0.2s ease;
    }
    .btn-primary::after {
      content: "";
      position: absolute;
      top: -120%;
      left: -20%;
      width: 200%;
      height: 140%;
      background: radial-gradient(circle at center, rgba(255,255,255,0.28) 0%, rgba(255,255,255,0) 60%);
      opacity: 0;
      transform: rotate(12deg);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: -2;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 48px rgba(25, 116, 206, 0.35);
      filter: brightness(1.04);
    }
    .btn-primary:hover::after {
      opacity: 1;
      transform: rotate(0deg);
    }
    .btn-primary:active {
      transform: translateY(1px);
      filter: brightness(0.95);
      box-shadow: 0 12px 24px rgba(12, 60, 124, 0.45);
    }
    .btn-primary:disabled {
      background: linear-gradient(135deg, rgba(216, 226, 233, 0.92) 0%, rgba(227, 234, 238, 0.92) 100%);
      color: #9AA1A1;
      cursor: not-allowed;
      box-shadow: 0 6px 14px rgba(148, 163, 184, 0.25);
      filter: none;
    }
    .btn-primary:disabled::before { opacity: 0.35; }
    .btn-primary:disabled::after { opacity: 0; }

    .progress {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
      margin: var(--space-4) 0 var(--space-5);
    }
    .progress .step {
      height: 5px;
      border-radius: 999px;
      background: #E2E8F0;
      position: relative;
      overflow: hidden;
    }
    .progress .step::after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-100%);
      background: linear-gradient(90deg, var(--primary), var(--neon), var(--primary));
      transition: transform 0.25s ease;
    }
    .progress .step.active::after { transform: translateX(0); }
    .progress .step.done { background: var(--brand-teal); }

    .card {
      background: var(--panel);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      transition: box-shadow 0.3s ease;
    }

    #step1.card {
      background: linear-gradient(160deg, #FFFFFF 0%, rgba(216, 226, 233, 0.35) 45%, rgba(25, 116, 206, 0.06) 100%);
      border-radius: 20px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(25, 116, 206, 0.08);
      display: grid;
      gap: var(--space-4);
    }
    .card-title { margin: 0 0 6px; font-size: 16px; font-weight: 600; }
    .card-sub { margin: 0 0 18px; color: var(--text-dim); font-size: 13px; }
    #step1 .card-title { margin-bottom: 0; }
    #step1 .card-sub { margin-bottom: 0; }

    .field {
      display: grid;
      gap: 6px;
      margin-bottom: var(--space-4);
    }
    #step1 .field { margin-bottom: 0; }
    .label-row {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .input-shell {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: #FFFFFF;
      border-radius: 16px;
      padding: 14px 18px;
      min-height: 56px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }
    .input-shell:hover {
      border-color: rgba(35, 198, 184, 0.32);
    }
    .input-shell:focus-within {
      border-color: var(--brand-teal);
      box-shadow: 0 0 0 3px rgba(35, 198, 184, 0.12);
    }
    .label-flag {
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }
    .label-flag span {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.4px;
      color: var(--text);
    }
    .input-shell input {
      background: transparent;
      border: none;
      color: var(--text);
      padding: 0;
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
      text-align: right;
      outline: none;
      width: 100%;
    }
    .input-with-flag {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
      gap: 12px;
    }

    .flag-inline {
      font-size: 18px;
      opacity: 0.9;
    }

    .flag-icon {
      width: 22px;
      height: 16px;
      border-radius: 3px;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
      flex-shrink: 0;
      display: inline-block;
      object-fit: cover;
    }

    .tasa-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #EFF6FF;
      border: 1px solid #BFDBFE;
      border-radius: 999px;
      color: var(--primary);
      font-size: 13px;
      width: fit-content;
      margin: 0;
    }


    .method-grid { display: grid; gap: 12px; }
    .method-card {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #FFFFFF;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.12s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    .method-card:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
    .method-card.active { 
      border-color: var(--brand-teal); 
      background: var(--brand-teal-soft);
      box-shadow: 0 0 0 1px var(--brand-teal);
    }
    .method-card.active .method-icon {
      background: rgba(18, 184, 196, 0.16);
      border-color: rgba(18, 184, 196, 0.35);
      color: var(--brand-teal);
    }
    .method-icon {
      width: 46px; height: 46px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: #EFF6FF;
      border: 1px solid #BFDBFE;
      color: var(--primary);
      font-size: 20px;
    }
    .method-text h4 { margin: 0 0 4px; font-size: 15px; }
    .method-text p { margin: 0; color: var(--muted); font-size: 13px; }
    .badge { padding: 6px 10px; border-radius: 12px; font-size: 12px; }
    .badge.green { background: var(--brand-teal-soft); color: var(--brand-teal); border: 1px solid rgba(18, 184, 196, 0.28); }

    .recipient-search {
      position: relative;
    }
    .recipient-search input {
      width: 100%;
      padding: 12px 14px 12px 42px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      color: var(--text);
      outline: none;
    }
    .recipient-search span {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 16px;
    }
    .recipient-list { margin-top: 14px; display: grid; gap: 10px; max-height: 360px; overflow-y: auto; }
    .recipient-card {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--panel-2);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .recipient-card.active { border-color: var(--brand-teal); background: var(--brand-teal-soft); }
    .avatar {
      width: 44px; height: 44px;
      border-radius: 14px;
      background: #EFF6FF;
      border: 1px solid #BFDBFE;
      display: grid;
      place-items: center;
      font-weight: 700;
      color: var(--primary);
    }
    .add-recipient {
      border: 1px dashed var(--border);
      background: var(--panel-2);
      padding: 14px;
      border-radius: var(--radius-lg);
      text-align: center;
      color: var(--primary);
      cursor: pointer;
      transition: border-color 0.2s ease;
    }
    .add-recipient:hover { border-color: var(--primary); }

    .summary-card {
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-1);
    }
    .summary-head {
      background: linear-gradient(135deg, var(--primary), var(--primary-strong));
      padding: var(--space-6);
      color: #FFFFFF;
      text-align: center;
    }
    .summary-head .label { font-size: 12px; opacity: 0.9; }
    .summary-head .amount { font-size: 30px; font-weight: 800; margin: 6px 0 0; }
    .summary-body { padding: var(--space-6); display: grid; gap: 12px; }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .row:last-child { border-bottom: none; padding-bottom: 0; }
    .row .label { color: var(--text-dim); font-size: 13px; }
    .row .value { font-weight: 600; }
    .highlight {
      background: var(--brand-teal-soft);
      border: 1px solid rgba(18, 184, 196, 0.32);
      border-radius: var(--radius-md);
      padding: 12px 14px;
    }

    .timer {
      text-align: center;
      padding: 16px;
      border-radius: var(--radius-lg);
      background: #EFF6FF;
      border: 1px solid #BFDBFE;
      color: var(--primary);
      font-weight: 600;
      margin-bottom: var(--space-4);
    }
    .pay-card .detail { margin-bottom: 14px; }
    .detail .label { color: var(--muted); font-size: 13px; margin-bottom: 6px; }
    .detail .value {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      font-weight: 600;
    }
    .copy {
      background: #EFF6FF;
      border: 1px solid #BFDBFE;
      color: var(--primary);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    .alert {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      background: #FFFBEB;
      border: 1px solid #FDE68A;
      color: #B45309;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      font-size: 13px;
      margin-top: 4px;
    }

    .tracking {
      text-align: center;
      padding: var(--space-6);
    }
    .tracking .big { font-size: 46px; margin-bottom: 10px; }
    .track-code {
      display: inline-block;
      background: #EFF6FF;
      border: 1px solid #BFDBFE;
      padding: 10px 16px;
      border-radius: 12px;
      color: var(--primary);
      font-weight: 700;
      letter-spacing: 0.4px;
      margin: 12px 0 20px;
    }
    .timeline { margin-top: 12px; display: grid; gap: 12px; text-align: left; }
    .tl-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      position: relative;
      padding-bottom: 12px;
    }
    .tl-item:not(:last-child)::after {
      content: "";
      position: absolute;
      left: 11px;
      top: 24px;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }
    .dot {
      width: 24px; height: 24px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: var(--border);
      color: var(--text);
      font-size: 12px;
    }
    .tl-item.done .dot { background: var(--brand-teal); color: white; }
    .tl-item.active .dot { background: var(--primary); color: white; animation: pulse 1.6s infinite; }
    .tl-body p { margin: 0; }
    .tl-body .title { font-weight: 600; }
    .tl-body .time { color: var(--muted); font-size: 12px; margin-top: 4px; }

    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .footer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      max-width: 430px;
      margin: 0 auto;
      padding: var(--space-5) var(--space-5) var(--space-6);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      box-shadow: 0 -12px 35px rgba(14, 77, 157, 0.1);
    }
    .btn-secondary {
      width: 100%;
      height: 52px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 2000;
    }
    .modal {
      max-width: 420px;
      width: 100%;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-1);
      color: var(--text);
    }
    .modal h3 { margin: 0 0 10px; font-size: 18px; }
    .modal p { margin: 6px 0; color: var(--text-dim); }
    .modal .actions { display: grid; gap: 10px; margin-top: 16px; }
    .pill-danger {
      background: #FEF2F2;
      border: 1px solid #FECACA;
      color: #DC2626;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
    textarea, select { background: var(--panel-2); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="topbar">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="titles">
        <h1>Enviar dinero</h1>
      </div>
    </header>

    <div class="progress" id="progressBar">
      <div class="step active"></div>
      <div class="step"></div>
      <div class="step"></div>
      <div class="step"></div>
      <div class="step"></div>
      <div class="step"></div>
    </div>

    <!-- Paso 1: Monto -->
    <section class="card" id="step1">
      <h3 class="card-title">¬øCu√°nto quieres enviar?</h3>
      <p class="card-sub">Ingresa el monto en CLP o VES. Calculamos la tasa autom√°ticamente por tramo.</p>

      <div class="field">
        <div class="label-row">T√∫ env√≠as</div>
        <div class="input-shell">
          <div class="label-flag">
            <img class="flag-icon" alt="Chile" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='40' viewBox='0 0 60 40'%3E%3Cpath fill='%23fff' d='M0 0h60v20H0z'/%3E%3Cpath fill='%23d52b1e' d='M0 20h60v20H0z'/%3E%3Cpath fill='%2300399c' d='M0 0h20v20H0z'/%3E%3Cpath fill='%23fff' d='m10 3.5 1.175 3.613 3.787.013-3.05 2.19 1.161 3.618L10 10.68 6.927 12.94l1.16-3.618-3.05-2.19 3.788-.013z'/%3E%3C/svg%3E"/>
            <span>CLP</span>
          </div>
          <div class="input-with-flag">
            <input type="text" id="montoCLP" placeholder="0" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
          </div>
        </div>
      </div>

      <div class="field">
        <div class="label-row">Recibe</div>
        <div class="input-shell">
          <div class="label-flag">
            <img class="flag-icon" alt="Venezuela" src="assets/BANDERAVENEZUELA.svg"/>
            <span>VES</span>
          </div>
          <div class="input-with-flag">
            <input type="text" id="montoVES" placeholder="0" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
          </div>
        </div>
      </div>

      <div class="tasa-pill">Tasa: <strong id="tasaDisplay">1 CLP = 0 VES</strong></div>
    </section>

    <!-- Paso 2: M√©todo -->
    <section class="card" id="step2" style="display:none;">
      <h3 class="card-title">M√©todo de entrega</h3>
      <p class="card-sub">Elige c√≥mo deseas entregar el dinero.</p>
      <div class="method-grid">
        <div class="method-card active" data-method="transferencia" onclick="selectMethod('transferencia')">
          <div class="method-icon">üè¶</div>
          <div class="method-text">
            <h4>Transferencia bancaria</h4>
            <p>Dep√≥sito directo en cuenta</p>
          </div>
          <span class="badge green">R√°pido</span>
        </div>
        <div class="method-card" data-method="pago_movil" onclick="selectMethod('pago_movil')">
          <div class="method-icon">üì±</div>
          <div class="method-text">
            <h4>Pago M√≥vil</h4>
            <p>Llega en minutos a bancos VZLA</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Paso 3: Destinatario -->
    <section class="card" id="step3" style="display:none;">
      <h3 class="card-title">¬øA qui√©n env√≠as?</h3>
      <p class="card-sub">Selecciona o agrega un destinatario.</p>
      <div class="recipient-search">
        <span>üîç</span>
        <input type="text" id="searchRecipient" placeholder="Buscar destinatario" oninput="filtrarDestinatariosEnvio()">
      </div>
      <div class="recipient-list" id="recipientListSelect"></div>
      <div class="add-recipient" onclick="agregarNuevoDestinatario()">+ Agregar nuevo destinatario</div>
    </section>

    <!-- Paso 4: Resumen -->
    <section class="card" id="step4" style="display:none;">
      <h3 class="card-title">Confirma tu env√≠o</h3>
      <p class="card-sub">Revisa los datos antes de continuar.</p>
      <div class="summary-card">
        <div class="summary-head">
          <div class="label">T√∫ env√≠as</div>
          <div class="amount" id="resumenEnvias">$0 CLP</div>
        </div>
        <div class="summary-body">
          <div class="row"><span class="label">Destinatario</span><span class="value" id="resumenDestinatario">-</span></div>
          <div class="row"><span class="label">M√©todo</span><span class="value" id="resumenMetodo">-</span></div>
          <div class="row"><span class="label">Banco</span><span class="value" id="resumenBanco">-</span></div>
          <div class="row"><span class="label">Tasa</span><span class="value" id="resumenTasa">-</span></div>
          <div class="row"><span class="label">Comisi√≥n</span><span class="value" style="color:var(--brand-teal);">$0 CLP</span></div>
          <div class="highlight row" style="border:none; padding:0;">
            <div style="width:100%; display:flex; justify-content:space-between; padding:10px 0;">
              <span class="label" style="color:var(--text-dim);">Recibe</span>
              <span class="value" id="resumenRecibe" style="color:var(--brand-teal); font-size:18px;">Bs. 0</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Paso 5: Pago -->
    <section class="card" id="step5" style="display:none;">
      <h3 class="card-title">Realiza tu pago</h3>
      <p class="card-sub">Transfiere a la cuenta indicada.</p>
      <div class="timer">
        Tiempo restante para pagar
        <div style="font-size:28px; margin-top:6px;" id="timerValue">30:00</div>
      </div>
      <div class="card pay-card" style="padding: var(--space-5); background: var(--panel); border:1px solid var(--border);">
        <div class="detail"><div class="label">Banco</div><div class="value"><span>Banco Estado</span></div></div>
        <div class="detail"><div class="label">Tipo de cuenta</div><div class="value"><span>Cuenta Corriente</span></div></div>
        <div class="detail"><div class="label">N√∫mero de cuenta</div><div class="value"><span id="paymentCuenta">12345678901</span><button class="copy" onclick="copiar('paymentCuenta')">Copiar</button></div></div>
        <div class="detail"><div class="label">RUT</div><div class="value"><span id="paymentRut">76.XXX.XXX-X</span><button class="copy" onclick="copiar('paymentRut')">Copiar</button></div></div>
        <div class="detail"><div class="label">Nombre</div><div class="value"><span>Defi Oracle SpA</span></div></div>
        <div class="detail"><div class="label">Monto a transferir</div><div class="value"><span id="paymentMonto">$0 CLP</span><button class="copy" onclick="copiar('paymentMonto')">Copiar</button></div></div>
        <div class="alert">‚ö†Ô∏è Aseg√∫rate de transferir el monto exacto. Tu env√≠o se procesar√° al recibir el pago.</div>
      </div>
    </section>

    <!-- Paso 6: Tracking -->
    <section class="card" id="step6" style="display:none; text-align:center;">
      <div class="tracking">
        <div class="big">‚úÖ</div>
        <h3 style="margin:0 0 6px;">¬°Solicitud creada!</h3>
        <p style="color: var(--muted); margin:0 0 14px;">Te notificaremos cuando el dinero llegue.</p>
        <div class="track-code" id="trackingCode">TRX-000000</div>
        <div class="timeline">
          <div class="tl-item done">
            <div class="dot">‚úì</div>
            <div class="tl-body"><p class="title">Solicitud creada</p><p class="time" id="timeCreated">-</p></div>
          </div>
          <div class="tl-item active" id="timelinePago">
            <div class="dot">‚óè</div>
            <div class="tl-body"><p class="title">Esperando tu pago</p><p class="time">En proceso</p></div>
          </div>
          <div class="tl-item" id="timelineProceso">
            <div class="dot"></div>
            <div class="tl-body"><p class="title">Procesando env√≠o</p><p class="time">Pendiente</p></div>
          </div>
          <div class="tl-item" id="timelineEntregado">
            <div class="dot"></div>
            <div class="tl-body"><p class="title">Dinero entregado</p><p class="time">Pendiente</p></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer" id="footer">
    <button class="btn-primary" id="btnNext" onclick="nextStep()">Continuar</button>
  </div>

  <!-- Modal Compliance -->
  <div class="modal-backdrop" id="complianceModal">
    <div class="modal">
      <h3>Verificaci√≥n de cuenta</h3>
      <p><strong>No se permiten transferencias desde cuentas de terceros o cuentas empresa.</strong></p>
      <p style="margin-top:-4px;">Si detectamos que el pago no proviene de una cuenta personal a tu nombre, la transacci√≥n se cancelar√° autom√°ticamente.</p>
      <div class="actions">
        <button class="btn-primary" style="height:52px;" onclick="confirmarCuentaPropia()">‚úì S√≠, es mi cuenta personal</button>
        <button class="btn-secondary" style="height:52px;" onclick="mostrarNoEsMiCuenta()">‚úó No es mi cuenta</button>
      </div>
      <div id="noEsMiCuentaSection" style="display:none; margin-top:16px;">
        <div class="pill-danger">‚ö†Ô∏è Solo aceptamos pagos desde cuentas personales a nombre del usuario registrado.</div>
        <label style="color: var(--text); font-size:13px; margin-top:10px;">Cu√©ntanos tu situaci√≥n</label>
        <select id="motivoNoCuenta">
          <option value="">Selecciona un motivo</option>
          <option value="tercero">Pago desde cuenta de familiar/amigo</option>
          <option value="empresa">Mi cuenta es empresarial</option>
          <option value="otro_nombre">La cuenta est√° a otro nombre</option>
          <option value="otro">Otro motivo</option>
        </select>
        <textarea id="detalleNoCuenta" placeholder="Detalle adicional (opcional)" rows="3" style="margin-top:10px;"></textarea>
        <div class="actions">
          <button class="btn-primary" style="background: linear-gradient(135deg, #ef4444, #b91c1c);" onclick="cancelarPorCuenta()">Entendido, cancelar operaci√≥n</button>
          <button class="btn-secondary" onclick="volverVerificacion()">‚Üê Volver</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.API_BASE_URL || '';
    let currentStep = 1;
    let tasa = 0.045;
    let tramos = [];
    let destinatarios = [];
    let timerInterval = null;
    const envio = { montoCLP: 0, montoVES: 0, metodo: 'transferencia', destinatario: null };
    const fmtCLP = new Intl.NumberFormat('es-CL');
    const fmtVES = new Intl.NumberFormat('es-VE');

    document.addEventListener('DOMContentLoaded', () => {
      verificarSesion();
      cargarTasa();
      cargarDestinatarios();
      checkPreselection();
      updateProgressUI();
      setupNumericInput('montoCLP', updateFromCLP, fmtCLP);
      setupNumericInput('montoVES', updateFromVES, fmtVES);
      actualizarTasaDisplay();
    });

    function sanitizeInteger(value) {
      const digits = String(value ?? '').replace(/\D/g, '');
      return digits ? parseInt(digits, 10) : 0;
    }

    function setupNumericInput(id, handler, formatter) {
      const input = document.getElementById(id);
      if (!input) return;
      input.addEventListener('input', event => {
        const sanitized = sanitizeInteger(event.target.value);
        event.target.value = sanitized ? String(sanitized) : '';
        handler(sanitized, { source: 'input', element: input });
      });
      input.addEventListener('focus', event => {
        const sanitized = sanitizeInteger(event.target.value);
        event.target.value = sanitized ? String(sanitized) : '';
      });
      input.addEventListener('blur', event => {
        const sanitized = sanitizeInteger(event.target.value);
        event.target.value = sanitized ? formatter.format(sanitized) : '';
        handler(sanitized, { source: 'blur', element: input });
      });
    }

    function setCLPInputValue(value) {
      const input = document.getElementById('montoCLP');
      if (!input) return;
      if (!value) { input.value = ''; return; }
      const focused = document.activeElement === input;
      input.value = focused ? String(value) : fmtCLP.format(value);
    }

    function setVESInputValue(value) {
      const input = document.getElementById('montoVES');
      if (!input) return;
      if (!value) { input.value = ''; return; }
      const focused = document.activeElement === input;
      input.value = focused ? String(value) : fmtVES.format(value);
    }

    function updateFromCLP(value, ctx = {}) {
      const clp = Math.max(0, Math.trunc(value || 0));
      envio.montoCLP = clp;
      const tasaActual = obtenerTasaPorMonto(clp);
      const ves = Math.max(0, Math.trunc(clp * tasaActual));
      envio.montoVES = ves;
      setCLPInputValue(clp);
      setVESInputValue(ves);
      actualizarTasaDisplay();
    }

    function updateFromVES(value, ctx = {}) {
      const ves = Math.max(0, Math.trunc(value || 0));
      const input = ctx.element || document.getElementById('montoVES');
      const typing = ctx.source === 'input' && document.activeElement === input;
      const tasaBase = tramos.length > 0 ? tramos[0].tasa : tasa;
      if (!tasaBase) {
        envio.montoCLP = 0;
        envio.montoVES = ves;
        setCLPInputValue(0);
        if (!typing) setVESInputValue(ves);
        else if (input) input.value = ves ? String(ves) : '';
        actualizarTasaDisplay();
        return;
      }
      const clpEstimado = Math.max(0, Math.trunc(ves / tasaBase));
      const tasaActual = obtenerTasaPorMonto(clpEstimado);
      const vesCalculado = Math.max(0, Math.trunc(clpEstimado * tasaActual));
      envio.montoCLP = clpEstimado;
      envio.montoVES = typing && ctx.source !== 'blur' ? ves : vesCalculado;
      setCLPInputValue(clpEstimado);
      if (typing && ctx.source !== 'blur') {
        if (input) input.value = ves ? String(ves) : '';
      } else {
        setVESInputValue(vesCalculado);
      }
      actualizarTasaDisplay();
    }

    function goBack() {
      if (currentStep === 1) { window.location.href = 'home.html'; return; }
      if (currentStep === 6) { window.location.href = 'home.html'; return; }
      showStep(currentStep - 1);
    }

    async function verificarSesion() {
      const token = localStorage.getItem('clienteToken');
      if (!token) window.location.href = 'login.html';
    }

    async function cargarTasa() {
      try {
        const r = await fetch(`${API_BASE}/api/cliente/tasa`);
        if (r.ok) {
          const data = await r.json();
          tramos = data.tramos || [];
          tasa = data.tasaDefecto || 0.045;
        } else {
          tasa = 0.045; tramos = [];
        }
      } catch { tasa = 0.045; tramos = []; }
      updateFromCLP(envio.montoCLP);
    }

    function obtenerTasaPorMonto(montoCLP) {
      if (!tramos || tramos.length === 0) return tasa;
      for (let i = tramos.length - 1; i >= 0; i--) {
        if (montoCLP >= tramos[i].minCLP) return tramos[i].tasa || tasa;
      }
      return tasa;
    }

    function actualizarTasaDisplay() {
      const baseMonto = envio.montoCLP || 0;
      const t = obtenerTasaPorMonto(baseMonto);
      document.getElementById('tasaDisplay').textContent = `1 CLP = ${t.toFixed(4)} VES`;
    }

    async function cargarDestinatarios() {
      const token = localStorage.getItem('clienteToken');
      try {
        const r = await fetch(`${API_BASE}/api/cliente/beneficiarios`, { headers: { 'Authorization': `Bearer ${token}` } });
        destinatarios = r.ok ? await r.json() : getMockDestinatarios();
      } catch { destinatarios = getMockDestinatarios(); }
      renderizarDestinatariosEnvio();
    }

    function getMockDestinatarios() {
      return [
        { id: 1, alias: 'Mam√°', nombre_completo: 'Mar√≠a Garc√≠a L√≥pez', banco: 'Banco de Venezuela', codigo_banco: '0102', numero_cuenta: '01020304050607080910', telefono: '04121234567' },
        { id: 2, alias: 'Hermano', nombre_completo: 'Carlos Garc√≠a L√≥pez', banco: 'Banesco', codigo_banco: '0134', numero_cuenta: '01340987654321098765', telefono: '04241234567' }
      ];
    }

    function checkPreselection() {
      const selectedId = sessionStorage.getItem('selectedRecipientId');
      if (selectedId) {
        envio.destinatario = destinatarios.find(d => d.id == selectedId);
        sessionStorage.removeItem('selectedRecipientId');
      }
      renderizarDestinatariosEnvio();
    }

    function renderizarDestinatariosEnvio() {
      const container = document.getElementById('recipientListSelect');
      if (!container) return;
      const search = (document.getElementById('searchRecipient')?.value || '').toLowerCase();
      let filtrados = destinatarios;
      if (search) filtrados = filtrados.filter(d => d.nombre_completo.toLowerCase().includes(search) || (d.alias||'').toLowerCase().includes(search));
      container.innerHTML = filtrados.map(d => {
        const active = envio.destinatario?.id === d.id;
        return `<div class="recipient-card ${active ? 'active' : ''}" onclick="selectDestinatario(${d.id})">
          <div class="avatar">${getInitials(d.nombre_completo)}</div>
          <div>
            <div style="font-weight:700;">${d.nombre_completo} ${d.alias ? `<span style='color:${'var(--muted)'}'>(${d.alias})</span>` : ''}</div>
            <div style="color: var(--muted); font-size:12px;">${d.banco}</div>
          </div>
        </div>`;
      }).join('');
    }

    function getInitials(nombre) { return nombre.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase(); }
    function filtrarDestinatariosEnvio() { renderizarDestinatariosEnvio(); }

    function selectMethod(m) {
      envio.metodo = m;
      document.querySelectorAll('.method-card').forEach(el => el.classList.toggle('active', el.dataset.method === m));
    }

    function selectDestinatario(id) {
      envio.destinatario = destinatarios.find(d => d.id === id);
      renderizarDestinatariosEnvio();
    }

    function agregarNuevoDestinatario() {
      sessionStorage.setItem('selectRecipientReturn', 'enviar.html');
      window.location.href = 'destinatario-form.html';
    }

    function updateProgressUI() {
      const steps = document.querySelectorAll('.progress .step');
      steps.forEach((s, idx) => {
        s.classList.remove('active','done');
        if (idx + 1 < currentStep) s.classList.add('done');
        if (idx + 1 === currentStep) s.classList.add('active');
      });
    }

    function showStep(step) {
      ['step1','step2','step3','step4','step5','step6'].forEach(id => document.getElementById(id).style.display = 'none');
      document.getElementById(`step${step}`).style.display = 'block';
      currentStep = step;
      updateProgressUI();
      updateFooter();
      if (step === 5) prepararDatosPago();
    }

    function updateFooter() {
      const btn = document.getElementById('btnNext');
      if (currentStep === 6) {
        document.getElementById('footer').innerHTML = `<div style="display:grid; gap:10px;"><button class='btn-secondary' onclick="window.location.href='home.html'">Ir al inicio</button><button class='btn-primary' onclick="verHistorial()">Ver historial</button></div>`;
        return;
      }
      document.getElementById('footer').innerHTML = `<button class='btn-primary' id='btnNext' onclick='nextStep()'>${currentStep === 5 ? 'Ya realic√© el pago' : currentStep === 4 ? 'Confirmar env√≠o' : 'Continuar'}</button>`;
    }

    function nextStep() {
      if (currentStep === 1) {
        if (!envio.montoCLP || envio.montoCLP < 1000) { alert('El monto m√≠nimo es $1.000 CLP'); return; }
      }
      if (currentStep === 3 && !envio.destinatario) { alert('Selecciona un destinatario'); return; }
      if (currentStep === 3) prepararResumen();
      if (currentStep === 4) { document.getElementById('complianceModal').style.display = 'flex'; return; }
      if (currentStep === 5) { crearSolicitud(); return; }
      if (currentStep < 6) showStep(currentStep + 1);
    }

    function prepararResumen() {
      const tasaActual = obtenerTasaPorMonto(envio.montoCLP);
      const envia = envio.montoCLP || 0;
      document.getElementById('resumenEnvias').textContent = `$${fmtCLP.format(envia)} CLP`;
      document.getElementById('resumenDestinatario').textContent = envio.destinatario?.alias || envio.destinatario?.nombre_completo || '-';
      document.getElementById('resumenMetodo').textContent = envio.metodo === 'pago_movil' ? 'Pago M√≥vil' : 'Transferencia';
      document.getElementById('resumenBanco').textContent = envio.destinatario?.banco || '-';
      document.getElementById('resumenTasa').textContent = `1 CLP = ${tasaActual.toFixed(4)} VES`;
      const recibe = envio.montoVES || 0;
      document.getElementById('resumenRecibe').textContent = `Bs. ${fmtVES.format(recibe)}`;
    }

    function confirmarCuentaPropia() {
      document.getElementById('complianceModal').style.display = 'none';
      showStep(5);
    }
    function mostrarNoEsMiCuenta() {
      document.getElementById('noEsMiCuentaSection').style.display = 'block';
    }
    function volverVerificacion() { document.getElementById('noEsMiCuentaSection').style.display = 'none'; }
    function cancelarPorCuenta() {
      const motivo = document.getElementById('motivoNoCuenta').value;
      const detalle = document.getElementById('detalleNoCuenta').value;
      console.log('Operaci√≥n cancelada - Motivo:', motivo, 'Detalle:', detalle);
      alert('Tu operaci√≥n ha sido cancelada. Si necesitas ayuda, cont√°ctanos en Soporte.');
      document.getElementById('complianceModal').style.display = 'none';
      window.location.href = 'home.html';
    }

    function prepararDatosPago() {
      document.getElementById('paymentMonto').textContent = `$${fmtCLP.format(envio.montoCLP || 0)} CLP`;
      startTimer();
    }

    function startTimer() {
      let minutes = 30, seconds = 0;
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (seconds === 0) {
          if (minutes === 0) {
            clearInterval(timerInterval);
            alert('El tiempo ha expirado. Por favor, inicia una nueva solicitud.');
            window.location.href = 'home.html';
            return;
          }
          minutes--; seconds = 59;
        } else { seconds--; }
        document.getElementById('timerValue').textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
      }, 1000);
    }

    function copiar(id) {
      const txt = document.getElementById(id).textContent;
      navigator.clipboard.writeText(txt).then(() => {
        const btn = event.target;
        const prev = btn.textContent;
        btn.textContent = '‚úì Copiado';
        setTimeout(() => btn.textContent = prev, 1600);
      });
    }

    async function crearSolicitud() {
      if (timerInterval) clearInterval(timerInterval);
      const token = localStorage.getItem('clienteToken');
      const solicitud = {
        monto_clp: envio.montoCLP,
        monto_ves: envio.montoVES,
        metodo_entrega: envio.metodo,
        beneficiario_id: envio.destinatario?.id,
        tasa: tasa
      };
      try {
        const r = await fetch(`${API_BASE}/api/cliente/solicitudes`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(solicitud)
        });
        if (r.ok) {
          const data = await r.json();
          mostrarTracking(data);
        } else { mostrarTrackingDemo(); }
      } catch { mostrarTrackingDemo(); }
    }

    function mostrarTracking(data) {
      document.getElementById('trackingCode').textContent = data.codigo || 'TRX-' + Date.now();
      document.getElementById('timeCreated').textContent = new Date().toLocaleString('es-CL');
      showStep(6);
    }
    function mostrarTrackingDemo() {
      document.getElementById('trackingCode').textContent = 'TRX-' + Math.random().toString(36).substr(2, 8).toUpperCase();
      document.getElementById('timeCreated').textContent = new Date().toLocaleString('es-CL');
      showStep(6);
    }

    function verHistorial() { window.location.href = 'historico.html'; }
  </script>
</body>
</html>
