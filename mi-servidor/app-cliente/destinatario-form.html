<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1974CE">
    <title>Destinatario - Defi Oracle</title>

    <script>
        (function() {
            const stored = localStorage.getItem('apiBaseUrlOverride');
            const isLocal = ['localhost', '127.0.0.1', '::1'].includes(location.hostname) || location.protocol === 'file:';
            if (isLocal) {
                window.API_BASE_URL = location.origin || 'http://localhost:3000';
                localStorage.setItem('apiBaseUrlOverride', window.API_BASE_URL);
                return;
            }
            if (stored) {
                window.API_BASE_URL = stored;
                return;
            }
            window.API_BASE_URL = window.API_BASE_URL || 'https://defisistema-interno.onrender.com';
        })();
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-blue: #1974CE;
            --accent-green: #23C6B8;
            --dark-slate: #121826;
            --neutral-gray: #7C8899;
            --muted: #A3ACB9;
            --panel: #FFFFFF;
            --danger: #EF4444;

            --grad-surface: linear-gradient(135deg, rgba(25, 116, 206, 0.12), rgba(35, 198, 184, 0.10));
            --grad-button: linear-gradient(120deg, #1974CE 0%, #23C6B8 100%);

            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --radius-xl: 22px;
            --radius-full: 999px;

            --shadow-card: 0 16px 38px rgba(13, 54, 112, 0.16);
            --shadow-subtle: 0 6px 16px rgba(17, 38, 78, 0.10);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--grad-surface);
            color: var(--dark-slate);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        button, input, select { font-family: inherit; }

        .app-container {
            max-width: 520px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }

        .page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 32px 26px 240px;
            gap: 20px;
        }

        @media (max-width: 420px) {
            .page { padding: 26px 16px 240px; }
        }

        .page-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(255, 255, 255, 0.94);
            border-radius: var(--radius-xl);
            border: 1px solid rgba(255, 255, 255, 0.65);
            box-shadow: var(--shadow-card);
            padding: 24px 24px 10px;
            backdrop-filter: blur(18px);
        }

        @media (max-width: 420px) {
            .page-content { padding: 22px 16px 12px; }
        }

        .form-header { display: flex; align-items: flex-start; gap: 14px; }

        .btn-back {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            border: 1px solid rgba(25, 116, 206, 0.20);
            background: rgba(25, 116, 206, 0.08);
            color: var(--primary-blue);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-back svg { width: 20px; height: 20px; stroke-width: 2.2; }
        .btn-back:hover { box-shadow: 0 12px 24px rgba(25, 116, 206, 0.22); transform: translateY(-1px); }

        .form-header-copy { display: flex; flex-direction: column; gap: 6px; }
        .form-header-eyebrow { font-size: 12px; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; color: var(--neutral-gray); }
        .form-header-title { font-size: 24px; font-weight: 800; letter-spacing: -0.2px; }
        .form-header-subtitle { font-size: 14px; color: var(--muted); max-width: 340px; }

        .status-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 16px;
            border: 1px solid rgba(25, 116, 206, 0.14);
            background: rgba(25, 116, 206, 0.08);
            color: var(--dark-slate);
        }
        .status-banner.danger { border-color: rgba(239, 68, 68, 0.35); background: rgba(239, 68, 68, 0.08); color: #991B1B; }
        .status-banner.success { border-color: rgba(35, 198, 184, 0.30); background: rgba(35, 198, 184, 0.10); color: #0f766e; }

        .form-body { display: flex; flex-direction: column; gap: 18px; }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.96);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(25, 116, 206, 0.12);
            box-shadow: var(--shadow-subtle);
        }
        .form-section-title { font-size: 12px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; color: var(--neutral-gray); }

        .input-group { display: flex; flex-direction: column; gap: 6px; }
        .input-label { font-size: 14px; font-weight: 700; color: rgba(33, 28, 16, 0.78); }
        .input, .select-wrapper select {
            width: 100%;
            border: 1px solid rgba(25, 116, 206, 0.16);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.96);
            padding: 14px 16px;
            font-size: 15px;
            color: var(--dark-slate);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input::placeholder, .select-wrapper select option:first-child { color: var(--neutral-gray); }
        .input:focus, .select-wrapper select:focus {
            outline: none;
            border-color: rgba(25, 116, 206, 0.45);
            box-shadow: 0 0 0 3px rgba(25, 116, 206, 0.16);
        }

        .radio-group { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; }
        .radio-option input { display: none; }
        .radio-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            border-radius: var(--radius-md);
            border: 1px solid rgba(25, 116, 206, 0.16);
            background: rgba(25, 116, 206, 0.08);
            font-weight: 700;
            color: var(--primary-blue);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .radio-option input:checked + label {
            background: linear-gradient(135deg, var(--primary-blue), var(--accent-green));
            border-color: transparent;
            color: #FFFFFF;
            box-shadow: 0 8px 18px rgba(25, 116, 206, 0.24);
        }

        .select-wrapper { position: relative; }
        .select-wrapper select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 40px;
        }
        .select-wrapper::after {
            content: "";
            position: absolute;
            right: 16px;
            top: 50%;
            width: 10px;
            height: 10px;
            border-right: 2px solid var(--neutral-gray);
            border-bottom: 2px solid var(--neutral-gray);
            transform: translateY(-50%) rotate(45deg);
            pointer-events: none;
        }

        .phone-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
        }

        .input-hint { font-size: 12px; color: var(--muted); }
        .input-error { font-size: 12px; color: var(--danger); }

        .form-note {
            font-size: 12px;
            color: var(--muted);
            background: rgba(25, 116, 206, 0.06);
            border: 1px solid rgba(25, 116, 206, 0.12);
            border-radius: 12px;
            padding: 12px;
        }

        .form-footer {
            position: fixed;
            bottom: clamp(16px, env(safe-area-inset-bottom, 0) + 18px, 32px);
            left: 0;
            right: 0;
            margin: 0 auto;
            width: calc(100% - 48px);
            max-width: 520px;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid rgba(255, 255, 255, 0.65);
            border-radius: 22px;
            box-shadow: 0 18px 38px rgba(20, 52, 102, 0.14);
            padding: 12px;
            backdrop-filter: blur(18px);
            z-index: 120;
        }
        @media (max-width: 420px) {
            .form-footer { width: calc(100% - 32px); }
        }
        .btn {
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 52px;
            flex: 1;
        }
        .btn-primary {
            border-radius: 16px;
            background: var(--grad-button);
            color: #FFFFFF;
            box-shadow: 0 18px 36px rgba(25, 116, 206, 0.24);
            font-size: 16px;
        }
        .btn-primary:disabled { opacity: 0.65; cursor: not-allowed; }
        .btn-secondary {
            border-radius: 16px;
            background: rgba(25, 116, 206, 0.08);
            color: var(--primary-blue);
            border: 1px solid rgba(25, 116, 206, 0.18);
        }
        .btn-delete {
            border-radius: 16px;
            background: linear-gradient(120deg, rgba(239, 68, 68, 0.90), rgba(220, 38, 38, 0.92));
            color: #FFFFFF;
            box-shadow: 0 18px 30px rgba(239, 68, 68, 0.22);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="page">
            <div class="page-content">
                <header class="form-header">
                    <button class="btn-back" onclick="volver()" aria-label="Volver a la lista">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <div class="form-header-copy">
                        <p class="form-header-eyebrow">Gestión rápida</p>
                        <h1 class="form-header-title" id="pageTitle">Agregar destinatario</h1>
                        <p class="form-header-subtitle" id="formSubtitle">Guarda los datos bancarios para enviar en segundos.</p>
                    </div>
                </header>

                <div id="statusBanner" class="status-banner" hidden></div>

                <main class="form-body">
                    <section class="form-section">
                        <h2 class="form-section-title">Datos personales</h2>

                        <div class="input-group">
                            <label class="input-label">Nombres *</label>
                            <input type="text" class="input" id="nombres" placeholder="Ej: María Elena" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Apellidos *</label>
                            <input type="text" class="input" id="apellidos" placeholder="Ej: García López" required>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Alias (opcional)</label>
                            <input type="text" class="input" id="alias" placeholder="Ej: Mamá, Hermano, etc.">
                            <p class="input-hint">Lo usaremos para mostrarlo en la lista y en los atajos de envío.</p>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Tipo de documento *</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" name="tipoDoc" id="docV" value="V" checked>
                                    <label for="docV">V</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" name="tipoDoc" id="docE" value="E">
                                    <label for="docE">E</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" name="tipoDoc" id="docJ" value="J">
                                    <label for="docJ">J</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" name="tipoDoc" id="docP" value="P">
                                    <label for="docP">P</label>
                                </div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Número de documento *</label>
                            <input type="text" class="input" id="numeroDoc" placeholder="Ej: 12345678" inputmode="text" autocomplete="off">
                        </div>
                    </section>

                    <section class="form-section">
                        <h2 class="form-section-title">Datos bancarios</h2>

                        <div class="input-group">
                            <label class="input-label">Banco</label>
                            <div class="select-wrapper">
                                <select id="banco">
                                    <option value="">Seleccionar banco</option>
                                    <option value="0102">Banco de Venezuela</option>
                                    <option value="0104">Venezolano de Crédito</option>
                                    <option value="0105">Mercantil</option>
                                    <option value="0108">Provincial</option>
                                    <option value="0114">Bancaribe</option>
                                    <option value="0115">Exterior</option>
                                    <option value="0128">Caroní</option>
                                    <option value="0134">Banesco</option>
                                    <option value="0137">Sofitasa</option>
                                    <option value="0138">Banco Plaza</option>
                                    <option value="0151">BFC</option>
                                    <option value="0156">100% Banco</option>
                                    <option value="0157">Del Sur</option>
                                    <option value="0163">Banco del Tesoro</option>
                                    <option value="0166">Agrícola de Venezuela</option>
                                    <option value="0168">Bancrecer</option>
                                    <option value="0169">Mi Banco</option>
                                    <option value="0171">Activo</option>
                                    <option value="0172">Bancamiga</option>
                                    <option value="0173">Internacional de Desarrollo</option>
                                    <option value="0174">Banplus</option>
                                    <option value="0175">Bicentenario</option>
                                    <option value="0177">Banfanb</option>
                                    <option value="0191">BNC</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Número de cuenta</label>
                            <input type="text" class="input" id="numeroCuenta" placeholder="20 dígitos" maxlength="20" inputmode="numeric" autocomplete="off">
                            <p class="input-hint">Solo números, sin espacios ni guiones.</p>
                        </div>
                    </section>

                    <section class="form-section">
                        <h2 class="form-section-title">Pago móvil (opcional)</h2>
                        <div class="input-group">
                            <label class="input-label">Teléfono</label>
                            <div class="phone-row">
                                <div class="select-wrapper">
                                    <select id="telefonoPrefijo">
                                        <option value="0414">+58 414</option>
                                        <option value="0412">+58 412</option>
                                        <option value="0424">+58 424</option>
                                        <option value="0416">+58 416</option>
                                        <option value="0422">+58 422</option>
                                        <option value="0426">+58 426</option>
                                    </select>
                                </div>
                                <input type="text" class="input" id="telefonoNumero" placeholder="7 dígitos" maxlength="7" inputmode="tel">
                            </div>
                            <p class="input-hint">Incluimos el prefijo +58 y la operadora automáticamente.</p>
                        </div>
                    </section>

                    <section class="form-section">
                        <h2 class="form-section-title">Contacto (opcional)</h2>
                        <div class="input-group">
                            <label class="input-label">Email</label>
                            <input type="email" class="input" id="email" placeholder="correo@ejemplo.com">
                        </div>
                    </section>

                    <p class="form-note">Debes agregar al menos los datos bancarios o el número de pago móvil para guardar el destinatario.</p>
                </main>
            </div>

            <footer class="form-footer" id="formFooter">
                <button class="btn btn-secondary" onclick="volver()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarDestinatario()">Guardar</button>
            </footer>
        </div>
    </div>

    <script>
        const API_BASE = (window.API_BASE_URL || '').replace(/\/$/, '');
        let editando = false;
        let destinatarioId = null;
        let guardando = false;

        document.addEventListener('DOMContentLoaded', () => {
            inicializar();
        });

        async function inicializar() {
            bindInputs();
            await protegerRuta();
            checkEditMode();
        }

        function bindInputs() {
            document.querySelectorAll('input[name="tipoDoc"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const numero = document.getElementById('numeroDoc');
                    if (!numero) return;
                    if (['V', 'E', 'J'].includes(radio.value)) {
                        numero.value = numero.value.replace(/[^0-9]/g, '');
                    }
                });
            });

            const numeroDoc = document.getElementById('numeroDoc');
            if (numeroDoc) {
                numeroDoc.addEventListener('input', e => {
                    const tipo = (document.querySelector('input[name="tipoDoc"]:checked')?.value || 'V');
                    e.target.value = tipo === 'P'
                        ? e.target.value.replace(/[^0-9A-Za-z]/g, '').toUpperCase()
                        : e.target.value.replace(/[^0-9]/g, '');
                });
            }

            const numeroCuenta = document.getElementById('numeroCuenta');
            if (numeroCuenta) {
                numeroCuenta.addEventListener('input', e => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 20);
                });
            }

            const telefonoNumero = document.getElementById('telefonoNumero');
            if (telefonoNumero) {
                telefonoNumero.addEventListener('input', e => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 7);
                });
            }
        }

        function mostrarBanner(mensaje, tono = 'info') {
            let banner = document.getElementById('statusBanner');
            if (!banner) {
                const header = document.querySelector('.form-header');
                banner = document.createElement('div');
                banner.id = 'statusBanner';
                banner.className = 'status-banner';
                banner.hidden = true;
                if (header && header.parentNode) {
                    header.parentNode.insertBefore(banner, header.nextSibling);
                } else {
                    document.body.prepend(banner);
                }
            }

            if (!mensaje) {
                banner.hidden = true;
                banner.textContent = '';
                banner.className = 'status-banner';
                return;
            }

            banner.className = 'status-banner';
            if (tono === 'danger') banner.classList.add('danger');
            if (tono === 'success') banner.classList.add('success');
            banner.textContent = mensaje;
            banner.hidden = false;
        }

        async function protegerRuta() {
            const token = localStorage.getItem('clienteToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const resp = await fetch(`${API_BASE}/api/cliente/auth/verificar`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (resp.ok) {
                    const data = await resp.json().catch(() => null);
                    if (data?.usuario) localStorage.setItem('clienteData', JSON.stringify(data.usuario));
                } else {
                    localStorage.removeItem('clienteToken');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error verificando sesión', error);
                mostrarBanner('No pudimos validar tu sesión. Revisa tu conexión.', 'danger');
            }
        }

        function checkEditMode() {
            const params = new URLSearchParams(window.location.search);
            destinatarioId = params.get('id');

            if (destinatarioId) {
                editando = true;
                document.getElementById('pageTitle').textContent = 'Editar destinatario';
                const subtitle = document.getElementById('formSubtitle');
                if (subtitle) subtitle.textContent = 'Actualiza o elimina los datos cuando lo necesites.';

                const footer = document.getElementById('formFooter');
                footer.innerHTML = `
                    <button class="btn btn-delete" onclick="eliminarDestinatario()">Eliminar</button>
                    <button class="btn btn-primary" onclick="guardarDestinatario()">Guardar</button>
                `;

                cargarDestinatario(destinatarioId);
            }
        }

        async function cargarDestinatario(id) {
            const token = localStorage.getItem('clienteToken');
            try {
                const response = await fetch(`${API_BASE}/api/cliente/beneficiarios/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.status === 401) {
                    localStorage.removeItem('clienteToken');
                    window.location.href = 'login.html';
                    return;
                }
                if (!response.ok) {
                    manejarErrorCarga();
                    return;
                }
                const data = await response.json();
                llenarFormulario(data.payload || data);
            } catch (err) {
                console.error('Error al cargar destinatario', err);
                manejarErrorCarga();
            }
        }

        function manejarErrorCarga() {
            mostrarBanner('No pudimos cargar el destinatario. Intenta de nuevo.', 'danger');
            setTimeout(() => window.location.href = 'destinatarios.html', 1400);
        }

        function normalizarPrefijo(prefijo) {
            const permitidos = ['0412', '0414', '0424', '0416', '0422', '0426'];
            let limpio = (prefijo || '').toString().replace(/[^0-9]/g, '');
            if (limpio.length === 3) limpio = `0${limpio}`;
            if (!permitidos.includes(limpio)) limpio = '0414';
            return limpio;
        }

        function asignarTelefono(telefonoRaw) {
            const prefijoEl = document.getElementById('telefonoPrefijo');
            const numeroEl = document.getElementById('telefonoNumero');
            if (!prefijoEl || !numeroEl) return;

            const soloDigitos = (telefonoRaw || '').toString().replace(/[^0-9]/g, '');
            let sin58 = soloDigitos.startsWith('58') ? soloDigitos.slice(2) : soloDigitos;

            if (sin58 && !sin58.startsWith('0') && sin58.length >= 10) {
                sin58 = `0${sin58}`;
            }

            let prefijo = prefijoEl.value || '0414';
            let numero = '';

            if (sin58.length === 7) {
                numero = sin58;
            } else if (sin58.length >= 10) {
                prefijo = sin58.slice(0, 4);
                numero = sin58.slice(4, 11);
            }

            prefijoEl.value = normalizarPrefijo(prefijo);
            numeroEl.value = numero ? numero.slice(0, 7) : '';
        }

        function llenarFormulario(data) {
            const nombreCompleto = (data.nombre_completo || '').trim();
            const partes = nombreCompleto.split(/\s+/);
            const nombres = data.nombres || partes.shift() || '';
            const apellidos = data.apellidos || partes.join(' ');

            document.getElementById('nombres').value = nombres;
            document.getElementById('apellidos').value = apellidos;
            document.getElementById('alias').value = data.alias || '';
            document.getElementById('numeroDoc').value = (data.numero_documento || data.documento_numero || '').toString();
            document.getElementById('banco').value = data.banco || '';
            document.getElementById('numeroCuenta').value = data.numero_cuenta || '';
            document.getElementById('email').value = data.email || '';
            const fav = document.getElementById('isFavorite');
            if (fav) fav.checked = data.isFavorite === 1 || data.isFavorite === true;

            const docMap = { cedula: 'V', rut: 'J', pasaporte: 'P', dni: 'V', e: 'E', v: 'V', j: 'J', p: 'P' };
            const rawTipo = (data.tipo_documento || data.documento_tipo || '').toLowerCase();
            const docCode = docMap[rawTipo] || docMap[rawTipo?.[0]] || 'V';
            const radio = document.getElementById(`doc${docCode}`);
            if (radio) radio.checked = true;

            asignarTelefono(data.telefono || '');
        }

        function validarFormulario() {
            const nombres = document.getElementById("nombres").value.trim();
            const apellidos = document.getElementById("apellidos").value.trim();
            const numeroDocRaw = document.getElementById("numeroDoc").value.trim();
            const bancoSelect = document.getElementById("banco");
            const bancoValor = bancoSelect.value;
            const bancoNombre = bancoSelect.options[bancoSelect.selectedIndex]?.text?.trim();
            const numeroCuenta = document.getElementById("numeroCuenta").value.replace(/[^0-9]/g, "");
            const prefijo = document.getElementById("telefonoPrefijo")?.value || "0414";
            const telefonoNumero = document.getElementById("telefonoNumero")?.value.replace(/[^0-9]/g, "") || "";
            const email = document.getElementById("email").value.trim();
            const tipoDocForm = document.querySelector('input[name="tipoDoc"]:checked')?.value || "V";

            // Validar campos personales obligatorios
            if (!nombres || !apellidos || !numeroDocRaw) {
                return { valido: false, mensaje: "Completa todos los campos obligatorios." };
            }

            // Verificar que al menos tenga pago móvil o datos bancarios
            const tienePagoMovil = telefonoNumero.length === 7;
            const tieneDatosBancarios = bancoValor && numeroCuenta;

            if (!tienePagoMovil && !tieneDatosBancarios) {
                return { valido: false, mensaje: "Debes agregar al menos los datos bancarios o el número de pago móvil." };
            }

            // Si tiene datos bancarios, validar que estén completos
            if (tieneDatosBancarios) {
                if (!bancoValor) {
                    return { valido: false, mensaje: "Selecciona un banco." };
                }
                if (numeroCuenta.length !== 20) {
                    return { valido: false, mensaje: "El numero de cuenta debe tener 20 digitos." };
                }
            }

            if (["V", "E", "J"].includes(tipoDocForm) && !/^[0-9]{6,15}$/.test(numeroDocRaw)) {
                return { valido: false, mensaje: "El documento debe tener entre 6 y 15 digitos." };
            }

            if (tipoDocForm === "P" && numeroDocRaw.length < 5) {
                return { valido: false, mensaje: "El numero de pasaporte es demasiado corto." };
            }

            const prefijoNormalizado = normalizarPrefijo(prefijo);
            const tieneTelefono = telefonoNumero.length > 0;
            if (tieneTelefono && telefonoNumero.length !== 7) {
                return { valido: false, mensaje: "Ingresa los 7 digitos del movil." };
            }
            const telefonoCompleto = tieneTelefono ? `+58${prefijoNormalizado}${telefonoNumero}` : null;

            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return { valido: false, mensaje: "Ingresa un correo valido." };
            }

            const tipoDocMap = { V: "cedula", E: "cedula", J: "rut", P: "pasaporte" };
            const nombreCompleto = `${nombres} ${apellidos}`.replace(/\s+/g, " ").trim();
            const alias = document.getElementById("alias").value.trim() || nombreCompleto;
            const isFavoriteEl = document.getElementById("isFavorite");
            const isFavorite = !!(isFavoriteEl && isFavoriteEl.checked);

            const data = {
                alias,
                nombre_completo: nombreCompleto,
                documento_tipo: tipoDocMap[tipoDocForm] || "cedula",
                documento_numero: numeroDocRaw.replace(/\s+/g, ""),
                banco: bancoNombre || null,
                tipo_cuenta: tieneDatosBancarios ? "corriente" : null,
                numero_cuenta: numeroCuenta || null,
                pais: "Venezuela",
                telefono: telefonoCompleto,
                email: email || null,
                isFavorite
            };

            return { valido: true, data };
        }

        function toggleGuardando(isLoading) {
            guardando = isLoading;
            const buttons = document.querySelectorAll('.form-footer .btn');
            buttons.forEach(btn => btn.disabled = isLoading);
        }

        async function guardarDestinatario() {
            if (guardando) return;
            const validacion = validarFormulario();
            if (!validacion.valido) {
                mostrarBanner(validacion.mensaje, 'danger');
                return;
            }

            toggleGuardando(true);
            mostrarBanner('');

            const token = localStorage.getItem('clienteToken');
            const url = editando
                ? `${API_BASE}/api/cliente/beneficiarios/${destinatarioId}`
                : `${API_BASE}/api/cliente/beneficiarios`;
            const method = editando ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(validacion.data)
                });

                if (response.status === 401) {
                    localStorage.removeItem('clienteToken');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.ok) {
                    mostrarBanner(editando ? 'Destinatario actualizado' : 'Destinatario agregado', 'success');
                    setTimeout(() => window.location.href = 'destinatarios.html', 600);
                } else {
                    const error = await response.json().catch(() => ({}));
                    mostrarBanner(error.error || 'No pudimos guardar. Intenta nuevamente.', 'danger');
                }
            } catch (error) {
                console.error('Error al guardar destinatario', error);
                mostrarBanner('Error de conexión. Intenta nuevamente.', 'danger');
            } finally {
                toggleGuardando(false);
            }
        }

        async function eliminarDestinatario() {
            if (!destinatarioId) return;
            const confirmado = confirm('¿Estás seguro de eliminar este destinatario?');
            if (!confirmado) return;

            const token = localStorage.getItem('clienteToken');
            toggleGuardando(true);
            try {
                const response = await fetch(`${API_BASE}/api/cliente/beneficiarios/${destinatarioId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    localStorage.removeItem('clienteToken');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.ok) {
                    window.location.href = 'destinatarios.html';
                } else {
                    mostrarBanner('No pudimos eliminar el destinatario.', 'danger');
                }
            } catch (error) {
                console.error('Error eliminando destinatario', error);
                mostrarBanner('Error de conexión al eliminar.', 'danger');
            } finally {
                toggleGuardando(false);
            }
        }

        function volver() {
            const returnTo = sessionStorage.getItem('selectRecipientReturn');
            if (returnTo) {
                window.location.href = returnTo;
                return;
            }
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'destinatarios.html';
            }
        }
    </script>
</body>
</html>






