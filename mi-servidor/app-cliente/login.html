<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="theme-color" content="#1974CE">
	<title>Ingresar - Defi Oracle</title>
	<script>
		window.API_BASE_URL = window.API_BASE_URL || '';
		window.GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || 'TU_CLIENT_ID_DE_GOOGLE';
	</script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #1974CE;
			--primary-2: #2FC7B8;
			--bg: #E3EAEE;
			--card: #FFFFFF;
			--text: #1F2933;
			--muted: #6B7280;
			--error: #DC2626;
			--shadow: 0 18px 40px rgba(25, 116, 206, 0.18);
			--radius: 18px;
			--font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
		}

		* { box-sizing: border-box; margin: 0; padding: 0; }

		body {
			font-family: var(--font);
			background: linear-gradient(135deg, rgba(25,116,206,0.10), rgba(47,199,184,0.10));
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 32px 16px;
			color: var(--text);
		}

		.shell {
			width: 100%;
			max-width: 440px;
			background: var(--card);
			border-radius: var(--radius);
			padding: 28px 26px;
			box-shadow: var(--shadow);
			border: 1px solid rgba(25, 116, 206, 0.10);
		}

		.brand {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 12px;
		}

		.brand img { height: 44px; width: auto; }

		.eyebrow { color: var(--muted); font-size: 13px; letter-spacing: 0.3px; text-transform: uppercase; }

		h1 { font-size: 28px; margin: 6px 0 4px; }

		p.sub { color: var(--muted); margin-bottom: 24px; }

		.card {
			background: #F9FBFD;
			border: 1px solid rgba(25, 116, 206, 0.12);
			border-radius: 14px;
			padding: 18px;
			margin-bottom: 18px;
		}

		.status { color: var(--muted); font-size: 14px; display: flex; align-items: center; gap: 8px; }
		.status strong { color: var(--text); }

		#googleButton { display: flex; justify-content: center; margin: 12px 0 6px; }

		.btn-secondary {
			width: 100%;
			padding: 14px;
			border-radius: 12px;
			border: 1px dashed rgba(25, 116, 206, 0.4);
			background: transparent;
			color: var(--primary);
			font-weight: 600;
			cursor: pointer;
			margin-top: 6px;
		}

		.hint { font-size: 13px; color: var(--muted); text-align: center; margin-top: 8px; }

		.alert { background: #FEF2F2; color: var(--error); border: 1px solid #FECACA; padding: 12px; border-radius: 12px; margin-top: 10px; font-size: 14px; }
		.alert small { display: block; color: #991B1B; }

		.loader { display: none; margin-top: 8px; font-size: 14px; color: var(--muted); }
		.loader.active { display: block; }

		.footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 12px; }
		.divider { height: 1px; background: rgba(31,41,51,0.08); margin: 14px 0; }
	</style>
</head>
<body>
	<div class="shell">
		<div class="brand">
			<img src="assets/defioracle-logo.png" alt="Defi Oracle">
			<div>
				<div class="eyebrow">Acceso seguro</div>
				<h1>Bienvenido</h1>
			</div>
		</div>
		<p class="sub">Ingresa con tu cuenta de Google para crear o continuar tu perfil.</p>

		<div class="card">
			<div class="status">✓ Autenticación con Google</div>
			<div id="googleButton"></div>
			<div id="manualFallback" class="hint" style="display: none;">Define window.GOOGLE_CLIENT_ID en el entorno para habilitar el botón.</div>
			<div id="loader" class="loader">Procesando...</div>
			<div id="errorBox" class="alert" style="display: none;"></div>
		</div>

		<button class="btn-secondary" id="registroLink">¿No tienes cuenta? Completa tu registro</button>
		<div class="divider"></div>
		<div class="footer">© 2024 Defi Oracle. Autenticación protegida.</div>
	</div>

	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<script>
		const API_BASE = window.API_BASE_URL || '';
		const GOOGLE_CLIENT_ID = window.GOOGLE_CLIENT_ID || '';
		const googleButton = document.getElementById('googleButton');
		const errorBox = document.getElementById('errorBox');
		const loader = document.getElementById('loader');

		const registroLink = document.getElementById('registroLink');
		registroLink.addEventListener('click', () => window.location.href = 'registro.html');

		document.addEventListener('DOMContentLoaded', () => {
			verificarSesionActiva();
			inicializarGoogle();
		});

		function showError(msg) {
			errorBox.textContent = msg;
			errorBox.style.display = 'block';
		}

		function hideError() {
			errorBox.textContent = '';
			errorBox.style.display = 'none';
		}

		async function verificarSesionActiva() {
			const token = localStorage.getItem('clienteToken');
			if (!token) return;
			try {
				const resp = await fetch(`${API_BASE}/api/cliente/auth/verificar`, {
					headers: { 'Authorization': `Bearer ${token}` }
				});
				if (resp.ok) {
					const data = await resp.json();
					localStorage.setItem('clienteData', JSON.stringify(data.usuario));
					const destino = data.registroCompleto ? 'home.html' : 'registro.html';
					window.location.href = destino;
				} else {
					localStorage.removeItem('clienteToken');
					localStorage.removeItem('clienteData');
				}
			} catch (err) {
				console.warn('No se pudo verificar la sesión:', err);
			}
		}

		function inicializarGoogle() {
			if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes('TU_CLIENT_ID')) {
				document.getElementById('manualFallback').style.display = 'block';
				return;
			}

			if (typeof google === 'undefined' || !google.accounts || !google.accounts.id) {
				showError('No pudimos cargar Google Sign-In. Revisa tu conexión e inténtalo de nuevo.');
				return;
			}

			google.accounts.id.initialize({
				client_id: GOOGLE_CLIENT_ID,
				callback: handleCredentialResponse,
				cancel_on_tap_outside: false
			});

			google.accounts.id.renderButton(googleButton, {
				theme: 'outline',
				size: 'large',
				shape: 'pill',
				width: 320
			});
		}

		async function handleCredentialResponse(response) {
			hideError();
			loader.classList.add('active');
			try {
				const resp = await fetch(`${API_BASE}/api/cliente/auth/google`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ credential: response.credential })
				});

				const data = await resp.json();
				if (!resp.ok) {
					throw new Error(data.error || 'No se pudo iniciar sesión');
				}

				localStorage.setItem('clienteToken', data.token);
				localStorage.setItem('clienteData', JSON.stringify(data.usuario));
				const destino = (!data.usuario.registroCompleto || data.nuevoUsuario) ? 'registro.html' : 'home.html';
				window.location.href = destino;
			} catch (err) {
				showError(err.message || 'Ocurrió un error al autenticar');
			} finally {
				loader.classList.remove('active');
			}
		}
	</script>
</body>
</html>
